<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyJourneyAI | Mistral-Engine Narrative Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Playfair+Display:ital,wght@0,700;1,700&family=Inter:wght@300;400;600&display=swap');

        :root {
            --neon-blue: #00f3ff;
            --neon-pink: #ff00ff;
            --cyber-bg: #050505;
        }

        body {
            background-color: var(--cyber-bg);
            color: #e0e0e0;
            font-family: 'Inter', sans-serif;
            background-image: radial-gradient(circle at 50% 50%, #111 0%, #050505 100%);
        }

        .glitch-text {
            text-shadow: 2px 0 var(--neon-pink), -2px 0 var(--neon-blue);
            font-family: 'Orbitron', sans-serif;
        }

        .cyber-panel {
            border: 1px solid rgba(0, 243, 253, 0.2);
            background: rgba(10, 10, 10, 0.7);
            backdrop-filter: blur(12px);
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
        }

        .chapter-card {
            border-left: 2px solid var(--neon-blue);
            position: relative;
        }

        .chapter-text {
            line-height: 1.8;
            font-size: 1.05rem;
            text-align: justify;
        }

        .chapter-text::first-letter {
            float: left;
            font-family: 'Playfair Display', serif;
            font-size: 5rem;
            line-height: 0.85;
            padding-right: 0.75rem;
            padding-top: 0.5rem;
            color: var(--neon-blue);
            text-shadow: 0 0 10px rgba(0, 243, 255, 0.5);
        }

        .shimmer {
            background: linear-gradient(90deg, #111 25%, #222 50%, #111 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite linear;
        }

        @keyframes shimmer {
            100% {
                background-position: -200% 0;
            }
        }

        input[type="range"]::-webkit-slider-thumb {
            appearance: none;
            width: 20px;
            height: 20px;
            background: var(--neon-blue);
            cursor: pointer;
            box-shadow: 0 0 10px var(--neon-blue);
            border-radius: 50%;
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2300f3ff'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.5rem center;
            background-size: 1.2em;
        }

        .mistral-glow {
            text-shadow: 0 0 8px rgba(0, 243, 255, 0.3);
        }
    </style>
</head>

<body class="min-h-screen flex flex-col">

    <!-- Header Section -->
    <header class="p-4 border-b border-cyan-900/40 bg-black/80 sticky top-0 z-50 flex justify-between items-center">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 border-2 border-cyan-400 rounded-full flex items-center justify-center">
                <i data-lucide="brain-circuit" class="text-cyan-400 w-6 h-6"></i>
            </div>
            <h1 class="glitch-text text-xl font-bold tracking-tighter uppercase">MyJourneyAI <span
                    class="text-[10px] text-pink-500 font-mono">Mistral-v1</span></h1>
        </div>
        <div class="flex items-center gap-4">
            <button onclick="ui.toggleSavedDashboard()"
                class="text-xs font-bold text-pink-500 hover:text-pink-300 transition uppercase tracking-widest border border-pink-500/50 px-3 py-1 rounded">
                Archives
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow container mx-auto max-w-4xl p-4 md:p-8 space-y-12 pb-48">

        <!-- Error Bar -->
        <div id="geo-error-bar"
            class="hidden cyber-panel p-3 border-red-500/50 bg-red-950/20 text-red-400 text-xs flex items-center gap-2 rounded-lg">
            <i data-lucide="alert-triangle" class="w-4 h-4"></i>
            <span>GPS Link Severed: Use manual Intensity Slider to simulate traversal.</span>
        </div>

        <!-- Dashboard HUD -->
        <section class="grid grid-cols-3 gap-4">
            <div class="cyber-panel p-4 rounded-lg text-center relative overflow-hidden">
                <div class="absolute top-0 left-0 w-full h-1 bg-cyan-500/30"></div>
                <p class="text-[10px] text-cyan-400 font-bold uppercase tracking-widest mb-1">Velocity</p>
                <div class="flex items-baseline justify-center gap-1">
                    <span id="stat-speed" class="text-3xl font-bold font-mono">0.0</span>
                    <span class="text-xs text-gray-500 uppercase">MPH</span>
                </div>
            </div>
            <div class="cyber-panel p-4 rounded-lg text-center relative overflow-hidden">
                <div class="absolute top-0 left-0 w-full h-1 bg-pink-500/30"></div>
                <p class="text-[10px] text-pink-400 font-bold uppercase tracking-widest mb-1">Traversed</p>
                <div class="flex items-baseline justify-center gap-1">
                    <span id="stat-dist" class="text-3xl font-bold font-mono">0.00</span>
                    <span class="text-xs text-gray-500 uppercase">MI</span>
                </div>
            </div>
            <div class="cyber-panel p-4 rounded-lg text-center relative overflow-hidden">
                <div id="co2-accent" class="absolute top-0 left-0 w-full h-1 bg-green-500/30"></div>
                <p id="stat-co2-label" class="text-[10px] text-green-400 font-bold uppercase tracking-widest mb-1">CO2
                    Redux</p>
                <div class="flex items-baseline justify-center gap-1">
                    <span id="stat-co2" class="text-3xl font-bold font-mono">0</span>
                    <span class="text-xs text-gray-500 uppercase">G</span>
                </div>
            </div>
        </section>

        <!-- Configuration & Narrative View -->
        <section id="main-view" class="space-y-12">

            <!-- Setup Panel (THE START BUTTON IS HERE) -->
            <div id="setup-panel" class="cyber-panel rounded-xl p-8 space-y-6">
                <div class="text-center">
                    <i data-lucide="settings-2" class="w-12 h-12 text-cyan-500/50 mx-auto mb-4"></i>
                    <h3 class="text-xl font-bold mb-2 uppercase tracking-widest glitch-text">Expedition Config</h3>
                    <p class="text-xs text-gray-500 font-mono">Long-form Mistral Prose Engine Active</p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Genre Selection -->
                    <div class="space-y-2">
                        <label class="text-[10px] uppercase font-black text-gray-500 tracking-widest">Story
                            Genre</label>
                        <select id="config-genre"
                            class="w-full bg-black/50 border border-cyan-900/50 p-3 rounded text-sm focus:border-cyan-400 outline-none text-cyan-100">
                            <option value="Cyberpunk Noir">Cyberpunk Noir</option>
                            <option value="Epic High Fantasy">Epic High Fantasy</option>
                            <option value="Eldritch Cosmic Horror">Eldritch Cosmic Horror</option>
                            <option value="Post-Apocalyptic Survival">Post-Apocalyptic Survival</option>
                            <option value="Space Opera">Space Opera</option>
                            <option value="Grimdark Medieval">Grimdark Medieval</option>
                            <option value="Steampunk Espionage">Steampunk Espionage</option>
                            <option value="Techno-Thriller">Techno-Thriller</option>
                            <option value="Psychological Horror">Psychological Horror</option>
                            <option value="Solarpunk Utopia">Solarpunk Utopia</option>
                            <option value="Ancient Samurai Tragedy">Ancient Samurai Tragedy</option>
                            <option value="Mythic Odyssey">Mythic Odyssey</option>
                            <option value="Weird West">Weird West</option>
                            <option value="Time Paradox Mystery">Time Paradox Mystery</option>
                            <option value="Abyssal Dystopia">Abyssal Dystopia</option>
                            <option value="Surrealist Glitch">Surrealist Glitch</option>
                            <option value="Political Intrigue">Political Intrigue</option>
                            <option value="Dark Fairytale">Dark Fairytale</option>
                            <option value="Cyber-Archaeology">Cyber-Archaeology</option>
                            <option value="Bio-Punk Evolution">Bio-Punk Evolution</option>
                            <option value="Hard Space Realism">Hard Space Realism</option>
                        </select>
                    </div>

                    <!-- Carpool Mode -->
                    <div class="space-y-2">
                        <label class="text-[10px] uppercase font-black text-gray-500 tracking-widest">Travel
                            Protocol</label>
                        <button id="toggle-carpool" onclick="ui.toggleCarpool()"
                            class="w-full bg-black/50 border border-cyan-900/50 p-3 rounded text-sm text-left flex justify-between items-center group">
                            <span id="carpool-label" class="text-gray-400">Solo Expedition</span>
                            <div id="carpool-indicator"
                                class="w-10 h-5 bg-gray-800 rounded-full relative transition-colors">
                                <div class="absolute left-1 top-1 w-3 h-3 bg-gray-600 rounded-full transition-all">
                                </div>
                            </div>
                        </button>
                    </div>
                </div>

                <!-- Custom Plot -->
                <div class="space-y-2">
                    <label class="text-[10px] uppercase font-black text-gray-500 tracking-widest">Custom Plot Seed
                        (Optional)</label>
                    <textarea id="config-plot" placeholder="Input specific plot directives here..."
                        class="w-full bg-black/50 border border-cyan-900/50 p-3 rounded text-sm focus:border-cyan-400 outline-none h-24 text-gray-300 resize-none"></textarea>
                </div>

                <div class="pt-4">
                    <!-- START BUTTON -->
                    <button onclick="engine.startSession()"
                        class="w-full py-5 bg-cyan-600 hover:bg-cyan-400 text-black font-black uppercase tracking-widest transition-all rounded shadow-[0_0_30px_rgba(6,182,212,0.4)] flex items-center justify-center gap-3">
                        <i data-lucide="power" class="w-5 h-5"></i>
                        Initiate Protocol
                    </button>
                </div>
            </div>

            <div id="chapter-feed" class="space-y-16"></div>

        </section>

        <!-- Loading Shimmer Template -->
        <div id="loading-indicator" class="hidden space-y-4 cyber-panel p-8 rounded-xl">
            <div class="flex items-center gap-2 mb-4">
                <div class="w-3 h-3 bg-cyan-400 rounded-full animate-ping"></div>
                <span class="text-xs text-cyan-400 uppercase font-bold tracking-tighter">Synthesizing Mistral Prose (15+
                    Paragraphs)...</span>
            </div>
            <div class="space-y-2">
                <div class="h-4 w-3/4 shimmer rounded-md"></div>
                <div class="h-4 w-full shimmer rounded-md"></div>
                <div class="h-4 w-5/6 shimmer rounded-md"></div>
                <div class="h-4 w-4/6 shimmer rounded-md"></div>
                <div class="h-4 w-11/12 shimmer rounded-md"></div>
            </div>
        </div>
    </main>

    <!-- Control Overlay -->
    <div class="fixed bottom-0 left-0 w-full p-4 z-[60] bg-gradient-to-t from-black via-black/90 to-transparent">
        <div class="max-w-5xl mx-auto cyber-panel p-6 rounded-2xl border-cyan-500/30">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 items-center">

                <div class="space-y-2">
                    <div class="flex justify-between text-[10px] font-bold uppercase tracking-widest text-cyan-400">
                        <span>Traverse Intensity</span>
                        <span id="label-intensity">Resting</span>
                    </div>
                    <input type="range" id="sim-speed" min="0" max="15" step="0.5" value="0"
                        class="w-full h-1 bg-gray-800 rounded-lg appearance-none cursor-pointer">
                </div>

                <div class="flex flex-col items-center gap-1">
                    <div id="timer" class="text-3xl font-mono font-bold tracking-widest text-white">00:00:00</div>
                    <div class="flex gap-2">
                        <button id="btn-pause" onclick="engine.togglePause()"
                            class="hidden p-2 rounded-full border border-gray-700 text-gray-500 hover:border-cyan-500 hover:text-cyan-500 transition">
                            <i data-lucide="pause" class="w-5 h-5"></i>
                        </button>
                        <button onclick="engine.saveAndExit()"
                            class="px-4 py-1.5 rounded bg-red-950/40 border border-red-500/50 text-red-500 text-[10px] font-black uppercase tracking-widest hover:bg-red-500 hover:text-white transition">
                            Terminate
                        </button>
                    </div>
                </div>

                <div class="space-y-1">
                    <div class="flex justify-between text-[10px] font-bold uppercase tracking-widest text-gray-500">
                        <span>Chapter Convergence</span>
                        <span id="label-sync">0%</span>
                    </div>
                    <div class="w-full h-1 bg-gray-900 rounded-full overflow-hidden">
                        <div id="sync-progress" class="h-full bg-cyan-400 transition-all duration-500"
                            style="width: 0%"></div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- Archives Modal -->
    <div id="modal-archives" class="fixed inset-0 bg-black/95 z-[100] hidden p-6 overflow-y-auto">
        <div class="max-w-2xl mx-auto space-y-8">
            <div class="flex justify-between items-center border-b border-gray-800 pb-4">
                <h2 class="glitch-text text-3xl font-bold uppercase">Memory Cores</h2>
                <button onclick="ui.toggleSavedDashboard()" class="text-gray-500 hover:text-white">
                    <i data-lucide="x" class="w-8 h-8"></i>
                </button>
            </div>
            <div id="archives-list" class="grid gap-4"></div>
        </div>
    </div>

    <script>
        const apiKey = "";
        const CHAPTER_INTERVAL_MS = 10 * 60 * 1000;
        const SOLO_CO2_FACTOR = 404;
        const CARPOOL_CO2_FACTOR = 180;

        let state = {
            id: null,
            startTime: null,
            elapsedSeconds: 0,
            distance: 0,
            currentSpeed: 0,
            lastLat: null,
            lastLon: null,
            chapters: [],
            isPaused: true,
            isGenerating: false,
            syncProgress: 0,
            userId: 'user-' + Math.random().toString(36).substr(2, 9),
            watchId: null,
            config: {
                genre: "Cyberpunk Noir",
                carpool: false,
                plot: ""
            }
        };

        const engine = {
            async startSession(existingState = null) {
                if (existingState) {
                    state = existingState;
                    ui.renderAllChapters();
                    document.getElementById('setup-panel').classList.add('hidden');
                } else {
                    state.id = 'journey-' + Date.now();
                    state.startTime = Date.now();
                    state.chapters = [];
                    state.distance = 0;
                    state.elapsedSeconds = 0;
                    state.config.genre = document.getElementById('config-genre').value;
                    state.config.plot = document.getElementById('config-plot').value;
                }

                state.isPaused = false;
                document.getElementById('setup-panel').classList.add('hidden');
                document.getElementById('btn-pause').classList.remove('hidden');

                this.initSensors();
                this.startTimer();

                if (state.chapters.length === 0) {
                    this.generateChapter();
                }
            },

            initSensors() {
                if ("geolocation" in navigator) {
                    if (state.watchId) navigator.geolocation.clearWatch(state.watchId);

                    state.watchId = navigator.geolocation.watchPosition(
                        (pos) => {
                            document.getElementById('geo-error-bar').classList.add('hidden');
                            if (state.isPaused) return;
                            const { latitude, longitude, speed } = pos.coords;
                            const simSpeed = parseFloat(document.getElementById('sim-speed').value);
                            const actualSpeed = speed ? speed * 2.237 : 0;
                            state.currentSpeed = simSpeed > 0 ? simSpeed : actualSpeed;
                            if (state.lastLat && state.lastLon) {
                                const d = this.calcDistance(state.lastLat, state.lastLon, latitude, longitude);
                                if (d < 0.5) state.distance += d;
                            }
                            state.lastLat = latitude;
                            state.lastLon = longitude;
                            ui.updateDashboard();
                        },
                        (err) => {
                            console.warn("Geo Error:", err.message);
                            document.getElementById('geo-error-bar').classList.remove('hidden');
                        },
                        { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
                    );
                }
            },

            calcDistance(lat1, lon1, lat2, lon2) {
                const R = 3958.8;
                const dLat = (lat2 - lat1) * Math.PI / 180;
                const dLon = (lon2 - lon1) * Math.PI / 180;
                const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon / 2) * Math.sin(dLon / 2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
                return R * c;
            },

            startTimer() {
                if (this.timerInterval) clearInterval(this.timerInterval);
                this.timerInterval = setInterval(() => {
                    if (state.isPaused) return;
                    state.elapsedSeconds++;
                    ui.updateTimer();
                    const timeSinceLast = (state.elapsedSeconds * 1000) % CHAPTER_INTERVAL_MS;
                    state.syncProgress = (timeSinceLast / CHAPTER_INTERVAL_MS) * 100;
                    ui.updateSyncBar();
                    if (timeSinceLast < 1000 && state.elapsedSeconds > 10) {
                        this.generateChapter();
                    }
                }, 1000);
            },

            async generateChapter() {
                if (state.isGenerating) return;
                state.isGenerating = true;
                ui.showLoading(true);

                const intensity = state.currentSpeed > 10 ? 'extreme/fast' : (state.currentSpeed > 4 ? 'moderate/steady' : 'deliberate/slow');
                const context = state.chapters.map(c => c.text).slice(-1).join('\n\n');

                const prompt = `Generate a new chapter in the style of a MISTRAL-AI model (dense, precise, philosophical, and highly descriptive).
                    Genre: ${state.config.genre}.
                    Plot Directives: ${state.config.plot || 'Standard survival expedition.'}
                    
                    REQUIREMENTS:
                    1. Write exactly 15 paragraphs. 
                    2. Use strict SECOND PERSON ("You").
                    3. Focus on: ${intensity} movement.
                    4. Social Context: ${state.config.carpool ? 'Traveling with a group/squad.' : 'Traveling alone.'}
                    5. Each paragraph should be substantive (3-5 sentences each).
                    6. Maintain a consistent literary tone appropriate to the genre.
                    
                    Context of previous events: ${context || 'The journey begins now.'}`;

                try {
                    const response = await fetch(apiUrl, {
                        method: "POST",
                        headers: {
                            "Authorization": `Bearer zpb7IgLy7bNk5MCh5LUfYmJnTtJCqyRQ`,
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({
                            model: "mistral-large-latest", // Or another model like 'mistral-small-latest'
                            messages: [
                                {
                                    role: "user",
                                    content: prompt
                                }
                            ],
                            temperature: 0.7, // Optional: adjust creativity
                            top_p: 0.9,       // Optional: adjust diversity
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const data = await response.json();
                    console.log(data.choices[0].message.content);

                } 

                    const data = await response.json();
                const text = data.candidates[0].content.parts[0].text;

                const chapter = {
                    id: Date.now(),
                    text,
                    intensity,
                    timestamp: new Date().toLocaleTimeString()
                };

                state.chapters.push(chapter);
                ui.renderChapter(chapter);
                this.autoSave();
            } catch(err) {
                console.error("Narrative Error:", err);
            } finally {
                state.isGenerating = false;
                ui.showLoading(false);
            }
        },

            async autoSave() {
                await localforage.setItem(state.id, JSON.parse(JSON.stringify(state)));
                let index = await localforage.getItem('journey_index') || [];
                if (!index.includes(state.id)) {
                    index.push(state.id);
                    await localforage.setItem('journey_index', index);
                }
            },

                async saveAndExit() {
            state.isPaused = true;
            if (state.watchId) navigator.geolocation.clearWatch(state.watchId);
            await this.autoSave();
            window.location.reload();
        },

        togglePause() {
            state.isPaused = !state.isPaused;
            document.getElementById('btn-pause').innerHTML = state.isPaused
                ? '<i data-lucide="play" class="w-5 h-5"></i>'
                : '<i data-lucide="pause" class="w-5 h-5"></i>';
            lucide.createIcons();
        }
        };

        const ui = {
            toggleCarpool() {
                state.config.carpool = !state.config.carpool;
                const label = document.getElementById('carpool-label');
                const indicator = document.getElementById('carpool-indicator');
                const dot = indicator.querySelector('div');
                const co2Label = document.getElementById('stat-co2-label');
                const accent = document.getElementById('co2-accent');

                if (state.config.carpool) {
                    label.innerText = "Carpool Protocol";
                    label.classList.add('text-orange-400');
                    indicator.classList.replace('bg-gray-800', 'bg-orange-500/40');
                    dot.classList.replace('left-1', 'left-6');
                    dot.classList.replace('bg-gray-600', 'bg-orange-400');
                    co2Label.innerText = "Group Offset";
                    co2Label.classList.replace('text-green-400', 'text-orange-400');
                    accent.classList.replace('bg-green-500/30', 'bg-orange-500/30');
                } else {
                    label.innerText = "Solo Expedition";
                    label.classList.remove('text-orange-400');
                    indicator.classList.replace('bg-orange-500/40', 'bg-gray-800');
                    dot.classList.replace('left-6', 'left-1');
                    dot.classList.replace('bg-orange-400', 'bg-gray-600');
                    co2Label.innerText = "CO2 Redux";
                    co2Label.classList.replace('text-orange-400', 'text-green-400');
                    accent.classList.replace('bg-orange-500/30', 'bg-green-500/30');
                }
                this.updateDashboard();
            },

            updateDashboard() {
                const simSpeed = parseFloat(document.getElementById('sim-speed').value);
                const displaySpeed = simSpeed > 0 ? simSpeed : state.currentSpeed;
                document.getElementById('stat-speed').innerText = displaySpeed.toFixed(1);
                document.getElementById('stat-dist').innerText = state.distance.toFixed(2);
                const factor = state.config.carpool ? CARPOOL_CO2_FACTOR : SOLO_CO2_FACTOR;
                document.getElementById('stat-co2').innerText = Math.round(state.distance * factor);
                const label = displaySpeed > 10 ? 'High' : (displaySpeed > 4 ? 'Moderate' : 'Low');
                document.getElementById('label-intensity').innerText = label;
            },

            updateTimer() {
                const hrs = Math.floor(state.elapsedSeconds / 3600);
                const mins = Math.floor((state.elapsedSeconds % 3600) / 60);
                const secs = state.elapsedSeconds % 60;
                document.getElementById('timer').innerText =
                    `${hrs.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            },

            updateSyncBar() {
                document.getElementById('sync-progress').style.width = `${state.syncProgress}%`;
                document.getElementById('label-sync').innerText = `${Math.round(state.syncProgress)}%`;
            },

            showLoading(isLoading) {
                const loader = document.getElementById('loading-indicator');
                if (isLoading) {
                    loader.classList.remove('hidden');
                    loader.scrollIntoView({ behavior: 'smooth' });
                } else {
                    loader.classList.add('hidden');
                }
            },

            renderChapter(chapter) {
                const feed = document.getElementById('chapter-feed');
                const card = document.createElement('div');
                card.className = 'chapter-card cyber-panel p-10 rounded-2xl space-y-6 animate-in fade-in slide-in-from-bottom-8 duration-1000';

                // Format paragraphs
                const formattedText = chapter.text.split('\n').filter(p => p.trim() !== '').map(p => `<p class="mb-6">${p}</p>`).join('');

                card.innerHTML = `
                    <div class="flex justify-between items-center text-[10px] font-bold uppercase tracking-[0.2em] text-cyan-500 mb-4 border-b border-cyan-500/20 pb-4">
                        <span class="flex items-center gap-2"><i data-lucide="hash" class="w-3 h-3"></i> Core Entry ${state.chapters.length}</span>
                        <span>${chapter.timestamp} • ${chapter.intensity} Intensity</span>
                    </div>
                    <div class="chapter-text text-gray-200 mistral-glow">
                        ${formattedText}
                    </div>
                `;
                feed.prepend(card);
                lucide.createIcons();
            },

            renderAllChapters() {
                const feed = document.getElementById('chapter-feed');
                feed.innerHTML = '';
                state.chapters.slice().reverse().forEach(c => this.renderChapter(c));
            },

            async toggleSavedDashboard() {
                const modal = document.getElementById('modal-archives');
                const list = document.getElementById('archives-list');
                if (modal.classList.contains('hidden')) {
                    const index = await localforage.getItem('journey_index') || [];
                    list.innerHTML = index.length ? '' : '<p class="text-gray-500 text-center py-10 italic">Neural buffers empty.</p>';
                    for (const id of index) {
                        const data = await localforage.getItem(id);
                        if (!data) continue;
                        const item = document.createElement('div');
                        item.className = 'cyber-panel p-4 rounded border-gray-800 hover:border-cyan-500 cursor-pointer transition flex justify-between items-center';
                        item.onclick = () => { engine.startSession(data); this.toggleSavedDashboard(); };
                        item.innerHTML = `
                            <div>
                                <h4 class="font-bold text-cyan-400 uppercase tracking-widest text-sm">${data.config.genre} Log</h4>
                                <p class="text-xs text-gray-500">${data.chapters.length} Entries • ${data.distance.toFixed(2)} mi Traversed</p>
                            </div>
                            <i data-lucide="chevron-right" class="text-gray-700"></i>
                        `;
                        list.appendChild(item);
                    }
                    modal.classList.remove('hidden');
                    lucide.createIcons();
                } else {
                    modal.classList.add('hidden');
                }
            }
        };

        window.onload = () => {
            lucide.createIcons();
            document.getElementById('sim-speed').addEventListener('input', () => ui.updateDashboard());
        };
    </script>
</body>

</html>