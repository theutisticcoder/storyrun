<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PacePulse: AI Run-Narrator</title>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Third-party libs (localForage for storage, JSZip for EPUB generation) -->
    <script src="https://cdn.jsdelivr.net/npm/localforage@1.10.0/dist/localforage.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jepub/dist/jepub.js"></script>


    <!-- EdgeTTS -->


    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;500;700&family=Lora:ital,wght@0,400;1,400&display=swap');

        body {
            font-family: 'Space Grotesk', sans-serif;
        }

        .prose-font {
            font-family: 'Lora', serif;
        }

        .speed-glow {
            transition: text-shadow 0.3s ease;
        }

        .speed-high {
            text-shadow: 0 0 20px #ef4444;
            color: #ef4444;
        }

        .speed-med {
            text-shadow: 0 0 20px #f59e0b;
            color: #f59e0b;
        }

        .speed-low {
            text-shadow: 0 0 20px #10b981;
            color: #10b981;
        }

        .loading-shimmer {
            background: linear-gradient(90deg, #1f2937 25%, #374151 50%, #1f2937 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }

        @keyframes shimmer {
            0% {
                background-position: 200% 0;
            }

            100% {
                background-position: -200% 0;
            }
        }
    </style>
</head>

<body class="bg-gray-950 text-gray-100 min-h-screen flex flex-col">

    <!-- Header & Dashboard -->
    <header class="p-6 border-b border-gray-800 bg-gray-900/50 backdrop-blur-md sticky top-0 z-50">
        <div class="max-w-6xl mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
            <h1 class="text-2xl font-bold tracking-tighter italic">PACE<span class="text-red-500">PULSE</span></h1>

            <!-- Dashboard Metrics -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-6 items-center w-full md:w-auto">
                <div class="text-center md:text-right border-r border-gray-800 pr-4 last:border-0 last:pr-0">
                    <p class="text-[10px] uppercase text-gray-400 tracking-wider">Speed</p>
                    <p id="speed-display" class="text-2xl font-bold speed-low">0.0 <span
                            class="text-xs font-normal text-gray-500">mph</span></p>
                </div>

                <div class="text-center md:text-right border-r border-gray-800 pr-4 last:border-0 last:pr-0">
                    <p class="text-[10px] uppercase text-gray-400 tracking-wider">Distance</p>
                    <p id="distance-display" class="text-2xl font-bold text-gray-200">0.00 <span
                            class="text-xs font-normal text-gray-500">mi</span></p>
                </div>

                <div class="text-center md:text-right border-r border-gray-800 pr-4 last:border-0 last:pr-0">
                    <p class="text-[10px] uppercase text-gray-400 tracking-wider">CO₂ Saved</p>
                    <p id="emissions-display" class="text-2xl font-bold text-green-400">0.00 <span
                            class="text-xs font-normal text-green-700">lb</span></p>
                </div>

                <div class="text-center md:text-right">
                    <p class="text-[10px] uppercase text-gray-400 tracking-wider">Intensity</p>
                    <p id="intensity-display"
                        class="text-xs font-medium text-gray-300 italic max-w-[100px] md:max-w-[150px] truncate">
                        Waiting...</p>
                </div>
            </div>
        </div>
    </header>

    <main class="flex-grow p-4 md:p-8 max-w-4xl mx-auto w-full">
        <!-- Error Toast -->
        <div id="error-toast"
            class="hidden bg-red-900/80 border border-red-500 p-4 rounded-xl mb-6 text-sm text-red-200"></div>

        <!-- Setup Form -->
        <section id="setup-panel" class="bg-gray-900 p-6 rounded-2xl border border-gray-800 shadow-2xl">
            <h2 class="text-xl font-semibold mb-4">Initialize Adventure</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm text-gray-400 mb-1">Gemini API Key (Free Tier)</label>
                    <input type="password" id="api-key" placeholder="Enter your key..."
                        class="w-full bg-gray-800 border border-gray-700 rounded-lg p-3 focus:ring-2 focus:ring-red-500 outline-none">
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Genre</label>
                        <select id="genre"
                            class="w-full bg-gray-800 border border-gray-700 rounded-lg p-3 outline-none">
                            <option value="Fantasy Adventure">Fantasy Adventure</option>
                            <option value="Sci-Fi Thriller">Sci-Fi Thriller</option>
                            <option value="Mystery Detective">Mystery Detective</option>
                            <option value="Horror Survival">Horror Survival</option>
                            <option value="Horror Gothic">Horror Gothic</option>
                            <option value="Horror Psychological">Horror Physchological</option>
                            <option value="Romance Comedy">Romance Comedy</option>
                            <option value="Historical Fiction">Historical Fiction</option>
                            <option value="Superhero Action">Superhero Action</option>
                            <option value="Dystopian Future">Dystopian Future</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Custom Plot Hook</label>
                        <input type="text" id="plot" placeholder="e.g. A heist on a moon base..."
                            class="w-full bg-gray-800 border border-gray-700 rounded-lg p-3 outline-none">
                    </div>
                </div>

                <div class="p-3 bg-gray-800/50 rounded-lg text-xs text-gray-400">
                    <p>Note: Speed tracking requires a GPS-enabled device and an HTTPS connection. If GPS is unavailable
                        or stationary, use the simulator in the control bar below.</p>
                </div>

                <button id="start-btn"
                    class="w-full bg-red-600 hover:bg-red-500 text-white font-bold py-4 rounded-xl transition-all transform hover:scale-[1.02] active:scale-95">
                    START WORKOUT & GENERATE
                </button>

                <!-- Saved Stories -->
                <div id="saved-stories-section" class="mt-4">
                    <h3 class="text-sm text-gray-400 mb-2 uppercase">Saved Stories</h3>
                    <div id="saved-list" class="space-y-2 text-sm text-gray-300"></div>
                </div>
            </div>
        </section>

        <!-- Story Display -->
        <section id="story-panel" class="hidden mt-8 space-y-8 pb-24">
            <div id="loading-indicator" class="hidden space-y-3">
                <div class="h-4 w-3/4 loading-shimmer rounded"></div>
                <div class="h-4 w-full loading-shimmer rounded"></div>
                <div class="h-4 w-5/6 loading-shimmer rounded"></div>
                <p class="text-xs text-gray-500 animate-pulse text-center pt-2">The AI is observing your pace to set the
                    narrative tone...</p>
            </div>

            <div id="chapters-container" class="space-y-12">
                <!-- Chapters injected here -->
            </div>
        </section>
    </main>

    <!-- Controls Overlay -->
    <div id="player-controls"
        class="hidden fixed bottom-6 left-1/2 -translate-x-1/2 bg-gray-900 border border-gray-800 px-6 py-4 rounded-full shadow-2xl flex items-center gap-4 z-50 w-max max-w-[95vw]">
        <button id="tts-toggle" class="p-2 hover:bg-gray-800 rounded-full text-red-500 flex-shrink-0">
            <svg xmlns="http://www.w3.org/2000/svg" id="tts-icon" class="h-8 w-8" fill="none" viewBox="0 0 24 24"
                stroke="currentColor">
                <!-- Speaker (sound-on) icon -->
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M11.05 4.99 6.3 8.49H3.75A.75.75 0 0 0 3 9.24v5.52c0 .414.336.75.75.75h2.55l4.75 3.5c.412.304 1.025.01 1.025-.58V5.57c0-.59-.613-.884-1.025-.58z" />
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M15.536 8.464a5 5 0 010 7.072" />
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M19.364 4.636a9 9 0 010 12.728" />
            </svg>
        </button>

        <div class="h-8 w-[1px] bg-gray-700 hidden sm:block"></div>
        <div id="workout-timer" class="font-mono text-xl tabular-nums hidden sm:block">00:00</div>
        <div class="h-8 w-[1px] bg-gray-700" id="manual-speed-divider"></div>
        <div id="manual-speed-ctrl" class="flex items-center gap-2">
            <!-- Updated simulator slider for MPH -->
            <input type="range" id="speed-slider" min="0" max="15" step="0.5" value="0"
                class="w-24 h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-red-500">
            <span class="text-xs text-gray-400">MPH SIM</span>
        </div>

    </div>

    <script type="module">
        import Groq from 'https://cdn.jsdelivr.net/npm/groq-sdk@0.37.0/+esm'
        import { EdgeTTSClient, ProsodyOptions, OUTPUT_FORMAT } from 'https://cdn.jsdelivr.net/npm/edge-tts-client@1.0.2/+esm';
        window.EdgeTTS = EdgeTTSClient;

        // --- State ---
        let state = {
            active: false,
            apiKey: '',
            genre: '',
            plot: '',
            currentSpeed: 0, // Always stored as m/s internally for consistency
            totalDistance: 0, // Always stored as meters internally
            startTime: null,
            timerId: null,
            chapters: [],
            fullStoryContext: '',
            isGenerating: false,
            ttsEnabled: true,
            currentAudio: null,
            usingSimulatedSpeed: true,
            lastPos: null,
            watchId: null,
            sessionId: null
        };

        const elements = {
            speed: document.getElementById('speed-display'),
            distance: document.getElementById('distance-display'),
            emissions: document.getElementById('emissions-display'),
            intensity: document.getElementById('intensity-display'),
            setup: document.getElementById('setup-panel'),
            story: document.getElementById('story-panel'),
            loading: document.getElementById('loading-indicator'),
            container: document.getElementById('chapters-container'),
            timer: document.getElementById('workout-timer'),
            controls: document.getElementById('player-controls'),
            startBtn: document.getElementById('start-btn'),
            ttsBtn: document.getElementById('tts-toggle'),
            ttsIcon: document.getElementById('tts-icon'),
            error: document.getElementById('error-toast'),
            simSlider: document.getElementById('speed-slider'),
            savedList: document.getElementById('saved-list'),
        };

        // localForage config
        localforage.config({
            name: 'pacepulse',
            storeName: 'stories' // table/collection name
        });

        function showError(msg) {
            elements.error.innerText = msg;
            elements.error.classList.remove('hidden');
            console.error("PacePulse Error:", msg);
            setTimeout(() => elements.error.classList.add('hidden'), 8000);
        }

        // Haversine distance (meters)
        function haversineDistanceMeters(lat1, lon1, lat2, lon2) {
            const toRad = (deg) => deg * Math.PI / 180;
            const R = 6371000;
            const dLat = toRad(lat2 - lat1);
            const dLon = toRad(lon2 - lon1);
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        // --- Tracking setup ---
        function setupTracking() {
            if (!("geolocation" in navigator)) {
                showError("Geolocation not supported in this browser. Use manual simulator.");
                return;
            }

            const options = { enableHighAccuracy: true, maximumAge: 1000, timeout: 15000 };

            if (navigator.permissions && navigator.permissions.query) {
                navigator.permissions.query({ name: 'geolocation' })
                    .then((perm) => {
                        if (perm.state === 'denied') {
                            showError("Geolocation permission denied. Using manual simulator.");
                            state.usingSimulatedSpeed = true;
                        }
                        startWatch();
                    })
                    .catch(() => startWatch());
            } else {
                startWatch();
            }

            function startWatch() {
                if (state.watchId !== null) {
                    try { navigator.geolocation.clearWatch(state.watchId); } catch (e) { }
                    state.watchId = null;
                }

                state.watchId = navigator.geolocation.watchPosition(
                    (pos) => {
                        // auto-switch to GPS when valid updates come in, unless user touches slider (explicit)
                        state.usingSimulatedSpeed = false;

                        const reported = pos.coords.speed; // This is always m/s from browser
                        let distDelta = 0;

                        // Calculate distance from previous point if available
                        if (state.lastPos) {
                            const d = haversineDistanceMeters(
                                state.lastPos.lat, state.lastPos.lon,
                                pos.coords.latitude, pos.coords.longitude
                            );

                            // Only count if accuracy is reasonable to prevent jumping
                            if (pos.coords.accuracy < 100) {
                                distDelta = d;
                            }

                            // Fallback speed calculation if native speed is null
                            const dt = (pos.timestamp - state.lastPos.timestamp) / 1000;
                            if (reported === null || isNaN(reported)) {
                                if (dt > 0.1 && d > 0) {
                                    const computed = d / dt;
                                    // Basic filter for impossible speeds (e.g., GPS drift > 15m/s for running)
                                    if (!isNaN(computed) && computed >= 0 && computed < 15) {
                                        state.currentSpeed = computed;
                                    }
                                }
                            } else {
                                state.currentSpeed = reported;
                            }
                        } else if (reported !== null && !isNaN(reported)) {
                            state.currentSpeed = reported;
                        }

                        // Accumulate Distance if not simulating
                        if (!state.usingSimulatedSpeed && distDelta > 0) {
                            state.totalDistance += distDelta;
                        }

                        state.lastPos = { lat: pos.coords.latitude, lon: pos.coords.longitude, timestamp: pos.timestamp };
                        updateUI();
                    },
                    (err) => {
                        console.warn("Geolocation error:", err);
                        // Errors handled gracefully by falling back to simulation logic implicitly 
                        // via the 'usingSimulatedSpeed' flag
                        state.usingSimulatedSpeed = true;
                    },
                    options
                );
            }
        }

        elements.simSlider.addEventListener('input', (e) => {
            state.usingSimulatedSpeed = true;
            // Slider is now in MPH. Convert to m/s for internal logic
            // 1 mph = 0.44704 m/s
            const mph = parseFloat(e.target.value);
            state.currentSpeed = mph * 0.44704;
            updateUI();
        });

        function updateUI() {
            // Speed Update (Internal m/s -> Display MPH)
            const s_ms = state.currentSpeed || 0;
            const s_mph = s_ms * 2.23694;

            elements.speed.innerText = s_mph.toFixed(1) + " ";
            if (!elements.speed.querySelector('span')) {
                const unit = document.createElement('span');
                unit.className = 'text-sm font-normal text-gray-500';
                unit.innerText = 'mph';
                elements.speed.appendChild(unit);
            }

            // Distance Update (Internal Meters -> Display Miles)
            // 1 meter = 0.000621371 miles
            const distMiles = state.totalDistance * 0.000621371;
            elements.distance.innerHTML = `${distMiles.toFixed(2)} <span class="text-xs font-normal text-gray-500">mi</span>`;

            // CO2 Emissions Saved Update
            // Avg passenger vehicle ~404 grams CO2 per mile ~ 0.89 lbs per mile.
            // Let's use 0.9 lbs per mile for estimation.
            const savedLbs = distMiles * 0.9;
            elements.emissions.innerHTML = `${savedLbs.toFixed(2)} <span class="text-xs font-normal text-green-700">lb</span>`;


            // Styling based on speed (still using m/s thresholds)
            elements.speed.classList.remove('speed-low', 'speed-med', 'speed-high');
            if (s_ms > 4.5) { // ~10mph
                elements.speed.classList.add('speed-high');
                elements.intensity.innerText = "CLIMAX - High Tension";
            } else if (s_ms > 2.5) { // ~5.6mph
                elements.speed.classList.add('speed-med');
                elements.intensity.innerText = "RISING ACTION - Moderate";
            } else {
                elements.speed.classList.add('speed-low');
                elements.intensity.innerText = s_ms > 0.1 ? "EXPOSITION - Calm" : "STATIONARY";
            }
        }

        // --- Timer ---
        function startTimer() {
            state.startTime = Date.now();
            if (state.timerId) clearInterval(state.timerId);
            state.timerId = setInterval(() => {
                if (!state.active) return;

                // Timer Logic
                const elapsed = Math.floor((Date.now() - state.startTime) / 1000);
                const mins = Math.floor(elapsed / 60).toString().padStart(2, '0');
                const secs = (elapsed % 60).toString().padStart(2, '0');
                elements.timer.innerText = `${mins}:${secs}`;

                // Simulator Distance Integration
                // If using slider, we must accumulate distance manually based on time
                if (state.usingSimulatedSpeed) {
                    // add speed (m/s) * 1 second
                    state.totalDistance += state.currentSpeed;
                    updateUI(); // Refresh UI for the distance change
                }

                // AI Chapter Trigger
                if (elapsed > 0 && elapsed % 300 === 0 && !state.isGenerating) {
                    generateNewChapter();
                }
            }, 1000);
        }

        function stopTimer() {
            if (state.timerId) { clearInterval(state.timerId); state.timerId = null; }
        }

        // --- AI generation (unchanged majorly) ---
        async function generateNewChapter() {
            if (state.isGenerating) return;
            state.isGenerating = true;
            elements.loading.classList.remove('hidden');

            const speed = state.currentSpeed;
            let stylisticInstruction = "";
            if (speed > 4.5) {
                stylisticInstruction = "The story must reach a fever pitch of adrenaline. Use short, punchy sentences. Focus on urgent action, racing hearts, and immediate threats. The tension should be immediate and visceral.";
            } else if (speed > 2.5) {
                stylisticInstruction = "The story should build tension steadily. Use rhythmic prose with rising stakes. Focus on the momentum of the plot and the characters' forward progress.";
            } else {
                stylisticInstruction = "The story should be atmospheric, descriptive, and introspective. Use longer, more complex sentences. Focus on world-building, sensory details, and character background.";
            }

            const prompt = `
                Genre: ${state.genre}. 
                Core Plot: ${state.plot}.
                
                WRITING STYLE MANDATE: 
                ${stylisticInstruction}
                
                IMPORTANT: DO NOT mention that the user is running, working out, or mention their "speed", "meters per second", or "pace" literally. This is a fictional story.
                
                Task: Write Chapter ${state.chapters.length + 1}. 
                Context: Continue the ongoing story based on these previous themes: ${state.fullStoryContext.slice(-1500)}.
                Requirement: Write a very long, high-quality chapter, use second person and only return plain text, not markdown.
            `;

            try {
                const chapterText = await fetchGemini(prompt);
                state.fullStoryContext += `\n\nChapter ${state.chapters.length + 1}\n${chapterText}`;
                state.chapters.push(chapterText);
                renderChapter(chapterText);

                // Save after each new chapter
                await saveCurrentSessionToStorage();

                if (state.ttsEnabled) {
                    speakText(chapterText.toString()); // 2. Then start audio generation
                }
            } catch (err) {
                showError("AI Error: Connection issue or invalid API key.");
            } finally {
                state.isGenerating = false;
                elements.loading.classList.add('hidden');
            }
        }

        async function fetchGemini(prompt) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-lite:generateContent?key=${state.apiKey}`;

            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: prompt }] }],
                    generationConfig: { maxOutputTokens: 8192, temperature: 0.85 }
                })
            });

            if (!response.ok) {
                const errData = await response.json();
                throw new Error(errData.error?.message || "API Request Failed");
            }
            const data = await response.json();
            return data.candidates[0].content.parts[0].text;
        }

        function renderChapter(text) {
            const chapterNum = state.chapters.length;
            const div = document.createElement('div');
            div.id = `chapter-wrapper-${chapterNum}`; // Add ID for targeting
            div.className = "bg-gray-900/40 p-8 rounded-3xl border border-gray-800 shadow-lg animate-in fade-in slide-in-from-bottom-4 duration-1000";
            div.innerHTML = `
        <div class="flex justify-between items-start mb-4">
            <h3 class="text-red-500 font-bold uppercase tracking-widest text-sm">Chapter ${chapterNum}</h3>
            <div id="audio-container-${chapterNum}" class="w-1/2 flex flex-col items-end">
                <div id="audio-status-${chapterNum}" class="text-[10px] text-gray-500 uppercase mb-1">Waiting for Voice...</div>
                <div class="w-full bg-gray-800 h-1.5 rounded-full overflow-hidden hidden" id="progress-bar-bg-${chapterNum}">
                    <div id="progress-bar-fill-${chapterNum}" class="bg-red-600 h-full w-0 transition-all duration-300"></div>
                </div>
            </div>
        </div>
        <div class="prose-font text-lg text-gray-300 leading-relaxed first-letter:text-5xl first-letter:font-bold first-letter:mr-3 first-letter:float-left">
            ${text.replace(/\n/g, '<br>')}
        </div>
    `;
            elements.container.prepend(div);
        }

        // --- TTS ---
        async function speakText(text) {

            const chapterIdx = state.chapters.length;
            const statusText = document.getElementById(`audio-status-${chapterIdx}`);
            const barBg = document.getElementById(`progress-bar-bg-${chapterIdx}`);
            const barFill = document.getElementById(`progress-bar-fill-${chapterIdx}`);
            const audioContainer = document.getElementById(`audio-container-${chapterIdx}`);

            try {
                statusText.innerText = "Synthesizing Audio...";
                barBg.classList.remove('hidden');

                const ttsClient = new window.EdgeTTS();
                await ttsClient.setMetadata('en-US-AndrewMultilingualNeural', OUTPUT_FORMAT.AUDIO_24KHZ_48KBITRATE_MONO_MP3);

                const options = new ProsodyOptions();
                options.pitch = 'medium';
                options.rate = 1.0;


                const groq = new Groq();

                const wav = await groq.audio.speech.create({
                    model: "canopylabs/orpheus-v1-english",
                    voice: "autumn",
                    response_format: "mp3",
                    input: text,
                });

                const buffer = Buffer.from(await wav.arrayBuffer());
                barFill.style.width = `100%`;
                statusText.innerText = "Audio Ready";

                const url = URL.createObjectURL(new Blob(buffer, { type: "audio/mp3" }));

                // Create the audio element
                const audioEl = document.createElement('audio');
                audioEl.controls = true;
                audioEl.src = url;
                audioEl.className = "h-8 mt-2 w-full accent-red-500 opacity-80 hover:opacity-100 transition-opacity";

                // Replace progress bar with audio player
                setTimeout(() => {
                    barBg.classList.add('hidden');
                    audioContainer.appendChild(audioEl);
                }, 500);

            } catch (e) {
                console.warn("TTS Error:", e);
                statusText.innerText = "Audio Failed";
                statusText.classList.add('text-red-500');
            }
        }
        // --- Storage (localForage) ---
        async function saveCurrentSessionToStorage() {
            // create a lightweight session object
            if (!state.sessionId) state.sessionId = `session-${Date.now()}`;
            const item = {
                id: state.sessionId,
                title: `${state.genre || 'Untitled'} - ${new Date().toISOString()}`,
                genre: state.genre,
                plot: state.plot,
                created_at: new Date().toISOString(),
                chapters: state.chapters,
                fullStoryContext: state.fullStoryContext
            };

            try {
                const saved = (await localforage.getItem('savedStories')) || [];
                // replace existing by id or push new
                const idx = saved.findIndex(s => s.id === item.id);
                if (idx >= 0) saved[idx] = item;
                else saved.push(item);
                await localforage.setItem('savedStories', saved);
                await displaySavedList();
            } catch (e) {
                console.error("save error", e);
            }
        }

        async function displaySavedList() {
            const saved = (await localforage.getItem('savedStories')) || [];
            elements.savedList.innerHTML = '';
            if (saved.length === 0) {
                elements.savedList.innerHTML = `<div class="text-xs text-gray-500">No saved stories yet.</div>`;
                return;
            }

            saved.slice().reverse().forEach(s => {
                const row = document.createElement('div');
                row.className = 'flex items-center justify-between gap-2 bg-gray-800/30 p-2 rounded';
                row.innerHTML = `
                    <div class="truncate text-xs">
                        <div class="font-medium text-gray-200">${escapeHtml(s.title)}</div>
                        <div class="text-xs text-gray-400 truncate">${escapeHtml(s.plot || '')}</div>
                    </div>
                    <div class="flex gap-2">
                        <button data-id="${s.id}" class="load-btn bg-gray-700 hover:bg-gray-600 px-2 py-1 rounded text-xs">Load</button>
                        <button data-id="${s.id}" class="del-btn bg-red-700 hover:bg-red-600 px-2 py-1 rounded text-xs">Delete</button>
                    </div>
                `;
                elements.savedList.appendChild(row);
            });

            // attach listeners
            elements.savedList.querySelectorAll('.load-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const id = e.currentTarget.dataset.id;
                    await restoreSavedStory(id);
                });
            });
            elements.savedList.querySelectorAll('.del-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const id = e.currentTarget.dataset.id;
                    await deleteSavedStory(id);
                });
            });
        }

        async function restoreSavedStory(id) {
            const saved = (await localforage.getItem('savedStories')) || [];
            const s = saved.find(x => x.id === id);
            if (!s) return showError("Saved story not found.");
            // populate state and render
            state.sessionId = s.id;
            state.genre = s.genre;
            state.plot = s.plot;
            state.chapters = s.chapters || [];
            state.fullStoryContext = s.fullStoryContext || '';
            // show story panel and render chapters
            elements.setup.classList.add('hidden');
            elements.story.classList.remove('hidden');
            elements.controls.classList.remove('hidden');
            elements.container.innerHTML = '';
            state.chapters.forEach((c) => renderChapter(c));
        }

        async function deleteSavedStory(id) {
            const saved = (await localforage.getItem('savedStories')) || [];
            const filtered = saved.filter(s => s.id !== id);
            await localforage.setItem('savedStories', filtered);
            await displaySavedList();
        }

        function escapeHtml(text) {
            if (!text) return '';
            return text.replaceAll('&', '&amp;').replaceAll('<', '&lt;').replaceAll('>', '&gt;');
        }

        // --- EPUB generation using JSZip ---
        // --- EPUB generation using jepub ---
        async function createEpub(title, chapters) {
            // Defensive checks
            if (typeof jEpub === 'undefined') {
                throw new Error('jEpub library is not loaded. Make sure https://cdn.jsdelivr.net/npm/jepub/dist/jepub.js is included.');
            }

            const meta = {
                title: title || 'Untitled',
                author: 'PacePulse AI',
                publisher: 'PacePulse App',
                description: `An AI-generated ${state.genre} story.`,
                // Ensure tags is an array (some jEpub builds are picky)
                tags: state.genre ? [state.genre, 'AI Fiction', 'Fitness'] : ['AI Fiction', 'Fitness']
            };

            let epub;
            try {
                // Some jEpub builds accept metadata in the constructor; try that first
                try {
                    epub = new jEpub(meta);
                } catch (e) {
                    // If constructor form fails, fall back to no-arg constructor
                    epub = new jEpub();
                }

                // Only call init if it exists and is a function (guard against builds that set init in a different way)
                if (typeof epub.init === 'function') {
                    // Sanitize tags/strings to avoid internal instanceof checks failing
                    if (meta.tags && !Array.isArray(meta.tags)) meta.tags = [meta.tags];
                    // Call init inside try/catch to prevent library internal errors from bubbling raw
                    try {
                        epub.init(meta);
                    } catch (innerErr) {
                        console.warn('jEpub.init threw an error (continuing if constructor already applied metadata):', innerErr);
                        // don't rethrow here — continue if constructor already set metadata
                    }
                }
            } catch (e) {
                // If anything about jEpub instantiation fails, give a clearer error so you can try a different CDN/version
                console.error('Failed to initialize jEpub:', e);
                throw new Error('EPUB library initialization failed. Try using a different jepub build (upgrade/downgrade CDN version).');
            }

            // Add chapters (wrap text in minimal HTML)
            try {
                chapters.forEach((ch, i) => {
                    const chapterTitle = `Chapter ${i + 1}`;
                    const htmlContent = `
                <!doctype html>
                <html lang="en">
                <head><meta charset="utf-8"/></head>
                <body>
                    <h1>${chapterTitle}</h1>
                    <div>${ch.replace(/\n/g, '<br/>')}</div>
                </body>
                </html>
            `;
                    // jEpub expects epub.add(title, content)
                    epub.add(chapterTitle, htmlContent);
                });

                // Generate the EPUB as a blob.
                // jEpub.generate may return a Promise or accept a callback depending on build/version,
                // so handle both forms.
                let blob;
                const gen = epub.generate;
                if (!gen) throw new Error('jEpub.generate is not available on this build.');

                // If generate returns a Promise when called, await it; otherwise wrap the callback form.
                try {
                    // try promise-style
                    blob = await epub.generate('blob');
                } catch (promiseErr) {
                    // fallback to callback-style
                    blob = await new Promise((resolve, reject) => {
                        try {
                            epub.generate('blob', function (err, result) {
                                if (err) reject(err);
                                else resolve(result);
                            });
                        } catch (cbErr) {
                            reject(cbErr);
                        }
                    });
                }

                return blob;
            } catch (e) {
                console.error('createEpub failed:', e);
                throw e; // rethrow so caller shows friendly error
            }
        }

      

        // --- End run behavior ---


        // --- Utilities & initialization ---
        elements.startBtn.addEventListener('click', () => {
            const key = document.getElementById('api-key').value.trim();
            if (!key) { showError("Gemini API Key is required."); return; }

            // init new session
            state.apiKey = key;
            state.genre = document.getElementById('genre').value;
            state.plot = document.getElementById('plot').value || "An unexpected journey begins.";
            state.active = true;
            state.chapters = [];
            state.fullStoryContext = '';
            state.totalDistance = 0; // reset
            state.sessionId = `session-${Date.now()}`;

            elements.setup.classList.add('hidden');
            elements.story.classList.remove('hidden');
            elements.controls.classList.remove('hidden');
            elements.container.innerHTML = '';

            // start with simulator until GPS available
            state.usingSimulatedSpeed = true;
            setupTracking();
            startTimer();
            generateNewChapter();
            updateUI(); // immediate UI init
        });

        elements.ttsBtn.addEventListener('click', () => {
            state.ttsEnabled = !state.ttsEnabled;
            if (!state.ttsEnabled) {
                if (state.currentAudio) state.currentAudio.pause();
                elements.ttsIcon.innerHTML = `
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.05 4.99 6.3 8.49H3.75A.75.75 0 0 0 3 9.24v5.52c0 .414.336.75.75.75h2.55l4.75 3.5c.412.304 1.025.01 1.025-.58V5.57c0-.59-.613-.884-1.025-.58z"/>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 9l6 6"/>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 9l-6 6"/>
                `;
                elements.ttsBtn.classList.replace('text-red-500', 'text-gray-500');
            } else {
                elements.ttsIcon.innerHTML = `
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.05 4.99 6.3 8.49H3.75A.75.75 0 0 0 3 9.24v5.52c0 .414.336.75.75.75h2.55l4.75 3.5c.412.304 1.025.01 1.025-.58V5.57c0-.59-.613-.884-1.025-.58z"/>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072"/>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.364 4.636a9 9 0 010 12.728"/>
                `;
                elements.ttsBtn.classList.replace('text-gray-500', 'text-red-500');
            }
        });


        // load saved stories list on startup
        (async function init() {
            await displaySavedList();
        })();

    </script>
</body>

</html>