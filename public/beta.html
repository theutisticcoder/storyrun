<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PacePulse: AI Run-Narrator</title>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Third-party libs -->
    <script src="https://cdn.jsdelivr.net/npm/localforage@1.10.0/dist/localforage.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jepub@2.1.4/dist/jepub.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;500;700&family=Lora:ital,wght@0,400;1,400&display=swap');

        body {
            font-family: 'Space Grotesk', sans-serif;
        }

        .prose-font {
            font-family: 'Lora', serif;
        }

        .speed-glow {
            transition: text-shadow 0.3s ease;
        }

        .speed-high {
            text-shadow: 0 0 20px #ef4444;
            color: #ef4444;
        }

        .speed-med {
            text-shadow: 0 0 20px #f59e0b;
            color: #f59e0b;
        }

        .speed-low {
            text-shadow: 0 0 20px #10b981;
            color: #10b981;
        }

        .loading-shimmer {
            background: linear-gradient(90deg, #1f2937 25%, #374151 50%, #1f2937 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }

        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
    </style>
</head>

<body class="bg-gray-950 text-gray-100 min-h-screen flex flex-col">

    <!-- Header & Dashboard -->
    <header class="p-6 border-b border-gray-800 bg-gray-900/50 backdrop-blur-md sticky top-0 z-50">
        <div class="max-w-6xl mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
            <h1 class="text-2xl font-bold tracking-tighter italic">PACE<span class="text-red-500">PULSE</span></h1>
            
            <div class="grid grid-cols-2 md:grid-cols-4 gap-6 items-center w-full md:w-auto">
                <div class="text-center md:text-right border-r border-gray-800 pr-4 last:border-0 last:pr-0">
                    <p class="text-[10px] uppercase text-gray-400 tracking-wider">Speed</p>
                    <p id="speed-display" class="text-2xl font-bold speed-low">0.0 <span class="text-xs font-normal text-gray-500">m/s</span></p>
                </div>
                
                <div class="text-center md:text-right border-r border-gray-800 pr-4 last:border-0 last:pr-0">
                    <p class="text-[10px] uppercase text-gray-400 tracking-wider">Distance</p>
                    <p id="distance-display" class="text-2xl font-bold text-gray-200">0.00 <span class="text-xs font-normal text-gray-500">km</span></p>
                </div>

                <div class="text-center md:text-right border-r border-gray-800 pr-4 last:border-0 last:pr-0">
                    <p class="text-[10px] uppercase text-gray-400 tracking-wider">COâ‚‚ Saved</p>
                    <p id="emissions-display" class="text-2xl font-bold text-green-400">0 <span class="text-xs font-normal text-green-700">g</span></p>
                </div>

                <div class="text-center md:text-right">
                    <p class="text-[10px] uppercase text-gray-400 tracking-wider">Intensity</p>
                    <p id="intensity-display" class="text-xs font-medium text-gray-300 italic max-w-[100px] md:max-w-[150px] truncate">Waiting...</p>
                </div>
            </div>
        </div>
    </header>

    <main class="flex-grow p-4 md:p-8 max-w-4xl mx-auto w-full">
        <div id="error-toast" class="hidden bg-red-900/80 border border-red-500 p-4 rounded-xl mb-6 text-sm text-red-200"></div>

        <!-- Setup Form -->
        <section id="setup-panel" class="bg-gray-900 p-6 rounded-2xl border border-gray-800 shadow-2xl">
            <h2 class="text-xl font-semibold mb-4">Initialize Adventure</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm text-gray-400 mb-1">Gemini API Key</label>
                    <input type="password" id="api-key" placeholder="Enter your key..."
                        class="w-full bg-gray-800 border border-gray-700 rounded-lg p-3 focus:ring-2 focus:ring-red-500 outline-none">
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Genre</label>
                        <select id="genre" class="w-full bg-gray-800 border border-gray-700 rounded-lg p-3 outline-none">
                            <option>Cyberpunk Noir</option>
                            <option>Grimdark Fantasy</option>
                            <option>Psychological Thriller</option>
                            <option>Post-Apocalyptic Survival</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Custom Plot Hook</label>
                        <input type="text" id="plot" placeholder="e.g. A heist on a moon base..."
                            class="w-full bg-gray-800 border border-gray-700 rounded-lg p-3 outline-none">
                    </div>
                </div>

                <button id="start-btn" class="w-full bg-red-600 hover:bg-red-500 text-white font-bold py-4 rounded-xl transition-all transform hover:scale-[1.02] active:scale-95">
                    START WORKOUT & GENERATE
                </button>

                <div id="saved-stories-section" class="mt-4">
                    <h3 class="text-sm text-gray-400 mb-2 uppercase">Saved Stories</h3>
                    <div id="saved-list" class="space-y-2 text-sm text-gray-300"></div>
                </div>
            </div>
        </section>

        <!-- Story Display -->
        <section id="story-panel" class="hidden mt-8 space-y-8 pb-24">
            <div id="loading-indicator" class="hidden space-y-3">
                <div class="h-4 w-3/4 loading-shimmer rounded"></div>
                <div class="h-4 w-full loading-shimmer rounded"></div>
                <div class="h-4 w-5/6 loading-shimmer rounded"></div>
                <p class="text-xs text-gray-500 animate-pulse text-center pt-2">AI is analyzing your rhythm...</p>
            </div>
            <div id="chapters-container" class="space-y-12"></div>
        </section>
    </main>

    <!-- Controls Overlay -->
    <div id="player-controls" class="hidden fixed bottom-6 left-1/2 -translate-x-1/2 bg-gray-900 border border-gray-800 px-6 py-4 rounded-full shadow-2xl flex items-center gap-4 z-50 w-max max-w-[95vw]">
        <div id="workout-timer" class="font-mono text-xl tabular-nums">00:00</div>
        <div class="h-8 w-[1px] bg-gray-700"></div>
        <div id="manual-speed-ctrl" class="flex items-center gap-2">
            <input type="range" id="speed-slider" min="0" max="8" step="0.5" value="0"
                class="w-24 h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-red-500">
            <span class="text-xs text-gray-400">SIM</span>
        </div>
        <button id="end-run-btn" class="ml-4 bg-red-600/20 hover:bg-red-600/40 text-red-500 px-4 py-2 rounded-full text-sm font-bold border border-red-500/30 transition-colors">
            End Run & Export
        </button>
    </div>

    <script type="module">
        import { EdgeTTSClient, ProsodyOptions, OUTPUT_FORMAT } from 'https://cdn.jsdelivr.net/npm/edge-tts-client@1.0.2/+esm';

        let state = {
            active: false,
            apiKey: '',
            genre: '',
            plot: '',
            currentSpeed: 0,
            totalDistance: 0,
            startTime: null,
            timerId: null,
            chapters: [],
            fullStoryContext: '',
            isGenerating: false,
            usingSimulatedSpeed: true,
            lastPos: null,
            watchId: null,
            sessionId: null
        };

        const elements = {
            speed: document.getElementById('speed-display'),
            distance: document.getElementById('distance-display'),
            emissions: document.getElementById('emissions-display'),
            intensity: document.getElementById('intensity-display'),
            setup: document.getElementById('setup-panel'),
            story: document.getElementById('story-panel'),
            loading: document.getElementById('loading-indicator'),
            container: document.getElementById('chapters-container'),
            timer: document.getElementById('workout-timer'),
            controls: document.getElementById('player-controls'),
            startBtn: document.getElementById('start-btn'),
            error: document.getElementById('error-toast'),
            simSlider: document.getElementById('speed-slider'),
            savedList: document.getElementById('saved-list'),
            endRunBtn: document.getElementById('end-run-btn')
        };

        localforage.config({ name: 'pacepulse', storeName: 'stories' });

        function showError(msg) {
            elements.error.innerText = msg;
            elements.error.classList.remove('hidden');
            setTimeout(() => elements.error.classList.add('hidden'), 5000);
        }

        // Tracking Logic
        function setupTracking() {
            if (!("geolocation" in navigator)) return;
            state.watchId = navigator.geolocation.watchPosition(
                (pos) => {
                    state.usingSimulatedSpeed = false;
                    let distDelta = 0;
                    if (state.lastPos) {
                        const R = 6371000;
                        const dLat = (pos.coords.latitude - state.lastPos.lat) * Math.PI / 180;
                        const dLon = (pos.coords.longitude - state.lastPos.lon) * Math.PI / 180;
                        const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                                  Math.cos(state.lastPos.lat * Math.PI / 180) * Math.cos(pos.coords.latitude * Math.PI / 180) *
                                  Math.sin(dLon / 2) * Math.sin(dLon / 2);
                        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
                        distDelta = R * c;
                    }
                    if (distDelta > 0 && pos.coords.accuracy < 50) state.totalDistance += distDelta;
                    state.currentSpeed = pos.coords.speed || (distDelta / 1 || 0);
                    state.lastPos = { lat: pos.coords.latitude, lon: pos.coords.longitude };
                    updateUI();
                },
                null, { enableHighAccuracy: true }
            );
        }

        elements.simSlider.addEventListener('input', (e) => {
            state.usingSimulatedSpeed = true;
            state.currentSpeed = parseFloat(e.target.value);
            updateUI();
        });

        function updateUI() {
            const s = state.currentSpeed || 0;
            elements.speed.innerHTML = `${s.toFixed(1)} <span class="text-sm font-normal text-gray-500">m/s</span>`;
            
            const distKm = state.totalDistance / 1000;
            elements.distance.innerHTML = `${distKm.toFixed(2)} <span class="text-xs font-normal text-gray-500">km</span>`;
            
            const savedG = distKm * 250;
            elements.emissions.innerHTML = savedG < 1000 ? 
                `${Math.round(savedG)} <span class="text-xs font-normal text-green-700">g</span>` : 
                `${(savedG / 1000).toFixed(2)} <span class="text-xs font-normal text-green-700">kg</span>`;

            elements.speed.className = `text-2xl font-bold ${s > 4.5 ? 'speed-high' : s > 2.5 ? 'speed-med' : 'speed-low'}`;
            elements.intensity.innerText = s > 4.5 ? "CLIMAX" : s > 2.5 ? "RISING ACTION" : "EXPOSITION";
        }

        function startTimer() {
            state.startTime = Date.now();
            state.timerId = setInterval(() => {
                if (!state.active) return;
                const elapsed = Math.floor((Date.now() - state.startTime) / 1000);
                elements.timer.innerText = `${Math.floor(elapsed / 60).toString().padStart(2, '0')}:${(elapsed % 60).toString().padStart(2, '0')}`;
                
                if (state.usingSimulatedSpeed) {
                    state.totalDistance += state.currentSpeed;
                    updateUI();
                }

                if (elapsed > 0 && elapsed % 300 === 0) generateNewChapter();
            }, 1000);
        }

        async function generateNewChapter() {
            if (state.isGenerating) return;
            state.isGenerating = true;
            elements.loading.classList.remove('hidden');

            const style = state.currentSpeed > 4.5 ? "Urgent action, short sentences." : 
                          state.currentSpeed > 2.5 ? "Steady tension, rising stakes." : 
                          "Atmospheric, deep world-building.";

            const prompt = `Genre: ${state.genre}. Plot: ${state.plot}. Style: ${style}. Write Chapter ${state.chapters.length + 1} of a fictional story. Do not mention exercise. Context: ${state.fullStoryContext.slice(-1000)}`;

            try {
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${state.apiKey}`;
                const res = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const data = await res.json();
                const text = data.candidates[0].content.parts[0].text;
                
                state.chapters.push(text);
                state.fullStoryContext += `\n\nChapter ${state.chapters.length}: ${text}`;
                renderChapter(text, state.chapters.length);
                saveSession();
                speakChapter(text, state.chapters.length);
            } catch (e) {
                showError("AI Failed to respond.");
            } finally {
                state.isGenerating = false;
                elements.loading.classList.add('hidden');
            }
        }

        function renderChapter(text, num) {
            const div = document.createElement('div');
            div.className = "bg-gray-900/40 p-8 rounded-3xl border border-gray-800 shadow-lg";
            div.innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-red-500 font-bold uppercase text-sm">Chapter ${num}</h3>
                    <div id="audio-target-${num}" class="text-xs text-gray-500 italic">Synthesizing...</div>
                </div>
                <div class="prose-font text-lg text-gray-300 leading-relaxed">${text.replace(/\n/g, '<br>')}</div>
            `;
            elements.container.prepend(div);
        }

        async function speakChapter(text, num) {
            try {
                const client = new EdgeTTSClient();
                await client.setMetadata('en-US-AndrewMultilingualNeural', OUTPUT_FORMAT.AUDIO_24KHZ_48KBITRATE_MONO_MP3);
                const stream = client.toStream(text);
                let chunks = [];
                stream.on('data', c => chunks.push(c));
                stream.on('end', () => {
                    const url = URL.createObjectURL(new Blob(chunks, { type: 'audio/mp3' }));
                    const audio = document.createElement('audio');
                    audio.src = url;
                    audio.controls = true;
                    audio.className = "h-8 w-full mt-4";
                    document.getElementById(`audio-target-${num}`).innerHTML = '';
                    document.getElementById(`audio-target-${num}`).appendChild(audio);
                });
            } catch (e) {
                document.getElementById(`audio-target-${num}`).innerText = "TTS Failed";
            }
        }

        async function saveSession() {
            if (!state.sessionId) state.sessionId = `pulse-${Date.now()}`;
            const stories = await localforage.getItem('savedStories') || [];
            const story = {
                id: state.sessionId,
                title: `${state.genre} - ${new Date().toLocaleDateString()}`,
                chapters: state.chapters,
                genre: state.genre,
                plot: state.plot
            };
            const idx = stories.findIndex(s => s.id === state.sessionId);
            if (idx >= 0) stories[idx] = story; else stories.push(story);
            await localforage.setItem('savedStories', stories);
            loadSavedList();
        }

        async function loadSavedList() {
            const stories = await localforage.getItem('savedStories') || [];
            elements.savedList.innerHTML = stories.reverse().map(s => `
                <div class="flex justify-between items-center bg-gray-800/50 p-2 rounded">
                    <span class="truncate w-32">${s.title}</span>
                    <button onclick="window.loadStory('${s.id}')" class="text-red-500 text-xs font-bold">LOAD</button>
                </div>
            `).join('');
        }

        // Export using jEpub
        async function exportEpub() {
            if (state.chapters.length === 0) return showError("No story to export.");
            
            elements.endRunBtn.innerText = "Generating EPUB...";
            elements.endRunBtn.disabled = true;

            try {
                const jepub = new jEpub();
                
                // Set metadata
                jepub.init({
                    title: `${state.genre} Adventure`,
                    author: "PacePulse AI",
                    publisher: "PacePulse App",
                    description: state.plot
                });

                // Add chapters
                state.chapters.forEach((text, i) => {
                    jepub.add(`Chapter ${i + 1}`, text.replace(/\n/g, '<br/>'));
                });

                // Generate and download
                const content = await jepub.generate();
                const url = URL.createObjectURL(content);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${state.genre.replace(/\s/g, '_')}_Story.epub`;
                a.click();
            } catch (e) {
                showError("EPUB Export failed.");
                console.error(e);
            } finally {
                elements.endRunBtn.innerText = "End Run & Export";
                elements.endRunBtn.disabled = false;
            }
        }

        elements.startBtn.addEventListener('click', () => {
            const key = document.getElementById('api-key').value;
            if (!key) return showError("Need API Key");
            state.apiKey = key;
            state.genre = document.getElementById('genre').value;
            state.plot = document.getElementById('plot').value || "A mystery unfolds.";
            state.active = true;
            elements.setup.classList.add('hidden');
            elements.story.classList.remove('hidden');
            elements.controls.classList.remove('hidden');
            setupTracking();
            startTimer();
            generateNewChapter();
        });

        elements.endRunBtn.addEventListener('click', exportEpub);

        window.loadStory = async (id) => {
            const stories = await localforage.getItem('savedStories') || [];
            const s = stories.find(x => x.id === id);
            if (s) {
                state.chapters = s.chapters;
                state.genre = s.genre;
                state.plot = s.plot;
                elements.setup.classList.add('hidden');
                elements.story.classList.remove('hidden');
                elements.controls.classList.remove('hidden');
                elements.container.innerHTML = '';
                s.chapters.forEach((c, i) => renderChapter(c, i + 1));
            }
        };

        loadSavedList();
    </script>
</body>
</html>

