<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEURO-TRACK // Cyperpunk Audio Runner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=JetBrains+Mono:wght@300;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --neon-pink: #ff00ff;
            --neon-blue: #00f2ff;
            --neon-green: #00ff9f;
            --dark-bg: #030305;
        }

        body {
            background-color: var(--dark-bg);
            color: white;
            font-family: 'JetBrains Mono', monospace;
            overflow: scroll;
            height: 100vh;
        }

        .cyber-font { font-family: 'Orbitron', sans-serif; }

        .grid-bg {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-image: 
                linear-gradient(to right, rgba(0, 242, 255, 0.03) 1px, transparent 1px),
                linear-gradient(to bottom, rgba(0, 242, 255, 0.03) 1px, transparent 1px);
            background-size: 60px 60px;
            z-index: -1;
        }

        .neon-text-blue { text-shadow: 0 0 10px var(--neon-blue); color: var(--neon-blue); }
        .neon-text-pink { text-shadow: 0 0 10px var(--neon-pink); color: var(--neon-pink); }

        .progress-bar { height: 8px; background: #0a0a0a; border: 1px solid #222; position: relative; border-radius: 4px; overflow: scroll; }
        .progress-fill { 
            height: 100%; background: linear-gradient(90deg, var(--neon-blue), var(--neon-pink)); 
            width: 0%; transition: width 0.4s ease; 
            box-shadow: 0 0 20px var(--neon-blue); 
        }

        .btn-cyber {
            background: rgba(0, 255, 159, 0.05); border: 1px solid var(--neon-green); color: var(--neon-green);
            padding: 12px 20px; transition: all 0.3s;
            clip-path: polygon(5% 0, 100% 0, 100% 80%, 95% 100%, 0 100%, 0 20%);
            text-transform: uppercase; font-weight: bold; letter-spacing: 2px;
        }

        .btn-cyber:hover { background: var(--neon-green); color: black; box-shadow: 0 0 30px var(--neon-green); transform: scale(1.02); }

        .active-slot { 
            border-color: var(--neon-pink) !important; 
            background: rgba(255, 0, 255, 0.15) !important;
            animation: pulse-pink 1.5s infinite; 
        }

        @keyframes pulse-pink {
            0%, 100% { box-shadow: 0 0 5px var(--neon-pink); }
            50% { box-shadow: 0 0 25px var(--neon-pink); }
        }

        #virtual-map {
            width: 100%;
            height: 220px;
            background: rgba(0, 10, 10, 0.8);
            border: 1px solid rgba(0, 242, 255, 0.3);
            position: relative;
            margin-bottom: 1.5rem;
            overflow: scroll;
            box-shadow: inset 0 0 20px rgba(0, 242, 255, 0.2);
        }
        
        .map-label {
            position: absolute;
            top: 8px; left: 10px;
            font-size: 10px; color: var(--neon-blue);
            text-transform: uppercase; letter-spacing: 2px;
            pointer-events: none; opacity: 0.7;
        }

        .audio-wave {
            display: flex; gap: 2px; height: 12px; align-items: flex-end;
        }
        .wave-bar { width: 2px; background: var(--neon-green); animation: wave 1s infinite alternate; }
        @keyframes wave { from { height: 2px; } to { height: 12px; } }
    </style>
</head>
<body class="flex flex-col items-center justify-center p-4">
    <div class="grid-bg"></div>
    
    <header class="w-full max-w-lg mb-4 text-center z-10">
        <h1 class="cyber-font text-3xl font-bold tracking-[0.2em] neon-text-blue">NEURO-TRACK 3.0</h1>
        <div class="text-[10px] text-cyan-500 uppercase tracking-[0.4em] opacity-60">High-Velocity Neural Projection</div>
    </header>

    <main class="w-full max-w-lg bg-black/80 backdrop-blur-2xl p-6 rounded-md border border-white/5 relative z-10 shadow-2xl">
        <div id="virtual-map">
            <span class="map-label">Tactical Neural Projection // Path_Alpha</span>
            <canvas id="map-canvas"></canvas>
        </div>

        <div class="grid grid-cols-2 gap-4 mb-6">
            <div class="bg-white/5 p-3 border-l-2 border-cyan-500">
                <div class="text-[10px] text-cyan-400 mb-1 tracking-widest">KINETIC DISTANCE</div>
                <div id="distance-display" class="cyber-font text-4xl font-bold italic">0.00</div>
                <div class="text-[10px] text-gray-500">MILES</div>
            </div>
            <div class="bg-white/5 p-3 border-l-2 border-pink-500">
                <div class="text-[10px] text-pink-400 mb-1 tracking-widest">NEXT DECRYPT</div>
                <div id="next-milestone-text" class="cyber-font text-4xl font-bold italic">1.00</div>
                <div class="text-[10px] text-gray-500">MILES</div>
            </div>
        </div>

        <div class="mb-6">
            <div class="progress-bar">
                <div id="progress-fill" class="progress-fill"></div>
            </div>
        </div>

        <div class="grid grid-cols-3 gap-2 mb-6">
            <div id="slot-0" class="border border-white/10 bg-white/5 p-2 text-center text-[10px] font-bold truncate transition-all duration-500">A_NULL</div>
            <div id="slot-1" class="border border-white/10 bg-white/5 p-2 text-center text-[10px] font-bold truncate transition-all duration-500">B_NULL</div>
            <div id="slot-2" class="border border-white/10 bg-white/5 p-2 text-center text-[10px] font-bold truncate transition-all duration-500">C_NULL</div>
        </div>

        <!-- Enhanced Audio Player -->
        <div id="audio-container" class="border-t border-white/10 pt-6 mt-6 transition-all duration-700">
            <div class="flex items-center gap-4 mb-4">
                <div class="w-16 h-16 bg-green-500/10 flex items-center justify-center border border-green-500/30">
                    <div class="audio-wave">
                        <div class="wave-bar" style="animation-delay: 0.1s"></div>
                        <div class="wave-bar" style="animation-delay: 0.3s"></div>
                        <div class="wave-bar" style="animation-delay: 0.5s"></div>
                    </div>
                </div>
                <div class="flex-1 min-w-0">
                    <div id="audio-title" class="text-md font-bold truncate tracking-tight text-white">READY_SYSTEM</div>
                    <div id="audio-author" class="text-[11px] text-gray-400 uppercase tracking-widest">AWAITING_INPUT</div>
                    <div id="chapter-info" class="text-[10px] text-green-400 mt-1 font-bold italic">SIGNAL READY</div>
                </div>
            </div>
            <audio id="main-audio" controls class="w-full filter invert hue-rotate-180 opacity-90"></audio>
        </div>

        <div class="mt-6 flex flex-col gap-4">
            <div id="treadmill-controls" class="hidden treadmill-ui space-y-3 p-3 bg-white/5 border border-white/10">
                <div class="flex justify-between text-[11px] text-green-400 font-bold">
                    <span>VIRTUAL SPEED</span>
                    <span id="speed-val">6.0 MPH</span>
                </div>
                <input type="range" id="speed-slider" min="1" max="15" step="0.1" value="6" class="w-full h-1 bg-gray-800 rounded-lg appearance-none cursor-pointer">
            </div>

            <div class="flex gap-2">
                <button id="mode-toggle" class="flex-1 text-[11px] border border-white/20 p-3 hover:bg-white/5 transition-colors uppercase font-bold tracking-widest">TREADMILL MODE</button>
                <button id="start-btn" class="btn-cyber flex-[2]">BOOT NEURAL LINK</button>
            </div>
        </div>
    </main>

    <div id="console" class="w-full max-lg mt-4 bg-black/90 p-3 rounded-sm border border-white/5 text-[10px] font-mono text-green-500/70 h-24 overflow-y-auto z-10"></div>

    <script>
        const MASTER_LIBRARY = [
            { 
                title: "Journey to the Center of the Earth", 
                author: "Jules Verne", 
                chapters: Array.from({length: 44}, (_, i) => `https://ia800203.us.archive.org/21/items/journey_center_earth_rs_librivox/journey_center_earth_${String(i+1).padStart(2, '0')}_verne.mp3`)
            },
            { 
                title: "Frankenstein", 
                author: "Mary Shelley", 
                chapters: Array.from({length: 24}, (_, i) => `https://ia800204.us.archive.org/16/items/frankenstein_librivox/frankenstein_${String(i+1).padStart(2, '0')}_shelley.mp3`)
            },
            { 
                title: "The Time Machine", 
                author: "H.G. Wells", 
                chapters: Array.from({length: 12}, (_, i) => `https://ia800701.us.archive.org/11/items/time_machine_librivox/timemachine_${String(i+1).padStart(2, '0')}_wells.mp3`)
            },
            { 
                title: "The War of the Worlds",
                author: "H.G. Wells",
                chapters: Array.from({length: 27}, (_, i) => `https://ia800201.us.archive.org/26/items/war_of_the_worlds_librivox/waroftheworlds_${String(i+1).padStart(2, '0')}_wells.mp3`)
            }
        ];

        let state = {
            totalDistance: 0,
            isTracking: false,
            mode: 'gps',
            speed: 6.0,
            mileCounter: 0,
            activeStreams: [null, null, null],
            lastTimestamp: null,
            sessionPath: [] 
        };

        let watchId = null;
        let treadmillInterval = null;
        let mapContext = null;

        const el = {
            dist: document.getElementById('distance-display'),
            prog: document.getElementById('progress-fill'),
            startBtn: document.getElementById('start-btn'),
            console: document.getElementById('console'),
            milestone: document.getElementById('next-milestone-text'),
            audioPlayer: document.getElementById('main-audio'),
            modeBtn: document.getElementById('mode-toggle'),
            treadControls: document.getElementById('treadmill-controls'),
            speedVal: document.getElementById('speed-val'),
            speedSlider: document.getElementById('speed-slider'),
            audioTitle: document.getElementById('audio-title'),
            audioAuthor: document.getElementById('audio-author'),
            chapterInfo: document.getElementById('chapter-info'),
            mapCanvas: document.getElementById('map-canvas')
        };

        function addLog(msg) {
            const div = document.createElement('div');
            div.textContent = `> ${msg}`;
            el.console.prepend(div);
        }

        function initMap() {
            const container = document.getElementById('virtual-map');
            el.mapCanvas.width = container.clientWidth;
            el.mapCanvas.height = container.clientHeight;
            mapContext = el.mapCanvas.getContext('2d');
            if (state.sessionPath.length === 0) {
                state.sessionPath.push({x: el.mapCanvas.width/2, y: el.mapCanvas.height/2});
            }
            requestAnimationFrame(drawMap);
        }

        function drawMap() {
            if (!mapContext) return;
            const ctx = mapContext;
            const w = el.mapCanvas.width;
            const h = el.mapCanvas.height;

            ctx.fillStyle = 'rgba(0, 5, 5, 0.2)';
            ctx.fillRect(0, 0, w, h);

            // Path tracing
            if (state.sessionPath.length > 1) {
                ctx.beginPath();
                ctx.strokeStyle = '#00f2ff';
                ctx.lineWidth = 3;
                ctx.shadowBlur = 15;
                ctx.shadowColor = '#00f2ff';
                ctx.moveTo(state.sessionPath[0].x, state.sessionPath[0].y);
                for(let i=1; i < state.sessionPath.length; i++) {
                    ctx.lineTo(state.sessionPath[i].x, state.sessionPath[i].y);
                }
                ctx.stroke();
                ctx.shadowBlur = 0;
            }

            const head = state.sessionPath[state.sessionPath.length - 1];
            if (head) {
                ctx.fillStyle = '#ff00ff';
                ctx.beginPath(); ctx.arc(head.x, head.y, 6, 0, Math.PI * 2); ctx.fill();
                
                const pulse = (Date.now() % 1000) / 1000;
                ctx.strokeStyle = `rgba(255, 0, 255, ${1 - pulse})`;
                ctx.beginPath(); ctx.arc(head.x, head.y, 6 + (pulse * 20), 0, Math.PI * 2); ctx.stroke();
            }
            requestAnimationFrame(drawMap);
        }

        function updateMapPath(deltaDist) {
            const last = state.sessionPath[state.sessionPath.length - 1];
            // Increased multiplier for faster dot movement
            const step = deltaDist * 2500; 
            
            const angle = (Date.now() / 1500) + (Math.sin(Date.now() / 3000) * 0.8);
            let nextX = last.x + Math.cos(angle) * step;
            let nextY = last.y + Math.sin(angle) * step;

            // Bounce mechanics
            if (nextX < 10 || nextX > el.mapCanvas.width - 10) nextX = el.mapCanvas.width / 2;
            if (nextY < 10 || nextY > el.mapCanvas.height - 10) nextY = el.mapCanvas.height / 2;

            state.sessionPath.push({x: nextX, y: nextY});
            if (state.sessionPath.length > 800) state.sessionPath.shift();
        }

        async function saveState() {
            await localforage.setItem('neuro_track_state_v3', state);
        }

        async function loadState() {
            const saved = await localforage.getItem('neuro_track_state_v3');
            if (saved) {
                state = { ...state, ...saved };
                updateUI();
                state.activeStreams.forEach((s, i) => {
                    if(s) document.getElementById(`slot-${i}`).textContent = s.title.split(' ')[0].toUpperCase();
                });
            }
            initMap();
        }

        function triggerChapter(isTeaser = false) {
            if (!isTeaser) state.mileCounter++;
            
            const idx = isTeaser ? 0 : (state.mileCounter - 1) % 3;
            const stream = state.activeStreams[idx];

            document.querySelectorAll('[id^="slot-"]').forEach(s => s.classList.remove('active-slot'));
            document.getElementById(`slot-${idx}`).classList.add('active-slot');

            el.audioTitle.textContent = stream.title;
            el.audioAuthor.textContent = stream.author;
            el.chapterInfo.textContent = `ACTIVE_LINK: CH ${stream.currentChapter + 1} / ${stream.chapters.length}`;
            
            el.audioPlayer.src = stream.chapters[stream.currentChapter];
            
            if (!isTeaser) {
                el.audioPlayer.play().catch(() => addLog("INTERACTION REQ TO START AUDIO"));
                stream.currentChapter++;
                if(stream.currentChapter >= stream.chapters.length) {
                    state.activeStreams[idx] = pickBook();
                    document.getElementById(`slot-${idx}`).textContent = state.activeStreams[idx].title.split(' ')[0].toUpperCase();
                }
            } else {
                addLog(`TEASER INITIALIZED: ${stream.title}`);
            }
            saveState();
        }

        function pickBook() {
            const available = MASTER_LIBRARY.filter(b => !state.activeStreams.some(s => s && s.title === b.title));
            const b = available.length ? available[Math.floor(Math.random() * available.length)] : MASTER_LIBRARY[0];
            return { ...b, currentChapter: 0 };
        }

        function initStreams() {
            for(let i=0; i<3; i++) {
                state.activeStreams[i] = pickBook();
                document.getElementById(`slot-${i}`).textContent = state.activeStreams[i].title.split(' ')[0].toUpperCase();
            }
            addLog("NEURAL STREAMS SYNCED");
            triggerChapter(true); // Load first chapter teaser
        }

        function updateUI() {
            el.dist.textContent = state.totalDistance.toFixed(2);
            const progress = (state.totalDistance % 1) * 100;
            el.prog.style.width = `${progress}%`;
            el.milestone.textContent = (Math.floor(state.totalDistance) + 1).toFixed(2);

            if (state.totalDistance >= state.mileCounter + 1) {
                triggerChapter();
            }
        }

        function startTreadmill() {
            state.lastTimestamp = Date.now();
            treadmillInterval = setInterval(() => {
                const now = Date.now();
                const dt = (now - state.lastTimestamp) / 3600000; 
                const deltaDist = state.speed * dt;
                state.totalDistance += deltaDist;
                state.lastTimestamp = now;
                updateMapPath(deltaDist);
                updateUI();
            }, 100);
        }

        function toggle() {
            if (state.isTracking) {
                state.isTracking = false;
                el.startBtn.textContent = "BOOT NEURAL LINK";
                if (watchId) navigator.geolocation.clearWatch(watchId);
                if (treadmillInterval) clearInterval(treadmillInterval);
                addLog("SESSION TERMINATED");
                saveState();
            } else {
                if (!state.activeStreams[0]) initStreams();
                state.isTracking = true;
                el.startBtn.textContent = "DISCONNECT";
                if (state.mode === 'gps') {
                    watchId = navigator.geolocation.watchPosition(p => {
                        state.totalDistance += 0.0001; 
                        updateMapPath(0.0001);
                        updateUI(); 
                    }, null, {enableHighAccuracy: true});
                } else {
                    startTreadmill();
                }
                addLog("NEURAL SYNC ACTIVE");
            }
        }

        el.modeBtn.addEventListener('click', () => {
            if(state.isTracking) return;
            state.mode = state.mode === 'gps' ? 'treadmill' : 'gps';
            el.modeBtn.textContent = state.mode === 'gps' ? 'TREADMILL MODE' : 'GPS MODE';
            el.treadControls.classList.toggle('hidden', state.mode === 'gps');
            addLog(`SWAPPING INTERFACE: ${state.mode.toUpperCase()}`);
        });

        el.speedSlider.addEventListener('input', (e) => {
            state.speed = parseFloat(e.target.value);
            el.speedVal.textContent = `${state.speed.toFixed(1)} MPH`;
        });

        el.startBtn.addEventListener('click', toggle);
        window.onload = loadState;
        window.onresize = initMap;
    </script>
</body>
</html>

