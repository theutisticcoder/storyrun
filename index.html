<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MyEcoJourney</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- localForage -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js"></script>

  <!-- ResponsiveVoice (requires API key) -->
  <!-- IMPORTANT: Replace YOUR_API_KEY_HERE with your own key from https://responsivevoice.org/register -->
  <script src="https://code.responsivevoice.org/responsivevoice.js?key=YOUR_API_KEY_HERE"></script>

  <style>
    body {
      background: linear-gradient(135deg, #0f172a, #064e3b);
    }
    /* Reader Modal Styles */
    #readerModal::backdrop {
      background: rgba(0, 0, 0, 0.85);
    }
    .reader-text {
      line-height: 1.8;
      font-size: 1.1rem;
    }
  </style>
</head>
<body class="min-h-screen text-gray-100 flex flex-col items-center p-4">

  <header class="w-full max-w-4xl text-center mb-6">
    <h1 class="text-4xl font-bold text-green-300">üåç MyEcoJourney</h1>
    <p class="text-sm text-green-100 mt-2">Unlock free audiobooks by walking or choosing eco‚Äëfriendly travel</p>
  </header>

  <!-- Onboarding -->
  <section id="onboarding" class="w-full max-w-4xl bg-white/10 rounded-2xl p-6 shadow-xl hidden">
    <h2 class="text-2xl font-semibold mb-4">Choose Your First Adventures</h2>
    <p class="text-sm mb-4 text-gray-200">Select up to 3 fast‚Äëpaced public‚Äëdomain audiobooks, or let us surprise you.</p>

    <div id="bookOptions" class="grid md:grid-cols-3 gap-4"></div>

    <button id="randomPick" class="mt-4 bg-green-600 hover:bg-green-700 px-4 py-2 rounded-xl">üé≤ Random Picks</button>
    <button id="startJourney" class="mt-4 ml-2 bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-xl">Start My Journey</button>
  </section>

  <!-- Dashboard -->
  <section id="dashboard" class="w-full max-w-4xl bg-white/10 rounded-2xl p-6 shadow-xl hidden">
    <h2 class="text-2xl font-semibold mb-4">Your Eco Progress</h2>

    <div class="grid md:grid-cols-3 gap-4 mb-6" id="activeBooks"></div>

    <div class="bg-black/30 p-4 rounded-xl mb-4">
      <h3 class="font-semibold mb-2">Eco Tracking</h3>
      <div class="mb-3">
        <div class="flex justify-between text-xs text-gray-300 mb-1">
          <span>Distance Progress</span>
          <span id="distanceLabel">0.00 mi</span>
        </div>
        <div class="w-full bg-black/40 rounded-full h-3 overflow-hidden">
          <div id="distanceBar" class="h-full bg-green-500 transition-all duration-300" style="width:0%"></div>
        </div>
      </div>
      <div class="flex flex-wrap gap-2">
        <button onclick="startTracking('walk')" class="bg-green-600 px-3 py-2 rounded-lg hover:bg-green-500 transition">üö∂ Start Walk</button>
        <button onclick="startTracking('commute')" class="bg-blue-600 px-3 py-2 rounded-lg hover:bg-blue-500 transition">üöó Start Eco Commute</button>
        <button onclick="stopTracking()" class="bg-red-600 px-3 py-2 rounded-lg hover:bg-red-500 transition">‚èπ Stop</button>
      </div>
      <p id="trackingStatus" class="text-xs mt-2 text-gray-200"></p>
    </div>

    <!-- Updated Unlock Section: Now includes Audio and Written options -->
    <div id="unlockedChapter" class="hidden bg-green-900/40 p-4 rounded-xl border border-green-500/30">
      <h3 class="font-semibold">üéß New Chapter Unlocked!</h3>
      <p id="chapterInfo" class="text-sm mt-1 mb-3"></p>
      
      <div class="flex flex-wrap gap-2">
        <button id="playAudio" class="bg-green-600 px-4 py-2 rounded-lg hover:bg-green-500 transition flex items-center gap-2">
          <span>üîä Play Audio</span>
        </button>
        <!-- NEW: Written Chapter Button -->
        <button id="readChapter" class="bg-yellow-600 px-4 py-2 rounded-lg hover:bg-yellow-500 transition flex items-center gap-2">
          <span>üìñ Read Chapter</span>
        </button>
      </div>
    </div>
  </section>

  <!-- Written Chapter Reader Modal (New Feature) -->
  <dialog id="readerModal" class="w-full max-w-3xl bg-slate-900 text-gray-100 rounded-2xl p-0 shadow-2xl border border-slate-600">
    <div class="sticky top-0 bg-slate-800 p-4 flex justify-between items-center border-b border-slate-700 rounded-t-2xl z-10">
      <h3 id="readerTitle" class="font-bold text-lg text-yellow-400 truncate">Chapter Title</h3>
      <button onclick="closeReader()" class="bg-red-600 hover:bg-red-500 text-white px-3 py-1 rounded-full text-sm">Close</button>
    </div>
    <div id="readerContent" class="p-6 overflow-y-auto max-h-[70vh] reader-text">
      <!-- Text content will be injected here -->
    </div>
    <div class="p-4 bg-slate-800 border-t border-slate-700 rounded-b-2xl text-center text-sm text-gray-400">
      <button onclick="document.getElementById('readerModal').showModal()" class="text-yellow-400 underline">Need larger text?</button>
    </div>
  </dialog>

<script>
/*********************************
 * CONFIG
 *********************************/
const USE_RESPONSIVE_VOICE = typeof responsiveVoice !== 'undefined' && responsiveVoice.voiceSupport();

/*********************************
 * LIBRIVOX METADATA
 * Note: In a real app, 'textSample' would be fetched via API. 
 * Here we include sample text for the Written Feature demonstration.
 *********************************/
const LIBRIVOX_LIBRARY = [
  { 
    id: 1, 
    title: "The Count of Monte Cristo", 
    chapters: 3,
    sampleText: [
      "On the 24th of February, 1815, the look-out at Notre-Dame de la Garde signaled the three-master 'Pharaon' entering Marseilles.", 
      "The young man's face was pale, and he held himself with a tense energy, his eyes flashing with a fire that seemed at odds with his apparent weakness.",
      "Edmond Dant√®s stepped onto the dock, unaware that his life was about to change forever, entangled in a web of jealousy and betrayal."
    ]
  },
  { 
    id: 2, 
    title: "Treasure Island", 
    chapters: 3,
    sampleText: [
      "Squire Trelawney and Dr. Livesey had received a letter from Captain Billy Bones, requesting their presence.",
      "The old sea dog told of a map, a mark on the back of a bill of lading, pointing to hidden treasure.",
      "Young Jim Hawkins listened intently, the scent of salt and adventure filling the air of the Admiral Benbow inn."
    ]
  },
  { 
    id: 3, 
    title: "Frankenstein", 
    chapters: 3,
    sampleText: [
      "I am by birth a Genevese; and my family is one of the most distinguished of that republic.",
      "My imagination was vivid, and my taste exquisite; I loved nature with a passion that bordered on madness.",
      "The creation of life, once a subject of theoretical delight, now filled me with a dread that chilled my very bones."
    ]
  },
  { 
    id: 4, 
    title: "Dracula", 
    chapters: 3,
    sampleText: [
      "3 May. Bistritz. Left Munich at 8:35 P.M., on 1st May, arriving at Vienna early next morning.",
      "The carriage was filled with a strange silence, broken only by the rhythm of the horses' hooves.",
      "I saw no ashes, no earth, no grave‚Äîonly the impression of a heavy body lying in the coffin."
    ]
  },
  { 
    id: 5, 
    title: "Twenty Thousand Leagues Under the Seas", 
    chapters: 3,
    sampleText: [
      "The year 1866 was marked by a bizarre incident, a strange phenomenon observed at sea.",
      "A huge, elongated body, moving at great speed and emitting a phosphorescent light.",
      "Captain Nemo stood motionless, watching the abyss with eyes that seemed to pierce the deepest secrets of the ocean."
    ]
  },
  { 
    id: 6, 
    title: "The Three Musketeers", 
    chapters: 3,
    sampleText: [
      "On the first Monday of the month of April, 1625, the market town of Meung was in an uproar.",
      "D'Artagnan arrived in Paris with a heart full of ambition and a sword by his side.",
      "Three for one! It was the motto of the Musketeers, and D'Artagnan was determined to join them."
    ]
  },
  { 
    id: 7, 
    title: "The Invisible Man", 
    chapters: 3,
    sampleText: [
      "The stranger came early in February, one wintry day, through a biting wind and a driving snow.",
      "Bandages were wrapped around his head, hiding his features from the inquisitive eyes of the village.",
      "Science had stripped him of visibility, but it had not stripped him of the misery that comes with it."
    ]
  },
  { 
    id: 8, 
    title: "The Wendigo", 
    chapters: 3,
    sampleText: [
      "The swamp was a place of silence, broken only by the drone of insects and the distant call of birds.",
      "Demetris felt a chill that had nothing to do with the temperature, a sense of being watched.",
      "The shape in the trees was not a bear, nor a man‚Äîsomething else entirely."
    ]
  },
  { 
    id: 9, 
    title: "Journey to the Centre of the Earth", 
    chapters: 3,
    sampleText: [
      "My uncle, Professor Lidenbrock, was a man of infinite activity and limited patience.",
      "The manuscript, written in runes, led us to the Sn√¶fellsj√∂kull volcano.",
      "Beyond the burning surface of the earth, a world of mystery awaited in the depths."
    ]
  }
];

let state = {
  books: [],
  trackingMode: null,
  lastPosition: null, 
  distanceAccumulator: 0,
  totalDistance: 0 
};

localforage.config({ name: 'MyEcoJourney' });

/*********************************
 * INIT
 *********************************/
(async function init() {
  const saved = await localforage.getItem('state');
  if (saved) {
    // Merge saved state with potentially updated library structure
    state = saved;
    showDashboard();
  } else {
    showOnboarding();
  }
})();

function showOnboarding() {
  document.getElementById('onboarding').classList.remove('hidden');
  renderBookOptions();
}

function showDashboard() {
  document.getElementById('dashboard').classList.remove('hidden');
  renderDashboard();
}

/*********************************
 * ONBOARDING
 *********************************/
function renderBookOptions() {
  const container = document.getElementById('bookOptions');
  container.innerHTML = '';
  LIBRIVOX_LIBRARY.forEach(book => {
    const div = document.createElement('div');
    div.className = 'bg-black/30 p-4 rounded-xl';
    div.innerHTML = `
      <h3 class="font-semibold">${book.title}</h3>
      <p class="text-xs">${book.chapters} chapters</p>
      <input type="checkbox" value="${book.id}" class="mt-2" />
    `;
    container.appendChild(div);
  });
}

document.getElementById('randomPick').onclick = () => {
  state.books = shuffle([...LIBRIVOX_LIBRARY]).slice(0, 3).map(b => ({ ...b, current: 0 }));
  saveAndStart();
};

document.getElementById('startJourney').onclick = () => {
  const checked = [...document.querySelectorAll('#bookOptions input:checked')]
    .map(c => LIBRIVOX_LIBRARY.find(b => b.id == c.value));

  if (!checked.length) return alert('Pick at least one book!');
  state.books = shuffle(checked).slice(0, 3).map(b => ({ ...b, current: 0 }));
  saveAndStart();
};

function saveAndStart() {
    localforage.setItem('state', JSON.parse(JSON.stringify(state)));
  document.getElementById('onboarding').classList.add('hidden');
  showDashboard();
}

/*********************************
 * LIBRIVOX FETCH (Audio)
 *********************************/
async function fetchLibrivoxChapters(title) {
  try {
    const url = `https://librivox.org/api/feed/audiobooks?format=json&title=${encodeURIComponent(title)}`;
    const res = await fetch(url);
    const data = await res.json();
    if (!data.books?.length) return [];

    return data.books[0].sections.map(sec => ({
      title: sec.title,
      audioUrl: sec.listen_url
    }));
  } catch (e) {
    console.error("Fetch error", e);
    return [];
  }
}

/*********************************
 * DASHBOARD
 *********************************/
function renderDashboard() {
  const container = document.getElementById('activeBooks');
  container.innerHTML = '';
  state.books.forEach(book => {
    const div = document.createElement('div');
    div.className = 'bg-black/30 p-4 rounded-xl';
    div.innerHTML = `
      <h3 class="font-semibold">${book.title}</h3>
      <p class="text-sm">Chapter ${book.current} / ${book.chapters}</p>
    `;
    container.appendChild(div);
  });
}

function unlockChapter() {
  const eligible = state.books.filter(b => b.current < b.chapters);
  if (!eligible.length) return;

  // Pick a random book from eligible ones
  const book = eligible[Math.floor(Math.random() * eligible.length)];
  book.current++;
  renderDashboard();

  // Show unlocked section
  const unlockedDiv = document.getElementById('unlockedChapter');
  unlockedDiv.classList.remove('hidden');
  document.getElementById('chapterInfo').textContent = `${book.title} ‚Äî Chapter ${book.current}`;

  // Update Play Button
  const playBtn = document.getElementById('playAudio');
  playBtn.onclick = async () => {
    if (!book.chapterData) {
      book.chapterData = await fetchLibrivoxChapters(book.title);
      localforage.setItem('state', JSON.parse(JSON.stringify(state)));
    }

    const chapter = book.chapterData?.[book.current - 1];
    if (chapter?.audioUrl) {
      new Audio(chapter.audioUrl).play();
    } else if (USE_RESPONSIVE_VOICE) {
      responsiveVoice.speak(`Now playing ${book.title}, chapter ${book.current}`, 'UK English Male');
    } else {
      alert('Audio stream not available via API. In a production app, this would link to LibriVox directly.');
    }
  };

  // NEW: Update Read Button
  const readBtn = document.getElementById('readChapter');
  readBtn.onclick = () => {
    openReader(book);
  };
}

/*********************************
 * WRITTEN CHAPTER FEATURE
 *********************************/
function openReader(book) {
  const modal = document.getElementById('readerModal');
  const titleEl = document.getElementById('readerTitle');
  const contentEl = document.getElementById('readerContent');

  titleEl.textContent = `${book.title} - Chapter ${book.current}`;
  
  // Use local sample text. In production, fetch this from an API
  const chapterIndex = book.current - 1;
  let text = "";
  
  if (book.sampleText && book.sampleText[chapterIndex]) {
    text = book.sampleText[chapterIndex];
  } else if (book.current === 1) {
    text = "This is the beginning of your journey. Since we don't have the full text of this public domain book embedded for this demo, here is a placeholder describing the setting. Enjoy the readability!";
  } else {
    text = "This chapter text would normally be loaded from the server. Thank you for reading with MyEcoJourney.";
  }

  contentEl.innerHTML = `<p class="mb-4">${text}</p><p class="text-gray-400 italic text-sm">... (End of sample text) ...</p>`;
  modal.showModal();
}

function closeReader() {
  document.getElementById('readerModal').close();
}

// Close modal if clicking outside the content
document.getElementById('readerModal').addEventListener('click', (e) => {
  const rect = e.target.getBoundingClientRect();
  const isInDialog = (rect.top <= e.clientY && rect.bottom >= e.clientY && rect.left <= e.clientX && rect.right >= e.clientX);
  if (!isInDialog) {
    closeReader();
  }
});

/*********************************
 * TRACKING
 *********************************/
let watchId = null;

function startTracking(mode) {
  if (!navigator.geolocation) {
    alert('Geolocation not supported by your browser.');
    return;
  }

  state.trackingMode = mode;
  state.lastPosition = null;
  state.distanceAccumulator = 0; // Reset current session accumulator
  document.getElementById('trackingStatus').textContent = `Tracking started (${mode})`;

  watchId = navigator.geolocation.watchPosition(pos => {
    if (state.lastPosition) {
      const d = smoothDistance(haversine(state.lastPosition, pos.coords));
      state.distanceAccumulator += d;
      state.totalDistance += d;
      updateDistanceUI();

      // Thresholds: Walk (1 mile), Commute (5 miles)
      const threshold = mode === 'walk' ? 1 : 5;
      
      while (state.distanceAccumulator >= threshold) {
        state.distanceAccumulator -= threshold;
        unlockChapter();
      }
    }

    state.lastPosition = {
      latitude: pos.coords.latitude,
      longitude: pos.coords.longitude
    };
    localforage.setItem('state', JSON.parse(JSON.stringify(state)));
  }, (err) => {
      document.getElementById('trackingStatus').textContent = `Error: ${err.message}`;
  }, {
      enableHighAccuracy: true
  });
}

function stopTracking() {
  if (watchId) navigator.geolocation.clearWatch(watchId);
  watchId = null;
  document.getElementById('trackingStatus').textContent = 'Tracking stopped';
  // Note: we keep accumulated distance for the chapter unlock until next reset
}

let lastDistances = [];
function smoothDistance(d) {
  if (d > 0.1) return 0; // GPS spike rejection
  lastDistances.push(d);
  if (lastDistances.length > 5) lastDistances.shift();
  return lastDistances.reduce((a,b)=>a+b,0) / lastDistances.length;
}

function haversine(a, b) {
  const R = 3958.8; // miles
  const dLat = (b.latitude - a.latitude) * Math.PI / 180;
  const dLon = (b.longitude - a.longitude) * Math.PI / 180;
  const lat1 = a.latitude * Math.PI / 180;
  const lat2 = b.latitude * Math.PI / 180;

  const h = Math.sin(dLat / 2) ** 2 + Math.cos(lat1) * Math.cos(lat2) * Math.sin(dLon / 2) ** 2;
  return 2 * R * Math.asin(Math.sqrt(h));
}

function updateDistanceUI() {
  const threshold = state.trackingMode === 'commute' ? 5 : 1;
  const progress = Math.min((state.distanceAccumulator / threshold) * 100, 100);
  document.getElementById('distanceBar').style.width = progress + '%';
  document.getElementById('distanceLabel').textContent = state.distanceAccumulator.toFixed(2) + ' mi';
}

function shuffle(arr) {
  return arr.sort(() => Math.random() - 0.5);
}
</script>
</body>
</html>