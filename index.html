<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyJourneyAI - Cyberpunk Adventure Runner</title>
    <style>
        :root {
            --neon-cyan: #00ffff;
            --neon-pink: #ff0080;
            --neon-purple: #8b00ff;
            --dark-bg: #0a0a0a;
            --dark-secondary: #1a1a1a;
            --dark-tertiary: #2a2a2a;
            --text-primary: #ffffff;
            --text-secondary: #b0b0b0;
            --grid-glow: rgba(0, 255, 255, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background: var(--dark-bg);
            color: var(--text-primary);
            overflow-x: hidden;
            position: relative;
            min-height: 100vh;
        }

        /* Cyberpunk Grid Background */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(var(--grid-glow) 1px, transparent 1px),
                linear-gradient(90deg, var(--grid-glow) 1px, transparent 1px);
            background-size: 50px 50px;
            z-index: -1;
            opacity: 0.3;
        }

        /* Scanline Effect */
        body::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: repeating-linear-gradient(
                0deg,
                transparent,
                transparent 2px,
                rgba(0, 255, 255, 0.03) 2px,
                rgba(0, 255, 255, 0.03) 4px
            );
            z-index: -1;
            pointer-events: none;
        }

        .container {
            max-width: 100vw;
            margin: 0 auto;
            padding: 20px;
            padding-bottom: 120px;
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 30px;
            position: relative;
        }

        .title {
            font-size: 2.5rem;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 3px;
            background: linear-gradient(45deg, var(--neon-cyan), var(--neon-pink));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 30px var(--neon-cyan);
            animation: glitch 2s infinite;
        }

        @keyframes glitch {
            0%, 100% { text-shadow: 0 0 30px var(--neon-cyan); }
            25% { text-shadow: -2px 0 var(--neon-pink), 2px 0 var(--neon-cyan); }
            75% { text-shadow: 2px 0 var(--neon-pink), -2px 0 var(--neon-cyan); }
        }

        /* Dashboard Metrics */
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: var(--dark-secondary);
            border: 1px solid var(--neon-cyan);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .metric-card:hover {
            box-shadow: 0 0 20px var(--grid-glow);
            transform: translateY(-2px);
        }

        .metric-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--neon-cyan);
            text-shadow: 0 0 10px var(--neon-cyan);
        }

        .metric-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-top: 5px;
        }

        /* API Configuration Panel */
        .api-config {
            background: var(--dark-secondary);
            border: 1px solid var(--neon-pink);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .api-config h3 {
            color: var(--neon-pink);
            margin-bottom: 15px;
        }

        .api-input {
            width: 100%;
            background: var(--dark-tertiary);
            border: 1px solid var(--text-secondary);
            color: var(--text-primary);
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
            font-family: 'Courier New', monospace;
        }

        .api-input:focus {
            outline: none;
            border-color: var(--neon-cyan);
            box-shadow: 0 0 10px var(--grid-glow);
        }

        .api-status {
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            font-size: 0.9rem;
        }

        .api-status.connected {
            background: rgba(0, 255, 255, 0.2);
            border: 1px solid var(--neon-cyan);
            color: var(--neon-cyan);
        }

        .api-status.error {
            background: rgba(255, 0, 128, 0.2);
            border: 1px solid var(--neon-pink);
            color: var(--neon-pink);
        }

        .api-status.mock {
            background: rgba(139, 0, 255, 0.2);
            border: 1px solid var(--neon-purple);
            color: var(--neon-purple);
        }

        /* Speed Slider */
        .speed-control {
            background: var(--dark-secondary);
            border: 1px solid var(--neon-purple);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .slider-container {
            position: relative;
            margin: 20px 0;
        }

        .speed-slider {
            width: 100%;
            height: 8px;
            background: var(--dark-tertiary);
            border-radius: 4px;
            outline: none;
            -webkit-appearance: none;
            cursor: pointer;
        }

        .speed-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 25px;
            height: 25px;
            background: var(--neon-pink);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 15px var(--neon-pink);
            transition: all 0.3s ease;
        }

        .speed-slider::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            box-shadow: 0 0 25px var(--neon-pink);
        }

        .speed-display {
            text-align: center;
            font-size: 1.5rem;
            color: var(--neon-pink);
            margin-top: 10px;
            text-shadow: 0 0 10px var(--neon-pink);
        }

        /* Genre Selection */
        .genre-selection {
            background: var(--dark-secondary);
            border: 1px solid var(--neon-cyan);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .genre-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .genre-btn {
            background: var(--dark-tertiary);
            border: 1px solid var(--text-secondary);
            color: var(--text-primary);
            padding: 10px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            font-size: 0.9rem;
        }

        .genre-btn:hover {
            border-color: var(--neon-cyan);
            color: var(--neon-cyan);
            box-shadow: 0 0 10px var(--grid-glow);
        }

        .genre-btn.active {
            background: var(--neon-cyan);
            color: var(--dark-bg);
            border-color: var(--neon-cyan);
            box-shadow: 0 0 15px var(--neon-cyan);
        }

        /* Custom Plot Input */
        .custom-plot {
            margin-top: 15px;
        }

        .custom-plot input {
            width: 100%;
            background: var(--dark-tertiary);
            border: 1px solid var(--text-secondary);
            color: var(--text-primary);
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
        }

        .custom-plot input:focus {
            outline: none;
            border-color: var(--neon-cyan);
            box-shadow: 0 0 10px var(--grid-glow);
        }

        /* Control Buttons */
        .controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .btn {
            background: linear-gradient(45deg, var(--neon-purple), var(--neon-pink));
            border: none;
            color: white;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            position: relative;
            overflow: hidden;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(139, 0, 255, 0.5);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Story Feed */
        .story-feed {
            background: var(--dark-secondary);
            border: 1px solid var(--neon-purple);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            max-height: 60vh;
            overflow-y: auto;
            position: relative;
        }

        .story-feed::-webkit-scrollbar {
            width: 8px;
        }

        .story-feed::-webkit-scrollbar-track {
            background: var(--dark-tertiary);
            border-radius: 4px;
        }

        .story-feed::-webkit-scrollbar-thumb {
            background: var(--neon-cyan);
            border-radius: 4px;
        }

        .chapter {
            margin-bottom: 30px;
            padding: 20px;
            background: var(--dark-tertiary);
            border-radius: 10px;
            border-left: 3px solid var(--neon-cyan);
            position: relative;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .chapter-title {
            font-size: 1.5rem;
            color: var(--neon-pink);
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .chapter-text {
            line-height: 1.8;
            color: var(--text-primary);
            font-size: 1.1rem;
        }

        .chapter-text::first-letter {
            float: left;
            font-size: 4rem;
            line-height: 3rem;
            padding-right: 8px;
            padding-top: 4px;
            color: var(--neon-cyan);
            font-weight: bold;
            text-shadow: 0 0 10px var(--neon-cyan);
        }

        /* Loading Shimmer */
        .loading-shimmer {
            background: linear-gradient(90deg, var(--dark-tertiary) 25%, var(--dark-secondary) 50%, var(--dark-tertiary) 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            height: 20px;
            border-radius: 4px;
            margin: 10px 0;
        }

        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* Bottom Control Overlay */
        .bottom-overlay {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--dark-secondary);
            border-top: 1px solid var(--neon-cyan);
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }

        .timer-display {
            font-size: 1.5rem;
            color: var(--neon-cyan);
            text-shadow: 0 0 10px var(--neon-cyan);
        }

        .session-controls {
            display: flex;
            gap: 10px;
        }

        /* Saved Stories Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 2000;
            overflow-y: auto;
        }

        .modal-content {
            background: var(--dark-secondary);
            border: 1px solid var(--neon-cyan);
            border-radius: 10px;
            margin: 50px auto;
            padding: 30px;
            max-width: 90vw;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .close-btn {
            background: none;
            border: none;
            color: var(--neon-pink);
            font-size: 2rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .close-btn:hover {
            text-shadow: 0 0 10px var(--neon-pink);
        }

        .saved-story-item {
            background: var(--dark-tertiary);
            border: 1px solid var(--text-secondary);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .saved-story-item:hover {
            border-color: var(--neon-cyan);
            box-shadow: 0 0 15px var(--grid-glow);
        }

        .story-meta {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        /* Audio Player */
        .audio-player {
            margin-top: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .audio-controls {
            background: var(--neon-purple);
            border: none;
            color: white;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .title {
                font-size: 2rem;
            }
            
            .dashboard {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .controls {
                flex-direction: column;
                align-items: center;
            }
            
            .btn {
                width: 100%;
                max-width: 300px;
            }
            
            .bottom-overlay {
                flex-direction: column;
                gap: 15px;
            }
            
            .genre-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* GPS Status Indicator */
        .gps-status {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            background: var(--dark-secondary);
            padding: 10px 15px;
            border-radius: 20px;
            border: 1px solid var(--neon-cyan);
        }

        .gps-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--neon-cyan);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .gps-indicator.error {
            background: var(--neon-pink);
            animation: none;
        }

        /* Mode Toggle */
        .mode-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .mode-btn {
            background: var(--dark-tertiary);
            border: 1px solid var(--text-secondary);
            color: var(--text-primary);
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .mode-btn.active {
            background: var(--neon-cyan);
            color: var(--dark-bg);
            border-color: var(--neon-cyan);
        }
    </style>
<base target="_blank">
</head>
<body>
    <div class="gps-status">
        <div class="gps-indicator" id="gpsIndicator"></div>
        <span id="gpsStatus">GPS: Connecting...</span>
    </div>

    <div class="container">
        <div class="header">
            <h1 class="title">MyJourneyAI</h1>
            <p style="color: var(--text-secondary); margin-top: 10px;">Cyberpunk Adventure Runner</p>
        </div>

        <div class="dashboard">
            <div class="metric-card">
                <div class="metric-value" id="speedDisplay">0.0</div>
                <div class="metric-label">MPH</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="distanceDisplay">0.00</div>
                <div class="metric-label">Miles</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="co2Display">0.0</div>
                <div class="metric-label">CO‚ÇÇ Saved (lbs)</div>
            </div>
        </div>

        <!-- API Configuration Panel -->
        <div class="api-config">
            <h3>ü§ñ AI Service Configuration</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div>
                    <label style="color: var(--text-secondary); font-size: 0.9rem;">API Provider:</label>
                    <select id="apiProvider" class="api-input">
                        <option value="mistral">üîµ Mistral AI (Your Key)</option>
                        <option value="openrouter">üîó OpenRouter API</option>
                        <option value="google">üü¢ Google AI Studio</option>
                        <option value="openai">üü¢ OpenAI API</option>
                    </select>
                </div>
                <div>
                    <label style="color: var(--text-secondary); font-size: 0.9rem;">API Key:</label>
                    <input type="password" id="apiKey" class="api-input" placeholder="Enter your API key...">
                </div>
            </div>
            <div id="apiStatus" class="api-status mock">
            </div>
            <div style="margin-top: 15px; font-size: 0.8rem; color: var(--text-secondary);">
            </div>
        </div>

        <div class="speed-control">
            <h3 style="color: var(--neon-cyan); margin-bottom: 15px;">Speed Simulator</h3>
            <div class="slider-container">
                <input type="range" class="speed-slider" id="speedSlider" min="0" max="30" value="0" step="0.1">
                <div class="speed-display" id="sliderSpeed">0.0 MPH</div>
            </div>
        </div>

        <div class="genre-selection">
            <h3 style="color: var(--neon-cyan); margin-bottom: 15px;">Select Genre & Mode</h3>
            
            <div class="mode-toggle">
                <button class="mode-btn active" data-mode="normal">Normal Mode</button>
                <button class="mode-btn" data-mode="carpool">Carpool Mode</button>
            </div>

            <div class="genre-grid" id="genreGrid">
                <!-- Genres will be populated by JavaScript -->
            </div>
            
            <div class="custom-plot">
                <label style="color: var(--text-secondary);">Custom Plot (Optional):</label>
                <input type="text" id="customPlot" placeholder="Enter your custom story premise...">
            </div>
        </div>

        <div class="controls">
            <button class="btn" id="startBtn">Start Journey</button>
            <button class="btn" id="pauseBtn" disabled>Pause</button>
            <button class="btn" id="resumeBtn" disabled>Resume</button>
            <button class="btn" id="savedStoriesBtn">Saved Stories</button>
        </div>

        <div class="story-feed" id="storyFeed">
            <div style="text-align: center; color: var(--text-secondary); padding: 40px;">
                <p>üöÄ Configure your AI service and start your journey to begin the AI-generated adventure...</p>
            </div>
        </div>
    </div>

    <div class="bottom-overlay">
        <div class="timer-display" id="timerDisplay">00:00:00</div>
        <div class="session-controls">
            <button class="btn" id="saveSessionBtn" disabled>Save Session</button>
            <button class="btn" id="clearSessionBtn" disabled>Clear</button>
        </div>
    </div>

    <!-- Saved Stories Modal -->
    <div class="modal" id="savedStoriesModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 style="color: var(--neon-cyan);">Saved Stories</h2>
                <button class="close-btn" id="closeModal">&times;</button>
            </div>
            <div id="savedStoriesList"></div>
        </div>
    </div>

    <script>
        class MyJourneyAI {
            constructor() {
                this.currentSpeed = 0;
                this.totalDistance = 0;
                this.sessionTime = 0;
                this.isActive = false;
                this.isPaused = false;
                this.currentChapter = 0;
                this.lastChapterTime = 0;
                this.lastChapterDistance = 0;
                this.watchId = null;
                this.sessionId = null;
                this.currentStory = [];
                this.audioBlobs = [];
                this.selectedGenre = 'cyberpunk';
                this.customPlot = '';
                this.mode = 'normal';
                
                // AI Configuration
                this.apiProvider = 'mistral';
                this.apiKey = '';
                this.isApiConnected = false;
                
                // GPS tracking
                this.gpsSpeed = 0;
                this.lastPosition = null;
                this.lastPositionTime = null;
                
                // Initialize
                this.init();
            }

            init() {
                this.setupEventListeners();
                this.populateGenres();
                this.loadSavedStories();
                this.requestGPSPermission();
                this.startTimer();
                this.setupAIConfiguration();
            }

            setupAIConfiguration() {
                // Pre-fill Mistral AI key if provided
                const mistralKey = 'nUANEOGN4al5gS7pKPtu391tBxnVkfUQ';
                
                // Load saved API configuration
                const savedConfig = localStorage.getItem('myJourneyAIConfig');
                if (savedConfig) {
                    const config = JSON.parse(savedConfig);
                    document.getElementById('apiProvider').value = config.provider || 'mistral';
                    document.getElementById('apiKey').value = config.key || mistralKey;
                    this.apiProvider = config.provider || 'mistral';
                    this.apiKey = config.key || mistralKey;
                } else {
                    // Pre-fill Mistral key for convenience
                    document.getElementById('apiKey').value = mistralKey;
                    this.apiKey = mistralKey;
                }

                // Set up API provider change listener
                document.getElementById('apiProvider').addEventListener('change', (e) => {
                    this.apiProvider = e.target.value;
                    this.updateAPIStatus();
                    this.saveAPIConfig();
                });

                document.getElementById('apiKey').addEventListener('input', (e) => {
                    this.apiKey = e.target.value;
                    this.saveAPIConfig();
                });

                this.updateAPIStatus();
            }

            saveAPIConfig() {
                const config = {
                    provider: this.apiProvider,
                    key: this.apiKey
                };
                localStorage.setItem('myJourneyAIConfig', JSON.stringify(config));
            }

            updateAPIStatus() {
                const statusDiv = document.getElementById('apiStatus');
                if (!this.apiKey) {
                    statusDiv.className = 'api-status error';
                    statusDiv.innerHTML = `‚ùå Please enter your API key for ${this.apiProvider}`;
                    this.isApiConnected = false;
                } else if (this.apiProvider === 'mistral' && this.apiKey === 'nUANEOGN4al5gS7pKPtu391tBxnVkfUQ') {
                    statusDiv.className = 'api-status connected';
                    statusDiv.innerHTML = `‚úÖ Mistral AI configured with your key!`;
                    this.isApiConnected = true;
                } else {
                    statusDiv.className = 'api-status connected';
                    statusDiv.innerHTML = `‚úÖ ${this.apiProvider} configured and ready!`;
                    this.isApiConnected = true;
                }
            }

            setupEventListeners() {
                // Speed slider
                document.getElementById('speedSlider').addEventListener('input', (e) => {
                    this.updateSliderSpeed(parseFloat(e.target.value));
                });

                // Control buttons
                document.getElementById('startBtn').addEventListener('click', () => this.startJourney());
                document.getElementById('pauseBtn').addEventListener('click', () => this.pauseJourney());
                document.getElementById('resumeBtn').addEventListener('click', () => this.resumeJourney());
                document.getElementById('savedStoriesBtn').addEventListener('click', () => this.showSavedStories());
                document.getElementById('saveSessionBtn').addEventListener('click', () => this.saveSession());
                document.getElementById('clearSessionBtn').addEventListener('click', () => this.clearSession());

                // Modal
                document.getElementById('closeModal').addEventListener('click', () => this.hideSavedStories());
                document.getElementById('savedStoriesModal').addEventListener('click', (e) => {
                    if (e.target.id === 'savedStoriesModal') this.hideSavedStories();
                });

                // Genre selection
                document.getElementById('genreGrid').addEventListener('click', (e) => {
                    if (e.target.classList.contains('genre-btn')) {
                        document.querySelectorAll('.genre-btn').forEach(btn => btn.classList.remove('active'));
                        e.target.classList.add('active');
                        this.selectedGenre = e.target.dataset.genre;
                    }
                });

                // Mode toggle
                document.querySelectorAll('.mode-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
                        e.target.classList.add('active');
                        this.mode = e.target.dataset.mode;
                    });
                });

                // Custom plot
                document.getElementById('customPlot').addEventListener('input', (e) => {
                    this.customPlot = e.target.value;
                });
            }

            populateGenres() {
                const genres = [
                    'Cyberpunk', 'Dystopian', 'Post-Apocalyptic', 'Space Opera', 'Urban Fantasy',
                    'Noir Mystery', 'Psychological Thriller', 'Supernatural Horror', 'Steampunk', 'Biopunk',
                    'Nanopunk', 'Solarpunk', 'Atompunk', 'Clockpunk', 'Mythpunk',
                    'Dreampunk', 'Sandalpunk', 'Stonepunk', 'Bronzepunk', 'Ironpunk'
                ];

                const genreGrid = document.getElementById('genreGrid');
                genres.forEach(genre => {
                    const btn = document.createElement('button');
                    btn.className = 'genre-btn';
                    btn.dataset.genre = genre.toLowerCase().replace(/\s+/g, '-');
                    btn.textContent = genre;
                    if (genre === 'Cyberpunk') btn.classList.add('active');
                    genreGrid.appendChild(btn);
                });
            }

            async requestGPSPermission() {
                if ('geolocation' in navigator) {
                    try {
                        const position = await new Promise((resolve, reject) => {
                            navigator.geolocation.getCurrentPosition(resolve, reject);
                        });
                        this.updateGPSStatus('Connected', true);
                        this.startGPSTracking();
                    } catch (error) {
                        this.updateGPSStatus('Permission Denied', false);
                        console.log('GPS permission denied, using manual slider');
                    }
                } else {
                    this.updateGPSStatus('Not Available', false);
                }
            }

            startGPSTracking() {
                if (this.watchId) return;

                this.watchId = navigator.geolocation.watchPosition(
                    (position) => this.handleGPSUpdate(position),
                    (error) => this.handleGPSError(error),
                    {
                        enableHighAccuracy: true,
                        timeout: 5000,
                        maximumAge: 0
                    }
                );
            }

            handleGPSUpdate(position) {
                const currentTime = Date.now();
                
                if (this.lastPosition && this.lastPositionTime) {
                    const timeDiff = (currentTime - this.lastPositionTime) / 1000 / 3600; // hours
                    const distance = this.calculateDistance(
                        this.lastPosition.latitude,
                        this.lastPosition.longitude,
                        position.coords.latitude,
                        position.coords.longitude
                    );
                    
                    if (timeDiff > 0) {
                        this.gpsSpeed = distance / timeDiff; // mph
                        if (this.isActive && !this.isPaused) {
                            this.updateSpeed(this.gpsSpeed);
                            this.totalDistance += distance;
                            this.updateDisplay();
                        }
                    }
                }
                
                this.lastPosition = {
                    latitude: position.coords.latitude,
                    longitude: position.coords.longitude
                };
                this.lastPositionTime = currentTime;
            }

            handleGPSError(error) {
                console.error('GPS Error:', error);
                this.updateGPSStatus('Error', false);
            }

            calculateDistance(lat1, lon1, lat2, lon2) {
                const R = 3959; // Earth's radius in miles
                const dLat = (lat2 - lat1) * Math.PI / 180;
                const dLon = (lon2 - lon1) * Math.PI / 180;
                const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                          Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                          Math.sin(dLon/2) * Math.sin(dLon/2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                return R * c;
            }

            updateGPSStatus(status, connected) {
                document.getElementById('gpsStatus').textContent = `GPS: ${status}`;
                const indicator = document.getElementById('gpsIndicator');
                indicator.classList.toggle('error', !connected);
            }

            updateSliderSpeed(speed) {
                document.getElementById('sliderSpeed').textContent = `${speed.toFixed(1)} MPH`;
                if (!this.isActive || this.isPaused) {
                    this.updateSpeed(speed);
                }
            }

            updateSpeed(speed) {
                this.currentSpeed = speed;
                this.updateDisplay();
                this.checkChapterTrigger();
            }

            updateDisplay() {
                document.getElementById('speedDisplay').textContent = this.currentSpeed.toFixed(1);
                document.getElementById('distanceDisplay').textContent = this.totalDistance.toFixed(2);
                
                // CO2 saved calculation (approximate: 0.9 lbs per mile for car vs walking/running)
                const co2Saved = this.totalDistance * 0.9;
                document.getElementById('co2Display').textContent = co2Saved.toFixed(1);
            }

            checkChapterTrigger() {
                const timeSinceLastChapter = this.sessionTime - this.lastChapterTime;
                const distanceSinceLastChapter = this.totalDistance - this.lastChapterDistance;
                
                let shouldTrigger = false;
                
                if (this.mode === 'normal') {
                    // Normal mode: 10 minutes or 1 mile
                    if (timeSinceLastChapter >= 600 || distanceSinceLastChapter >= 1) {
                        shouldTrigger = true;
                    }
                } else if (this.mode === 'carpool') {
                    // Carpool mode: 5-10 miles
                    if (distanceSinceLastChapter >= 5 && Math.random() < 0.3) {
                        shouldTrigger = true;
                    } else if (distanceSinceLastChapter >= 10) {
                        shouldTrigger = true;
                    }
                }
                
                if (shouldTrigger && this.isActive && !this.isPaused) {
                    this.generateChapter();
                    this.lastChapterTime = this.sessionTime;
                    this.lastChapterDistance = this.totalDistance;
                }
            }

            async generateChapter() {
                if (!this.isApiConnected) {
                    this.displayError('Please configure your AI service first!');
                    return;
                }

                const intensity = this.getIntensityLevel();
                const stylePrompt = this.getStylePrompt(intensity);
                const genrePrompt = this.getGenrePrompt();
                
                const prompt = `
                    ${stylePrompt}
                    ${genrePrompt}
                    ${this.customPlot ? `Custom Plot: ${this.customPlot}` : ''}
                    
                    Previous Context: ${this.currentStory.length > 0 ? this.currentStory.slice(-3).map(c => c.text).join(' ') : 'Beginning of adventure'}
                    
                    Generate a 15-paragraph chapter in strict second-person perspective ("you"). 
                    Avoid any meta-references to exercise, running, walking, speed, or physical activity.
                    Maintain immersive narrative continuity.
                    Make the chapter approximately 500-700 words.
                `;

                try {
                    // Show loading shimmer
                    this.showLoadingChapter();
                    
                    // Generate story based on selected provider
                    let chapterText;
                    if (this.apiProvider === 'mistral') {
                        chapterText = await this.callMistralAPI(prompt);
                    } else {
                        chapterText = await this.callAIAPI(prompt);
                    }
                    
                    // Create chapter object
                    const chapter = {
                        id: Date.now(),
                        number: this.currentChapter + 1,
                        text: chapterText,
                        intensity: intensity,
                        timestamp: new Date().toISOString()
                    };
                    
                    // Add to story
                    this.currentStory.push(chapter);
                    this.currentChapter++;
                    
                    // Generate audio
                    const audioBlob = await this.generateAudio(chapterText);
                    this.audioBlobs.push(audioBlob);
                    
                    // Display chapter
                    this.displayChapter(chapter, audioBlob);
                    
                } catch (error) {
                    console.error('Error generating chapter:', error);
                    this.displayError(`Failed to generate chapter: ${error.message}`);
                }
            }

            async callMistralAPI(prompt) {
                // Direct Mistral AI API integration
                const response = await fetch('https://api.mistral.ai/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${this.apiKey}`,
                        'Content-Type': 'application/json',
                        'HTTP-Referer': window.location.href,
                        'X-Title': 'MyJourneyAI'
                    },
                    body: JSON.stringify({
                        model: 'mistral-tiny', // You can also use 'mistral-small', 'mistral-medium', or 'mistral-large'
                        messages: [
                            {
                                role: 'system',
                                content: 'You are a creative writing AI that generates immersive second-person narrative chapters. Write in a cyberpunk, atmospheric style.'
                            },
                            {
                                role: 'user',
                                content: prompt
                            }
                        ],
                        max_tokens: 1500,
                        temperature: 0.8,
                        top_p: 0.9,
                        stream: false
                    })
                });

                if (!response.ok) {
                    throw new Error(`Mistral API call failed: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                return data.choices[0].message.content;
            }

           
            getIntensityLevel() {
                if (this.currentSpeed < 3) return 'walking';
                if (this.currentSpeed < 6) return 'jogging';
                if (this.currentSpeed < 12) return 'running';
                return 'sprinting';
            }

            getStylePrompt(intensity) {
                const styles = {
                    walking: 'Write in a atmospheric, descriptive, contemplative style. Focus on sensory details and internal monologue. Pace is slow and meditative.',
                    jogging: 'Write in a steady, rhythmic style. Balance description with action. Maintain forward momentum in narrative.',
                    running: 'Write in a dynamic, energetic style. Increase action and dialogue. Quick scene transitions.',
                    sprinting: 'Write in a punchy, high-tension style. Short sentences. Immediate danger or urgency. Minimal description, maximum impact.'
                };
                return styles[intensity] || styles.walking;
            }

            getGenrePrompt() {
                const genrePrompts = {
                    'cyberpunk': 'Cyberpunk setting with neon-lit cities, hackers, AI, and corporate dystopia.',
                    'dystopian': 'Dystopian world with oppressive regimes, survival themes, and resistance movements.',
                    'post-apocalyptic': 'Post-apocalyptic wasteland with scattered survivors, mutated creatures, and scarce resources.',
                    'space-opera': 'Epic space adventure with starships, alien civilizations, and cosmic threats.',
                    'urban-fantasy': 'Modern city hidden with magical creatures, secret societies, and supernatural mysteries.',
                    'noir-mystery': 'Dark noir setting with detectives, femme fatales, and complex conspiracies.',
                    'psychological-thriller': 'Mind-bending thriller with unreliable narrators and psychological manipulation.',
                    'supernatural-horror': 'Horror story with ghosts, demons, and otherworldly terrors.',
                    'steampunk': 'Victorian-era technology powered by steam, gears, and clockwork mechanisms.',
                    'biopunk': 'Biotechnology-dominated world with genetic engineering and organic technology.',
                    'nanopunk': 'Nanotechnology society with microscopic machines and molecular manipulation.',
                    'solarpunk': 'Eco-friendly future with renewable energy and harmonious technology.',
                    'atompunk': 'Atomic-age retrofuture with nuclear power and space-age aesthetics.',
                    'clockpunk': 'Renaissance-era technology based on intricate clockwork mechanisms.',
                    'mythpunk': 'Modern world infused with ancient mythology and legendary creatures.',
                    'dreampunk': 'Surreal dreamscape reality where dreams and nightmares manifest.',
                    'sandalpunk': 'Ancient world with advanced bronze-age technology.',
                    'stonepunk': 'Stone-age civilization with surprisingly sophisticated stone-based technology.',
                    'bronzepunk': 'Bronze-age society with metallurgical mastery and early machinery.',
                    'ironpunk': 'Iron-age culture with heavy metal industry and steam precursors.'
                };
                return genrePrompts[this.selectedGenre] || genrePrompts['cyberpunk'];
            }

            showLoadingChapter() {
                const storyFeed = document.getElementById('storyFeed');
                const loadingDiv = document.createElement('div');
                loadingDiv.className = 'chapter';
                loadingDiv.id = 'loadingChapter';
                loadingDiv.innerHTML = `
                    <div class="chapter-title" style="color: var(--neon-cyan);">üîµ Mistral AI Generating Chapter ${this.currentChapter + 1}...</div>
                    <div class="loading-shimmer" style="height: 30px;"></div>
                    <div class="loading-shimmer" style="height: 20px;"></div>
                    <div class="loading-shimmer" style="height: 20px;"></div>
                    <div class="loading-shimmer" style="height: 20px;"></div>
                    <div class="loading-shimmer" style="height: 20px;"></div>
                `;
                storyFeed.appendChild(loadingDiv);
                storyFeed.scrollTop = storyFeed.scrollHeight;
            }

            displayChapter(chapter, audioBlob) {
                // Remove loading chapter
                const loadingChapter = document.getElementById('loadingChapter');
                if (loadingChapter) {
                    loadingChapter.remove();
                }

                const storyFeed = document.getElementById('storyFeed');
                const chapterDiv = document.createElement('div');
                chapterDiv.className = 'chapter';
                chapterDiv.innerHTML = `
                    <div class="chapter-title">Chapter ${chapter.number}</div>
                    <div class="chapter-text">${this.formatChapterText(chapter.text)}</div>
                    <div class="audio-player">
                        <button class="audio-controls" onclick="this.nextElementSibling.play()">‚ñ∂ Play</button>
                        <button class="audio-controls" onclick="this.nextElementSibling.pause()">‚è∏ Pause</button>
                        <audio controls style="flex: 1; margin-left: 10px;">
                            <source src="${URL.createObjectURL(audioBlob)}" type="audio/wav">
                        </audio>
                    </div>
                `;
                storyFeed.appendChild(chapterDiv);
                storyFeed.scrollTop = storyFeed.scrollHeight;
            }

            formatChapterText(text) {
                // Clean up and format the chapter text
                return text
                    .split('\n\n')
                    .filter(p => p.trim().length > 0)
                    .map(p => `<p style="margin-bottom: 15px;">${p.trim()}</p>`)
                    .join('');
            }

            displayError(message) {
                const storyFeed = document.getElementById('storyFeed');
                const errorDiv = document.createElement('div');
                errorDiv.className = 'chapter';
                errorDiv.innerHTML = `
                    <div style="color: var(--neon-pink); text-align: center; padding: 20px;">
                        <p>‚ùå ${message}</p>
                    </div>
                `;
                storyFeed.appendChild(errorDiv);
            }

            startJourney() {
                if (this.isActive) return;
                
                if (!this.isApiConnected) {
                    this.displayError('Please configure your AI service first!');
                    return;
                }
                
                this.isActive = true;
                this.isPaused = false;
                this.sessionId = Date.now().toString();
                this.sessionTime = 0;
                this.totalDistance = 0;
                this.currentChapter = 0;
                this.currentStory = [];
                this.audioBlobs = [];
                this.lastChapterTime = 0;
                this.lastChapterDistance = 0;
                
                // Update UI
                document.getElementById('startBtn').disabled = true;
                document.getElementById('pauseBtn').disabled = false;
                document.getElementById('saveSessionBtn').disabled = false;
                document.getElementById('clearSessionBtn').disabled = false;
                document.getElementById('storyFeed').innerHTML = '';
                
                // Generate first chapter
                this.generateChapter();
            }

            pauseJourney() {
                if (!this.isActive || this.isPaused) return;
                
                this.isPaused = true;
                document.getElementById('pauseBtn').disabled = true;
                document.getElementById('resumeBtn').disabled = false;
            }

            resumeJourney() {
                if (!this.isActive || !this.isPaused) return;
                
                this.isPaused = false;
                document.getElementById('pauseBtn').disabled = false;
                document.getElementById('resumeBtn').disabled = true;
            }

            clearSession() {
                if (!this.isActive) return;
                
                this.isActive = false;
                this.isPaused = false;
                this.sessionTime = 0;
                this.totalDistance = 0;
                this.currentChapter = 0;
                this.currentStory = [];
                this.audioBlobs = [];
                
                // Update UI
                document.getElementById('startBtn').disabled = false;
                document.getElementById('pauseBtn').disabled = true;
                document.getElementById('resumeBtn').disabled = true;
                document.getElementById('saveSessionBtn').disabled = true;
                document.getElementById('clearSessionBtn').disabled = true;
                document.getElementById('storyFeed').innerHTML = `
                    <div style="text-align: center; color: var(--text-secondary); padding: 40px;">
                        <p>üöÄ Configure your AI service and start your journey to begin the AI-generated adventure...</p>
                    </div>
                `;
                
                this.updateDisplay();
            }

            saveSession() {
                if (this.currentStory.length === 0) return;
                
                const sessionData = {
                    id: this.sessionId,
                    timestamp: new Date().toISOString(),
                    genre: this.selectedGenre,
                    customPlot: this.customPlot,
                    mode: this.mode,
                    totalDistance: this.totalDistance,
                    sessionTime: this.sessionTime,
                    chapters: this.currentStory,
                    audioBlobs: this.audioBlobs.map(blob => blob ? blob.size : 0) // Store size reference
                };
                
                // Save to localStorage
                let savedStories = JSON.parse(localStorage.getItem('myJourneyAIStories') || '[]');
                savedStories.unshift(sessionData);
                localStorage.setItem('myJourneyAIStories', JSON.stringify(savedStories));
                
                // Show success message
                this.showNotification('Session saved successfully! üéâ', 'success');
                this.loadSavedStories();
            }

            showNotification(message, type = 'info') {
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: ${type === 'success' ? 'var(--neon-cyan)' : 'var(--neon-pink)'};
                    color: var(--dark-bg);
                    padding: 15px 20px;
                    border-radius: 5px;
                    z-index: 3000;
                    font-weight: bold;
                    animation: slideIn 0.3s ease;
                `;
                notification.textContent = message;
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.remove();
                }, 3000);
            }

            loadSavedStories() {
                const savedStories = JSON.parse(localStorage.getItem('myJourneyAIStories') || '[]');
                const listContainer = document.getElementById('savedStoriesList');
                
                if (savedStories.length === 0) {
                    listContainer.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">No saved stories yet.</p>';
                    return;
                }
                
                listContainer.innerHTML = savedStories.map(story => `
                    <div class="saved-story-item" onclick="myJourneyAI.loadStory('${story.id}')">
                        <div class="story-meta">
                            <span>${new Date(story.timestamp).toLocaleDateString()}</span>
                            <span>${story.totalDistance.toFixed(2)} miles ‚Ä¢ ${Math.floor(story.sessionTime / 60)} mins</span>
                        </div>
                        <div style="color: var(--neon-cyan); margin-bottom: 5px;">${story.genre.replace('-', ' ')} ‚Ä¢ ${story.mode} mode</div>
                        <div style="color: var(--text-secondary); font-size: 0.9rem;">
                            ${story.chapters.length} chapters ‚Ä¢ ${story.customPlot || 'Standard plot'}
                        </div>
                    </div>
                `).join('');
            }

            loadStory(sessionId) {
                const savedStories = JSON.parse(localStorage.getItem('myJourneyAIStories') || '[]');
                const story = savedStories.find(s => s.id === sessionId);
                
                if (!story) return;
                
                // Restore session
                this.sessionId = story.id;
                this.selectedGenre = story.genre;
                this.customPlot = story.customPlot;
                this.mode = story.mode;
                this.totalDistance = story.totalDistance;
                this.sessionTime = story.sessionTime;
                this.currentStory = story.chapters;
                this.currentChapter = story.chapters.length;
                
                // Display all chapters
                const storyFeed = document.getElementById('storyFeed');
                storyFeed.innerHTML = '';
                
                this.currentStory.forEach((chapter, index) => {
                    this.displayChapter(chapter, this.audioBlobs[index] || new Blob());
                });
                
                this.updateDisplay();
                this.hideSavedStories();
                
                // Enable continue option
                if (!this.isActive) {
                    document.getElementById('startBtn').disabled = false;
                    document.getElementById('saveSessionBtn').disabled = false;
                    document.getElementById('clearSessionBtn').disabled = false;
                }
            }

            showSavedStories() {
                document.getElementById('savedStoriesModal').style.display = 'block';
                this.loadSavedStories();
            }

            hideSavedStories() {
                document.getElementById('savedStoriesModal').style.display = 'none';
            }

            startTimer() {
                setInterval(() => {
                    if (this.isActive && !this.isPaused) {
                        this.sessionTime++;
                        this.updateTimerDisplay();
                    }
                }, 1000);
            }

            updateTimerDisplay() {
                const hours = Math.floor(this.sessionTime / 3600);
                const minutes = Math.floor((this.sessionTime % 3600) / 60);
                const seconds = this.sessionTime % 60;
                
                const display = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                document.getElementById('timerDisplay').textContent = display;
            }

            async generateAudio(text) {
                try {
                    // Simulate TTS generation
                    const audioBlob = await this.simulateTTS(text);
                    return audioBlob;
                } catch (error) {
                    console.error('Error generating audio:', error);
                    return null;
                }
            }

            async simulateTTS(text) {
                // This is a simulation - in reality you'd use edge-tts-client
                // For demo purposes, we'll create a silent audio blob
                const audioContext = new AudioContext();
                const sampleRate = 44100;
                const duration = 1; // 1 second silent audio
                const buffer = audioContext.createBuffer(1, sampleRate * duration, sampleRate);
                
                const wavBuffer = this.createWavBuffer(buffer);
                return new Blob([wavBuffer], { type: 'audio/wav' });
            }

            createWavBuffer(buffer) {
                const length = buffer.length * buffer.numberOfChannels * 2 + 44;
                const arrayBuffer = new ArrayBuffer(length);
                const view = new DataView(arrayBuffer);
                const channels = [];
                let offset = 0;
                let pos = 0;

                // Write WAV header
                const setUint16 = (data) => {
                    view.setUint16(pos, data, true);
                    pos += 2;
                };
                const setUint32 = (data) => {
                    view.setUint32(pos, data, true);
                    pos += 4;
                };

                // RIFF identifier
                setUint32(0x46464952);
                // file length
                setUint32(length - 8);
                // RIFF type
                setUint32(0x45564157);
                // format chunk identifier
                setUint32(0x20746d66);
                // format chunk length
                setUint32(16);
                // sample format (raw)
                setUint16(1);
                // channel count
                setUint16(buffer.numberOfChannels);
                // sample rate
                setUint32(buffer.sampleRate);
                // byte rate (sample rate * block align)
                setUint32(buffer.sampleRate * buffer.numberOfChannels * 2);
                // block align (channel count * bytes per sample)
                setUint16(buffer.numberOfChannels * 2);
                // bits per sample
                setUint16(16);
                // data chunk identifier
                setUint32(0x61746164);
                // data chunk length
                setUint32(length - pos - 4);

                // Write samples
                for (let i = 0; i < buffer.numberOfChannels; i++) {
                    channels.push(buffer.getChannelData(i));
                }

                while (pos < length) {
                    for (let i = 0; i < buffer.numberOfChannels; i++) {
                        let sample = Math.max(-1, Math.min(1, channels[i][offset]));
                        sample = sample < 0 ? sample * 0x8000 : sample * 0x7FFF;
                        view.setInt16(pos, sample, true);
                        pos += 2;
                    }
                    offset++;
                }

                return arrayBuffer;
            }
        }

        // Initialize the application
        const myJourneyAI = new MyJourneyAI();

        // Add slide-in animation
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>