<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyJourneyAI - Narrative Running Experience</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/localforage@1.10.0/dist/localforage.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Inter:wght@300;400;500;600;700&display=swap');
        
        * {
            font-family: 'Inter', sans-serif;
        }
        
        .drop-cap::first-letter {
            font-size: 2.5em;
            font-weight: bold;
            float: left;
            font-family: 'Cinzel', serif;
            margin-right: 0.1em;
            color: #ef4444;
        }
        
        .glow-red {
            text-shadow: 0 0 10px rgba(239, 68, 68, 0.8), 0 0 20px rgba(239, 68, 68, 0.6);
        }
        
        .glow-green {
            text-shadow: 0 0 10px rgba(34, 197, 94, 0.8), 0 0 20px rgba(34, 197, 94, 0.6);
        }
        
        .glow-amber {
            text-shadow: 0 0 10px rgba(245, 158, 11, 0.8), 0 0 20px rgba(245, 158, 11, 0.6);
        }
        
        .shimmer {
            background: linear-gradient(90deg, #1f2937 0%, #374151 50%, #1f2937 100%);
            background-size: 200% 100%;
            animation: shimmer-animation 2s infinite;
        }
        
        @keyframes shimmer-animation {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        .cyber-border {
            border: 2px solid rgba(239, 68, 68, 0.3);
            box-shadow: inset 0 0 20px rgba(239, 68, 68, 0.1), 0 0 20px rgba(239, 68, 68, 0.1);
        }
        
        .chapter-container {
            max-height: 400px;
            overflow-y: auto;
            scroll-behavior: smooth;
        }
        
        .chapter-container::-webkit-scrollbar {
            width: 8px;
        }
        
        .chapter-container::-webkit-scrollbar-track {
            background: rgba(239, 68, 68, 0.1);
        }
        
        .chapter-container::-webkit-scrollbar-thumb {
            background: #ef4444;
            border-radius: 4px;
        }
        
        .metric-card {
            background: rgba(239, 68, 68, 0.05);
            border-left: 3px solid #ef4444;
            transition: all 0.3s ease;
        }
        
        .metric-card:hover {
            background: rgba(239, 68, 68, 0.1);
            transform: translateX(4px);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            border: 1px solid #991b1b;
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.6);
            transform: translateY(-2px);
        }
        
        .audio-player {
            width: 100%;
            height: 40px;
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid #ef4444;
            border-radius: 8px;
        }
        
        .progress-bar {
            background: linear-gradient(90deg, #ef4444, #dc2626);
            height: 2px;
            border-radius: 1px;
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .sticky-dashboard {
            backdrop-filter: blur(10px);
            background: rgba(15, 23, 42, 0.95);
            border-bottom: 1px solid rgba(239, 68, 68, 0.3);
        }
        
        .control-overlay {
            backdrop-filter: blur(10px);
            background: rgba(15, 23, 42, 0.95);
            border-top: 1px solid rgba(239, 68, 68, 0.3);
        }
    </style>
</head>
<body class="bg-slate-950 text-slate-100">
    <!-- STICKY DASHBOARD HEADER -->
    <header class="sticky-dashboard sticky top-0 z-40">
        <div class="container mx-auto px-4 py-4">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center gap-3">
                    <h1 class="text-2xl font-bold font-['Cinzel'] glow-red">MyJourneyAI</h1>
                    <span id="narrative-intensity" class="text-xs px-3 py-1 bg-red-500 text-white rounded-full">Initializing...</span>
                </div>
                <div id="api-status" class="flex items-center gap-2 text-xs">
                    <div class="w-2 h-2 bg-red-500 rounded-full animate-pulse"></div>
                    <span>Waiting for API Key</span>
                </div>
            </div>
            
            <!-- METRICS GRID -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                <div class="metric-card p-3 rounded">
                    <div class="text-xs text-slate-400 mb-1">Speed</div>
                    <div id="speed-display" class="text-2xl font-bold glow-red">0 mph</div>
                </div>
                <div class="metric-card p-3 rounded">
                    <div class="text-xs text-slate-400 mb-1">Distance</div>
                    <div id="distance-display" class="text-2xl font-bold glow-green">0.0 km</div>
                </div>
                <div class="metric-card p-3 rounded">
                    <div class="text-xs text-slate-400 mb-1">CO‚ÇÇ Saved</div>
                    <div id="co2-display" class="text-2xl font-bold glow-green">0 kg</div>
                </div>
                <div class="metric-card p-3 rounded">
                    <div class="text-xs text-slate-400 mb-1">Session Time</div>
                    <div id="timer-display" class="text-2xl font-bold glow-amber">00:00</div>
                </div>
            </div>
        </div>
    </header>

    <!-- MAIN CONTAINER -->
    <div class="container mx-auto px-4 py-8 pb-40">
        <!-- API KEY MODAL / SETUP -->
        <div id="setup-modal" class="fixed inset-0 bg-black/80 flex items-center justify-center z-50">
            <div class="bg-slate-900 cyber-border p-8 rounded-lg max-w-md w-full mx-4">
                <h2 class="text-2xl font-bold mb-4 glow-red">Welcome to MyJourneyAI</h2>
                <p class="text-slate-400 mb-6 text-sm">Enter your Groq API key to begin your narrative journey. Your speed will drive the story.</p>
                
                <div class="mb-4">
                    <label class="text-xs text-slate-400 mb-2 block">Groq API Key</label>
                    <input type="password" id="api-key-input" placeholder="gsk_..." class="w-full bg-slate-800 border border-red-500/30 rounded px-3 py-2 text-sm focus:outline-none focus:border-red-500" />
                </div>
                
                <div class="mb-6 p-3 bg-red-500/10 border border-red-500/30 rounded text-xs text-slate-300">
                    <p class="mb-2"><strong>Get your API key:</strong></p>
                    <p>Visit <a href="https://console.groq.com/keys" target="_blank" class="text-red-400 hover:underline">console.groq.com/keys</a> and create a free account.</p>
                </div>
                
                <button onclick="initializeApp()" class="w-full btn-primary text-white font-semibold py-3 rounded transition">
                    Start Journey
                </button>
            </div>
        </div>

        <!-- SAVED STORIES DASHBOARD -->
        <div id="saved-stories-dashboard" class="hidden mb-8">
            <h2 class="text-3xl font-bold mb-6 glow-red font-['Cinzel']">Saved Stories</h2>
            <div id="stories-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Stories populated dynamically -->
            </div>
        </div>

        <!-- STORY FEED -->
        <div id="story-feed" class="mb-8 hidden">
            <div class="chapter-container" id="chapters-container">
                <!-- Chapters populated here -->
            </div>
        </div>

        <!-- NEW STORY BUTTON -->
        <button id="new-story-btn" onclick="startNewStory()" class="w-full btn-primary text-white font-semibold py-3 rounded mb-4 hidden">
            <i class="fas fa-play mr-2"></i> Start New Story
        </button>
    </div>

    <!-- CONTROL OVERLAY (BOTTOM) -->
    <div class="control-overlay fixed bottom-0 left-0 right-0 z-30">
        <div class="container mx-auto px-4 py-4">
            <!-- SPEED SLIDER CONTROL -->
            <div id="speed-controls" class="mb-4 hidden">
                <div class="flex items-center gap-4">
                    <div class="flex-1">
                        <label class="text-xs text-slate-400 mb-2 block">Manual Speed Simulator</label>
                        <div class="flex items-center gap-3">
                            <span class="text-xs text-slate-400">0</span>
                            <input type="range" id="speed-slider" min="0" max="15" step="0.1" value="0" class="flex-1 h-2 bg-slate-800 rounded appearance-none cursor-pointer" style="accent-color: #ef4444;" />
                            <span class="text-xs text-slate-400">15 mph</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- GEOLOCATION STATUS -->
            <div id="geo-status" class="mb-4 text-xs text-slate-400 text-center hidden">
                <i class="fas fa-map-marker-alt text-red-500 mr-2"></i>
                <span id="geo-status-text">Tracking your location...</span>
            </div>

            <!-- SESSION CONTROLS -->
            <div class="flex gap-2 justify-center flex-wrap">
                <button id="toggle-geo-btn" onclick="toggleGeolocation()" class="btn-primary text-white font-semibold py-2 px-4 rounded text-sm hidden">
                    <i class="fas fa-location-dot mr-2"></i> Enable Location
                </button>
                <button id="save-exit-btn" onclick="saveAndExit()" class="bg-yellow-600 hover:bg-yellow-700 text-white font-semibold py-2 px-4 rounded text-sm hidden transition">
                    <i class="fas fa-save mr-2"></i> Save & Exit
                </button>
                <button id="resume-btn" onclick="showSavedStories()" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded text-sm hidden transition">
                    <i class="fas fa-history mr-2"></i> Saved Stories
                </button>
                <button id="export-epub-btn" onclick="exportToEPUB()" class="bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-4 rounded text-sm hidden transition">
                    <i class="fas fa-download mr-2"></i> Export EPUB
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        // ==================== GLOBAL STATE ====================
        const APP_STATE = {
            apiKey: null,
            currentStory: null,
            isRunning: false,
            chapters: [],
            audioBlobs: [],
            startTime: null,
            elapsedSeconds: 0,
            speed: 0, // m/s
            totalDistance: 0, // km
            lastPosition: null,
            geolocationEnabled: false,
            watchId: null,
            sessionId: null,
            lastChapterTime: 0,
            chapterInterval: 600000, // 10 minutes in ms
        };

        const NARRATIVE_STYLES = {
            calm: {
                minSpeed: 0,
                maxSpeed: 2.5,
                style: "atmospheric, poetic, contemplative",
                tension: "Calm"
            },
            rising: {
                minSpeed: 2.5,
                maxSpeed: 4.5,
                style: "building intensity, engaging, dynamic",
                tension: "Rising"
            },
            highTension: {
                minSpeed: 4.5,
                maxSpeed: Infinity,
                style: "punchy, urgent, high-stakes, adrenaline-fueled",
                tension: "High"
            }
        };

        // ==================== UTILITY FUNCTIONS ====================
        function mpsToMph(mps) {
            return (mps * 2.237).toFixed(1);
        }

        function getCurrentNarrativeStyle(speedMps) {
            if (speedMps < 2.5) return NARRATIVE_STYLES.calm;
            if (speedMps < 4.5) return NARRATIVE_STYLES.rising;
            return NARRATIVE_STYLES.highTension;
        }

        function calculateCO2Saved(distanceKm) {
            // Average car emits ~120g CO2 per km
            return (distanceKm * 0.12).toFixed(2);
        }

        function formatTime(seconds) {
            const hrs = Math.floor(seconds / 3600);
            const mins = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            if (hrs > 0) {
                return `${hrs.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            }
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        function generateSessionId() {
            return `session_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
        }

        // ==================== LOCALFORAGE PERSISTENCE ====================
        async function saveSessionState() {
            try {
                const sessionData = {
                    id: APP_STATE.sessionId,
                    title: APP_STATE.currentStory?.title || 'Untitled Journey',
                    createdAt: APP_STATE.currentStory?.createdAt || Date.now(),
                    lastSaved: Date.now(),
                    chapters: APP_STATE.chapters,
                    totalDistance: APP_STATE.totalDistance,
                    elapsedSeconds: APP_STATE.elapsedSeconds,
                    audioBlobs: APP_STATE.audioBlobs,
                    storyContext: APP_STATE.currentStory?.context || ''
                };
                await localforage.setItem(`story_${APP_STATE.sessionId}`, sessionData);
                console.log('Session saved:', APP_STATE.sessionId);
            } catch (error) {
                console.error('Failed to save session:', error);
            }
        }

        async function loadSessionState(sessionId) {
            try {
                const sessionData = await localforage.getItem(`story_${sessionId}`);
                if (sessionData) {
                    APP_STATE.chapters = sessionData.chapters;
                    APP_STATE.totalDistance = sessionData.totalDistance;
                    APP_STATE.elapsedSeconds = sessionData.elapsedSeconds;
                    APP_STATE.audioBlobs = sessionData.audioBlobs;
                    APP_STATE.currentStory = {
                        title: sessionData.title,
                        createdAt: sessionData.createdAt,
                        context: sessionData.storyContext
                    };
                    APP_STATE.sessionId = sessionId;
                    return true;
                }
                return false;
            } catch (error) {
                console.error('Failed to load session:', error);
                return false;
            }
        }

        async function getAllSessions() {
            try {
                const keys = await localforage.keys();
                const sessions = [];
                for (const key of keys) {
                    if (key.startsWith('story_')) {
                        const data = await localforage.getItem(key);
                        sessions.push(data);
                    }
                }
                return sessions.sort((a, b) => b.lastSaved - a.lastSaved);
            } catch (error) {
                console.error('Failed to fetch sessions:', error);
                return [];
            }
        }

        // ==================== API INTEGRATION ====================
        async function generateChapter(speedMps, previousContext = '') {
            if (!APP_STATE.apiKey) {
                console.error('API key not set');
                return null;
            }

            const narrativeStyle = getCurrentNarrativeStyle(speedMps);
            
            const systemPrompt = `You are a master storyteller creating an immersive, second-person narrative. The reader is on a running or walking journey. The story must:
- Be written in second-person perspective ("You are...", "You feel...", "Your breath...")
- NEVER mention running, walking, exercise, fitness, metrics, or any awareness of physical activity
- Focus entirely on the narrative world and sensory experiences
- Current narrative tone: ${narrativeStyle.style}
- Generate a LONG, IMMERSIVE chapter of 15-20 paragraphs minimum
- Build upon previous context to maintain continuity
- Use vivid, literary language with poetic descriptions
- Each paragraph should be 2-4 sentences
- Maintain ${narrativeStyle.tension} tension throughout`;

            const userPrompt = previousContext 
                ? `Continue the story with this context: ${previousContext}\n\nWrite the next chapter maintaining the narrative thread and ${narrativeStyle.tension} tension.`
                : `Begin a new, epic second-person narrative adventure. The reader is embarking on a mysterious journey. Write the opening chapter with ${narrativeStyle.tension} tone.`;

            try {
                const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${APP_STATE.apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'llama-3.1-70b-versatile',
                        messages: [
                            { role: 'system', content: systemPrompt },
                            { role: 'user', content: userPrompt }
                        ],
                        temperature: 0.9,
                        max_tokens: 2000,
                        stream: false
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    console.error('Groq API error:', error);
                    return null;
                }

                const data = await response.json();
                const chapterText = data.choices[0].message.content;
                return chapterText;
            } catch (error) {
                console.error('Chapter generation failed:', error);
                return null;
            }
        }

        // ==================== AUDIO SYNTHESIS ====================
        async function synthesizeToAudio(text) {
            try {
                const { TextToSpeechClient } = await import('https://cdn.jsdelivr.net/npm/edge-tts-client@1.0.0/+esm');
                
                const client = new TextToSpeechClient();
                const chunks = [];
                
                const stream = await client.synthesize(text, {
                    voice: 'en-US-AriaNeural',
                    rate: 1.0
                });

                for await (const chunk of stream) {
                    chunks.push(chunk);
                }

                const blob = new Blob(chunks, { type: 'audio/mp3' });
                return blob;
            } catch (error) {
                console.warn('Audio synthesis unavailable (Edge-TTS may require auth):', error);
                // Create silent placeholder audio
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const buffer = audioContext.createBuffer(1, 44100, 44100);
                const offlineContext = new OfflineAudioContext(1, 44100, 44100);
                const blob = new Blob([new ArrayBuffer(0)], { type: 'audio/mp3' });
                return blob;
            }
        }

        // ==================== GEOLOCATION TRACKING ====================
        function startGeolocation() {
            if (!navigator.geolocation) {
                alert('Geolocation not supported on this device');
                return;
            }

            APP_STATE.geolocationEnabled = true;
            document.getElementById('geo-status').classList.remove('hidden');
            document.getElementById('toggle-geo-btn').textContent = '‚óº Stop Location';
            document.getElementById('toggle-geo-btn').classList.add('bg-red-600');

            APP_STATE.watchId = navigator.geolocation.watchPosition(
                (position) => {
                    const { latitude, longitude } = position.coords;
                    const timestamp = Date.now();

                    if (APP_STATE.lastPosition) {
                        const R = 6371; // Earth's radius in km
                        const lat1 = APP_STATE.lastPosition.latitude * Math.PI / 180;
                        const lat2 = latitude * Math.PI / 180;
                        const deltaLat = (latitude - APP_STATE.lastPosition.latitude) * Math.PI / 180;
                        const deltaLon = (longitude - APP_STATE.lastPosition.longitude) * Math.PI / 180;

                        const a = Math.sin(deltaLat / 2) * Math.sin(deltaLat / 2) +
                                  Math.cos(lat1) * Math.cos(lat2) *
                                  Math.sin(deltaLon / 2) * Math.sin(deltaLon / 2);
                        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
                        const distance = R * c;

                        const timeDelta = (timestamp - APP_STATE.lastPosition.timestamp) / 1000;
                        APP_STATE.speed = distance / timeDelta; // m/s (converted from km/s)
                        APP_STATE.totalDistance += distance;

                        updateMetrics();
                    }

                    APP_STATE.lastPosition = {
                        latitude,
                        longitude,
                        timestamp
                    };

                    document.getElementById('geo-status-text').textContent = 
                        `Lat: ${latitude.toFixed(4)}, Lon: ${longitude.toFixed(4)}`;
                },
                (error) => {
                    console.error('Geolocation error:', error);
                    document.getElementById('geo-status-text').textContent = 'Location unavailable';
                },
                { enableHighAccuracy: true, maximumAge: 0, timeout: 5000 }
            );
        }

        function stopGeolocation() {
            if (APP_STATE.watchId !== null) {
                navigator.geolocation.clearWatch(APP_STATE.watchId);
                APP_STATE.watchId = null;
            }
            APP_STATE.geolocationEnabled = false;
            document.getElementById('geo-status').classList.add('hidden');
            document.getElementById('toggle-geo-btn').textContent = 'üìç Enable Location';
            document.getElementById('toggle-geo-btn').classList.remove('bg-red-600');
        }

        function toggleGeolocation() {
            if (APP_STATE.geolocationEnabled) {
                stopGeolocation();
            } else {
                startGeolocation();
            }
        }

        // ==================== METRICS UPDATE ====================
        function updateMetrics() {
            const speedMph = mpsToMph(APP_STATE.speed);
            const co2Kg = calculateCO2Saved(APP_STATE.totalDistance);
            const narrativeStyle = getCurrentNarrativeStyle(APP_STATE.speed);

            document.getElementById('speed-display').textContent = `${speedMph} mph`;
            document.getElementById('distance-display').textContent = `${APP_STATE.totalDistance.toFixed(1)} km`;
            document.getElementById('co2-display').textContent = `${co2Kg} kg`;
            document.getElementById('narrative-intensity').textContent = narrativeStyle.tension;

            // Update glow colors based on intensity
            if (narrativeStyle.tension === 'Calm') {
                document.getElementById('narrative-intensity').className = 'text-xs px-3 py-1 bg-green-500 text-white rounded-full';
            } else if (narrativeStyle.tension === 'Rising') {
                document.getElementById('narrative-intensity').className = 'text-xs px-3 py-1 bg-amber-500 text-white rounded-full';
            } else {
                document.getElementById('narrative-intensity').className = 'text-xs px-3 py-1 bg-red-500 text-white rounded-full';
            }
        }

        function updateSpeedFromSlider() {
            const sliderValue = parseFloat(document.getElementById('speed-slider').value);
            APP_STATE.speed = sliderValue / 2.237; // Convert mph to m/s
            updateMetrics();
        }

        // ==================== CHAPTER RENDERING ====================
        async function renderChapter(text, audioBlob) {
            const container = document.getElementById('chapters-container');
            const chapterNum = APP_STATE.chapters.length + 1;

            const chapterDiv = document.createElement('div');
            chapterDiv.className = 'mb-8 p-6 bg-slate-900/50 rounded-lg cyber-border fade-in';

            const titleDiv = document.createElement('h3');
            titleDiv.className = 'text-2xl font-bold mb-4 glow-red font-["Cinzel"]';
            titleDiv.textContent = `Chapter ${chapterNum}`;

            const textDiv = document.createElement('p');
            textDiv.className = 'drop-cap leading-relaxed text-slate-300 mb-4 text-justify';
            textDiv.innerHTML = text.replace(/\n\n/g, '</p><p class="drop-cap leading-relaxed text-slate-300 mb-4 text-justify">');

            const audioContainer = document.createElement('div');
            audioContainer.className = 'mt-4';

            if (audioBlob && audioBlob.size > 0) {
                const audioUrl = URL.createObjectURL(audioBlob);
                const audio = document.createElement('audio');
                audio.className = 'audio-player';
                audio.controls = true;
                audio.src = audioUrl;
                audioContainer.appendChild(audio);
            } else {
                const placeholder = document.createElement('div');
                placeholder.className = 'p-3 bg-slate-800 rounded text-xs text-slate-400';
                placeholder.textContent = 'Audio synthesis in progress...';
                audioContainer.appendChild(placeholder);
            }

            chapterDiv.appendChild(titleDiv);
            chapterDiv.appendChild(textDiv);
            chapterDiv.appendChild(audioContainer);

            container.insertBefore(chapterDiv, container.firstChild);

            // Save state
            APP_STATE.chapters.push({ number: chapterNum, text });
            await saveSessionState();
        }

        // ==================== CHAPTER GENERATION LOOP ====================
        async function startChapterGeneration() {
            const generateNextChapter = async () => {
                const speedMps = APP_STATE.speed;
                const previousContext = APP_STATE.chapters.length > 0 
                    ? APP_STATE.chapters[APP_STATE.chapters.length - 1].text.substring(0, 500)
                    : '';

                const chapterText = await generateChapter(speedMps, previousContext);
                
                if (chapterText) {
                    console.log('Generating audio for chapter...');
                    const audioBlob = await synthesizeToAudio(chapterText);
                    await renderChapter(chapterText, audioBlob);
                } else {
                    console.error('Failed to generate chapter');
                }
            };

            // Generate first chapter immediately
            await generateNextChapter();

            // Schedule subsequent chapters every 10 minutes
            APP_STATE.chapterInterval = setInterval(async () => {
                if (APP_STATE.isRunning) {
                    await generateNextChapter();
                }
            }, APP_STATE.chapterInterval);
        }

        // ==================== SESSION MANAGEMENT ====================
        async function initializeApp() {
            const apiKey = document.getElementById('api-key-input').value.trim();
            
            if (!apiKey) {
                alert('Please enter a valid API key');
                return;
            }

            APP_STATE.apiKey = apiKey;
            document.getElementById('setup-modal').classList.add('hidden');
            document.getElementById('api-status').innerHTML = '<div class="w-2 h-2 bg-green-500 rounded-full"></div><span>Ready</span>';

            // Show initial options
            document.getElementById('new-story-btn').classList.remove('hidden');
            document.getElementById('toggle-geo-btn').classList.remove('hidden');
            document.getElementById('resume-btn').classList.remove('hidden');
            document.getElementById('saved-stories-dashboard').classList.remove('hidden');

            // Load saved stories
            await showSavedStories();
        }

        async function startNewStory() {
            APP_STATE.sessionId = generateSessionId();
            APP_STATE.currentStory = {
                title: `Journey ${new Date().toLocaleDateString()}`,
                createdAt: Date.now(),
                context: ''
            };
            APP_STATE.chapters = [];
            APP_STATE.audioBlobs = [];
            APP_STATE.totalDistance = 0;
            APP_STATE.elapsedSeconds = 0;
            APP_STATE.speed = 0;
            APP_STATE.startTime = Date.now();
            APP_STATE.isRunning = true;

            document.getElementById('saved-stories-dashboard').classList.add('hidden');
            document.getElementById('story-feed').classList.remove('hidden');
            document.getElementById('speed-controls').classList.remove('hidden');
            document.getElementById('save-exit-btn').classList.remove('hidden');
            document.getElementById('export-epub-btn').classList.remove('hidden');
            document.getElementById('new-story-btn').classList.add('hidden');

            // Setup slider listener
            document.getElementById('speed-slider').addEventListener('input', updateSpeedFromSlider);

            // Start timer
            setInterval(() => {
                if (APP_STATE.isRunning) {
                    APP_STATE.elapsedSeconds++;
                    document.getElementById('timer-display').textContent = formatTime(APP_STATE.elapsedSeconds);
                }
            }, 1000);

            // Start chapter generation
            await startChapterGeneration();
        }

        async function saveAndExit() {
            APP_STATE.isRunning = false;
            if (APP_STATE.chapterInterval) {
                clearInterval(APP_STATE.chapterInterval);
            }
            if (APP_STATE.geolocationEnabled) {
                stopGeolocation();
            }

            await saveSessionState();
            alert('Story saved! You can resume it anytime from Saved Stories.');

            // Reset UI
            document.getElementById('story-feed').classList.add('hidden');
            document.getElementById('speed-controls').classList.add('hidden');
            document.getElementById('save-exit-btn').classList.add('hidden');
            document.getElementById('export-epub-btn').classList.add('hidden');
            document.getElementById('new-story-btn').classList.remove('hidden');
            document.getElementById('saved-stories-dashboard').classList.remove('hidden');

            await showSavedStories();
        }

        async function showSavedStories() {
            const sessions = await getAllSessions();
            const grid = document.getElementById('stories-grid');
            grid.innerHTML = '';

            if (sessions.length === 0) {
                grid.innerHTML = '<div class="col-span-full text-center text-slate-400 py-8">No saved stories yet. Start your first journey!</div>';
                return;
            }

            sessions.forEach(session => {
                const card = document.createElement('div');
                card.className = 'bg-slate-900 cyber-border p-4 rounded-lg cursor-pointer hover:bg-slate-800 transition';
                
                const createdDate = new Date(session.createdAt);
                const lastSavedDate = new Date(session.lastSaved);
                const distance = session.totalDistance.toFixed(1);
                const time = formatTime(session.elapsedSeconds);
                const chapters = session.chapters.length;

                card.innerHTML = `
                    <h3 class="text-lg font-bold glow-red mb-2">${session.title}</h3>
                    <div class="text-xs text-slate-400 space-y-1 mb-3">
                        <p>Created: ${createdDate.toLocaleDateString()}</p>
                        <p>Last Saved: ${lastSavedDate.toLocaleString()}</p>
                        <p>Chapters: ${chapters} | Distance: ${distance} km | Time: ${time}</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="resumeStory('${session.id}')" class="flex-1 btn-primary text-white text-xs py-2 rounded">Resume</button>
                        <button onclick="deleteStory('${session.id}')" class="flex-1 bg-red-900 hover:bg-red-800 text-white text-xs py-2 rounded transition">Delete</button>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        async function resumeStory(sessionId) {
            const loaded = await loadSessionState(sessionId);
            if (loaded) {
                document.getElementById('saved-stories-dashboard').classList.add('hidden');
                document.getElementById('story-feed').classList.remove('hidden');
                document.getElementById('speed-controls').classList.remove('hidden');
                document.getElementById('save-exit-btn').classList.remove('hidden');
                document.getElementById('export-epub-btn').classList.remove('hidden');
                document.getElementById('new-story-btn').classList.add('hidden');

                // Re-render all chapters
                const container = document.getElementById('chapters-container');
                container.innerHTML = '';
                
                APP_STATE.chapters.forEach((chapter, index) => {
                    const audioBlob = APP_STATE.audioBlobs[index] || null;
                    renderChapter(chapter.text, audioBlob);
                });

                APP_STATE.isRunning = true;
                APP_STATE.startTime = Date.now() - (APP_STATE.elapsedSeconds * 1000);

                // Resume timer
                setInterval(() => {
                    if (APP_STATE.isRunning) {
                        APP_STATE.elapsedSeconds++;
                        document.getElementById('timer-display').textContent = formatTime(APP_STATE.elapsedSeconds);
                    }
                }, 1000);

                // Resume chapter generation
                await startChapterGeneration();
            }
        }

        async function deleteStory(sessionId) {
            if (confirm('Delete this story permanently?')) {
                try {
                    await localforage.removeItem(`story_${sessionId}`);
                    await showSavedStories();
                } catch (error) {
                    console.error('Failed to delete story:', error);
                }
            }
        }

        // ==================== EPUB EXPORT ====================
        async function exportToEPUB() {
            if (APP_STATE.chapters.length === 0) {
                alert('No chapters to export');
                return;
            }

            try {
                const JSZip = window.JSZip;
                const zip = new JSZip();

                // Create mimetype file
                zip.file('mimetype', 'application/epub+zip');

                // Create META-INF directory
                const metaInf = zip.folder('META-INF');
                metaInf.file('container.xml', `<?xml version="1.0" encoding="UTF-8"?>
<container version="1.0" xmlns="urn:oasis:names:tc:opendocument:xmlns:container">
  <rootfiles>
    <rootfile full-path="OEBPS/content.opf" media-type="application/oebps-package+xml"/>
  </rootfiles>
</container>`);

                // Create OEBPS directory
                const oebps = zip.folder('OEBPS');

                // Create OPF file (metadata)
                const uuid = `urn:uuid:${generateSessionId()}`;
                const createdDate = new Date(APP_STATE.currentStory.createdAt).toISOString();
                
                oebps.file('content.opf', `<?xml version="1.0" encoding="UTF-8"?>
<package version="3.0" xmlns="http://www.idpf.org/2007/opf" unique-identifier="BookId">
  <metadata xmlns:dc="http://purl.org/dc/elements/1.1/">
    <dc:title>${APP_STATE.currentStory.title}</dc:title>
    <dc:creator>MyJourneyAI</dc:creator>
    <dc:identifier id="BookId">${uuid}</dc:identifier>
    <dc:date>${createdDate}</dc:date>
    <dc:language>en</dc:language>
  </metadata>
  <manifest>
    <item id="ncx" href="toc.ncx" media-type="application/x-dtbncx+xml"/>
    <item id="style" href="style.css" media-type="text/css"/>
    <item id="toc" href="toc.html" media-type="application/xhtml+xml"/>
    ${APP_STATE.chapters.map((_, i) => `<item id="chapter${i + 1}" href="chapter${i + 1}.html" media-type="application/xhtml+xml"/>`).join('\n    ')}
  </manifest>
  <spine toc="ncx">
    <itemref idref="toc"/>
    ${APP_STATE.chapters.map((_, i) => `<itemref idref="chapter${i + 1}"/>`).join('\n    ')}
  </spine>
</package>`);

                // Create TOC NCX
                oebps.file('toc.ncx', `<?xml version="1.0" encoding="UTF-8"?>
<ncx version="2005-1" xmlns="http://www.daisy.org/z3986/2005/ncx/">
  <head>
    <meta name="dtb:uid" content="123"/>
    <meta name="dtb:depth" content="1"/>
    <meta name="dtb:totalPageCount" content="0"/>
    <meta name="dtb:maxPageNumber" content="0"/>
  </head>
  <docTitle>
    <text>${APP_STATE.currentStory.title}</text>
  </docTitle>
  <navMap>
    ${APP_STATE.chapters.map((_, i) => `
    <navPoint id="navpoint${i + 1}" playOrder="${i + 1}">
      <navLabel><text>Chapter ${i + 1}</text></navLabel>
      <content src="chapter${i + 1}.html"/>
    </navPoint>`).join('\n    ')}
  </navMap>
</ncx>`);

                // Create CSS
                oebps.file('style.css', `
body {
  font-family: Georgia, serif;
  background-color: #1f2937;
  color: #e5e7eb;
  line-height: 1.6;
}
h1, h2, h3 {
  color: #ef4444;
  margin-top: 1.5em;
  margin-bottom: 0.5em;
}
p {
  margin-bottom: 1em;
  text-align: justify;
}
.drop-cap::first-letter {
  font-size: 2em;
  font-weight: bold;
  float: left;
  margin-right: 0.1em;
}
`);

                // Create TOC HTML
                oebps.file('toc.html', `<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta charset="UTF-8"/>
  <title>Table of Contents</title>
  <link rel="stylesheet" href="style.css"/>
</head>
<body>
  <h1>${APP_STATE.currentStory.title}</h1>
  <nav>
    <ol>
      ${APP_STATE.chapters.map((_, i) => `<li><a href="chapter${i + 1}.html">Chapter ${i + 1}</a></li>`).join('\n      ')}
    </ol>
  </nav>
</body>
</html>`);

                // Create chapter HTML files
                APP_STATE.chapters.forEach((chapter, index) => {
                    const filename = `chapter${index + 1}.html`;
                    const html = `<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta charset="UTF-8"/>
  <title>Chapter ${index + 1}</title>
  <link rel="stylesheet" href="style.css"/>
</head>
<body>
  <h2>Chapter ${index + 1}</h2>
  <div class="drop-cap">
    ${chapter.text.split('\n\n').map(p => `<p>${p}</p>`).join('\n    ')}
  </div>
</body>
</html>`;
                    oebps.file(filename, html);
                });

                // Generate zip
                const blob = await zip.generateAsync({ type: 'blob' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${APP_STATE.currentStory.title.replace(/\s+/g, '_')}.epub`;
                a.click();
                URL.revokeObjectURL(url);

                alert('EPUB exported successfully!');
            } catch (error) {
                console.error('EPUB export failed:', error);
                alert('Failed to export EPUB: ' + error.message);
            }
        }

        // ==================== INITIALIZATION ====================
        window.initializeApp = initializeApp;
        window.toggleGeolocation = toggleGeolocation;
        window.startNewStory = startNewStory;
        window.saveAndExit = saveAndExit;
        window.showSavedStories = showSavedStories;
        window.resumeStory = resumeStory;
        window.deleteStory = deleteStory;
        window.exportToEPUB = exportToEPUB;
        window.updateSpeedFromSlider = updateSpeedFromSlider;

        // Initialize on load
        document.addEventListener('DOMContentLoaded', () => {
            console.log('MyJourneyAI initialized');
        });
    </script>
</body>
</html>
