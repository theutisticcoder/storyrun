<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyJourneyAI | Running Narrative Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Playfair+Display:ital,wght@0,700;1,700&family=Inter:wght@300;400;600&display=swap');

        :root {
            --neon-blue: #00f3ff;
            --neon-pink: #ff00ff;
            --cyber-bg: #050505;
        }

        body {
            background-color: var(--cyber-bg);
            color: #e0e0e0;
            font-family: 'Inter', sans-serif;
            background-image: radial-gradient(circle at 50% 50%, #111 0%, #050505 100%);
        }

        .glitch-text {
            text-shadow: 2px 0 var(--neon-pink), -2px 0 var(--neon-blue);
            font-family: 'Orbitron', sans-serif;
        }

        .cyber-panel {
            border: 1px solid rgba(0, 243, 253, 0.2);
            background: rgba(10, 10, 10, 0.7);
            backdrop-filter: blur(12px);
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
        }

        .chapter-card {
            border-left: 2px solid var(--neon-blue);
            position: relative;
        }

        .chapter-text {
            line-height: 1.8;
            font-size: 1.05rem;
            text-align: justify;
        }

        .chapter-text::first-letter {
            float: left;
            font-family: 'Playfair Display', serif;
            font-size: 5rem;
            line-height: 0.85;
            padding-right: 0.75rem;
            padding-top: 0.5rem;
            color: var(--neon-blue);
            text-shadow: 0 0 10px rgba(0, 243, 255, 0.5);
        }

        .shimmer {
            background: linear-gradient(90deg, #111 25%, #222 50%, #111 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite linear;
        }

        @keyframes shimmer { 100% { background-position: -200% 0; } }

        input[type="range"]::-webkit-slider-thumb {
            appearance: none;
            width: 20px;
            height: 20px;
            background: var(--neon-blue);
            cursor: pointer;
            box-shadow: 0 0 10px var(--neon-blue);
            border-radius: 50%;
        }

        select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2300f3ff'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.5rem center;
            background-size: 1.2em;
        }

        .mistral-glow { text-shadow: 0 0 8px rgba(0, 243, 255, 0.1); }
    </style>
</head>

<body class="min-h-screen flex flex-col">

    <header class="p-4 border-b border-cyan-900/40 bg-black/80 sticky top-0 z-50 flex justify-between items-center">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 border-2 border-cyan-400 rounded-full flex items-center justify-center">
                <i data-lucide="brain-circuit" class="text-cyan-400 w-6 h-6"></i>
            </div>
            <h1 class="glitch-text text-xl font-bold tracking-tighter uppercase">MyJourneyAI <span class="text-[10px] text-pink-500 font-mono">Mistral+TTS</span></h1>
        </div>
        <button onclick="ui.toggleSavedDashboard()" class="text-xs font-bold text-pink-500 border border-pink-500/50 px-3 py-1 rounded">Archives</button>
    </header>

    <main class="flex-grow container mx-auto max-w-4xl p-4 md:p-8 space-y-12 pb-48">
        <div id="geo-error-bar" class="hidden cyber-panel p-3 border-red-500/50 bg-red-950/20 text-red-400 text-xs flex items-center gap-2 rounded-lg">
            <i data-lucide="alert-triangle" class="w-4 h-4"></i>
            <span>GPS Link Severed: Use manual Intensity Slider to simulate traversal.</span>
        </div>

        <section class="grid grid-cols-3 gap-4">
            <div class="cyber-panel p-4 rounded-lg text-center"><p class="text-[10px] text-cyan-400 font-bold uppercase mb-1">Velocity</p><span id="stat-speed" class="text-3xl font-bold font-mono">0.0</span> <span class="text-xs text-gray-500 uppercase">MPH</span></div>
            <div class="cyber-panel p-4 rounded-lg text-center"><p class="text-[10px] text-pink-400 font-bold uppercase mb-1">Traversed</p><span id="stat-dist" class="text-3xl font-bold font-mono">0.00</span> <span class="text-xs text-gray-500 uppercase">MI</span></div>
            <div class="cyber-panel p-4 rounded-lg text-center"><p id="stat-co2-label" class="text-[10px] text-green-400 font-bold uppercase mb-1">CO2 Redux</p><span id="stat-co2" class="text-3xl font-bold font-mono">0</span> <span class="text-xs text-gray-500 uppercase">G</span></div>
        </section>

        <section id="main-view" class="space-y-12">
            <div id="setup-panel" class="cyber-panel rounded-xl p-8 space-y-6">
                <div class="text-center">
                    <i data-lucide="settings-2" class="w-12 h-12 text-cyan-500/50 mx-auto mb-4"></i>
                    <h3 class="text-xl font-bold mb-2 uppercase tracking-widest glitch-text">Expedition Config</h3>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-2">
                        <label class="text-[10px] uppercase font-black text-gray-500">Story Genre</label>
                        <select id="config-genre" class="w-full bg-black/50 border border-cyan-900/50 p-3 rounded text-sm text-cyan-100">
                            <option>Cyberpunk Noir</option><option>Epic High Fantasy</option><option>Eldritch Cosmic Horror</option><option>Post-Apocalyptic Survival</option><option>Space Opera</option>
                            <option>Grimdark Medieval</option><option>Steampunk Espionage</option><option>Solarpunk Utopia</option><option>Ancient Samurai Tragedy</option><option>Hard Space Realism</option>
                        </select>
                    </div>
                    <div class="space-y-2">
                        <label class="text-[10px] uppercase font-black text-gray-500">Travel Protocol</label>
                        <button onclick="ui.toggleCarpool()" class="w-full bg-black/50 border border-cyan-900/50 p-3 rounded text-sm flex justify-between items-center">
                            <span id="carpool-label">Solo Expedition</span>
                            <div id="carpool-indicator" class="w-10 h-5 bg-gray-800 rounded-full relative"><div class="absolute left-1 top-1 w-3 h-3 bg-gray-600 rounded-full"></div></div>
                        </button>
                    </div>
                </div>
                <textarea id="config-plot" placeholder="Input specific plot directives here..." class="w-full bg-black/50 border border-cyan-900/50 p-3 rounded text-sm h-24 text-gray-300 resize-none"></textarea>
                <button onclick="engine.startSession()" class="w-full py-5 bg-cyan-600 hover:bg-cyan-400 text-black font-black uppercase rounded shadow-[0_0_30px_rgba(6,182,212,0.4)] flex items-center justify-center gap-3">
                    <i data-lucide="power"></i> Initiate Protocol
                </button>
            </div>
            <div id="chapter-feed" class="space-y-16"></div>
        </section>

        <div id="loading-indicator" class="hidden space-y-4 cyber-panel p-8 rounded-xl">
            <div class="flex items-center gap-2 mb-4">
                <div class="w-3 h-3 bg-cyan-400 rounded-full animate-ping"></div>
                <span class="text-xs text-cyan-400 uppercase font-bold">Synthesizing Narrative & Voice...</span>
            </div>
            <div class="space-y-2"><div class="h-4 w-full shimmer rounded"></div><div class="h-4 w-5/6 shimmer rounded"></div><div class="h-4 w-4/6 shimmer rounded"></div></div>
        </div>
    </main>

    <div class="fixed bottom-0 left-0 w-full p-4 z-[60] bg-gradient-to-t from-black via-black/90 to-transparent">
        <div class="max-w-5xl mx-auto cyber-panel p-6 rounded-2xl border-cyan-500/30 grid grid-cols-1 md:grid-cols-3 gap-6 items-center">
            <div class="space-y-2">
                <div class="flex justify-between text-[10px] font-bold uppercase text-cyan-400"><span>Traverse Intensity</span><span id="label-intensity">Resting</span></div>
                <input type="range" id="sim-speed" min="0" max="15" step="0.5" value="0" class="w-full h-1 bg-gray-800 rounded-lg appearance-none cursor-pointer">
            </div>
            <div class="flex flex-col items-center gap-1">
                <div id="timer" class="text-3xl font-mono font-bold text-white">00:00:00</div>
                <div class="flex gap-2">
                    <button id="btn-pause" onclick="engine.togglePause()" class="hidden p-2 rounded-full border border-gray-700 text-gray-500"><i data-lucide="pause"></i></button>
                    <button onclick="engine.saveAndExit()" class="px-4 py-1.5 rounded bg-red-950/40 border border-red-500/50 text-red-500 text-[10px] font-black uppercase tracking-widest">Terminate</button>
                </div>
            </div>
            <div class="space-y-1">
                <div class="flex justify-between text-[10px] font-bold uppercase text-gray-500"><span>Convergence</span><span id="label-sync">0%</span></div>
                <div class="w-full h-1 bg-gray-900 rounded-full overflow-hidden"><div id="sync-progress" class="h-full bg-cyan-400 transition-all duration-500" style="width: 0%"></div></div>
            </div>
        </div>
    </div>

    <div id="modal-archives" class="fixed inset-0 bg-black/95 z-[100] hidden p-6 overflow-y-auto">
        <div class="max-w-2xl mx-auto space-y-8">
            <div class="flex justify-between items-center border-b border-gray-800 pb-4">
                <h2 class="glitch-text text-3xl font-bold uppercase">Memory Cores</h2>
                <button onclick="ui.toggleSavedDashboard()"><i data-lucide="x" class="w-8 h-8 text-gray-500"></i></button>
            </div>
            <div id="archives-list" class="grid gap-4"></div>
        </div>
    </div>

    <script>
        const geminiApiKey = "";
        const mistralApiKey = "zpb7IgLy7bNk5MCh5LUfYmJnTtJCqyRQ";
        const CHAPTER_INTERVAL_MS = 10 * 60 * 1000;

        let state = {
            id: null, elapsedSeconds: 0, distance: 0, currentSpeed: 0,
            chapters: [], isPaused: true, isGenerating: false,
            config: { genre: "Cyberpunk Noir", carpool: false, plot: "" }
        };

        const engine = {
            async startSession(existing = null) {
                if (existing) { state = existing; ui.renderAllChapters(); }
                else {
                    state.id = 'journey-' + Date.now();
                    state.config.genre = document.getElementById('config-genre').value;
                    state.config.plot = document.getElementById('config-plot').value;
                }
                state.isPaused = false;
                document.getElementById('setup-panel').classList.add('hidden');
                document.getElementById('btn-pause').classList.remove('hidden');
                this.initSensors();
                this.startTimer();
                if (state.chapters.length === 0) this.generateChapter();
            },

            initSensors() {
                if ("geolocation" in navigator) {
                    navigator.geolocation.watchPosition((pos) => {
                        document.getElementById('geo-error-bar').classList.add('hidden');
                        if (state.isPaused) return;
                        const simSpeed = parseFloat(document.getElementById('sim-speed').value);
                        state.currentSpeed = simSpeed > 0 ? simSpeed : (pos.coords.speed ? pos.coords.speed * 2.237 : 0);
                        ui.updateDashboard();
                    }, (err) => document.getElementById('geo-error-bar').classList.remove('hidden'));
                }
            },

            startTimer() {
                setInterval(() => {
                    if (state.isPaused) return;
                    state.elapsedSeconds++;
                    ui.updateTimer();
                    const progress = ((state.elapsedSeconds * 1000) % CHAPTER_INTERVAL_MS) / CHAPTER_INTERVAL_MS;
                    ui.updateSyncBar(progress * 100);
                    if (state.elapsedSeconds > 10 && (state.elapsedSeconds * 1000) % CHAPTER_INTERVAL_MS < 1000) this.generateChapter();
                }, 1000);
            },

            async generateChapter() {
                if (state.isGenerating) return;
                state.isGenerating = true;
                ui.showLoading(true);

                const intensity = state.currentSpeed > 10 ? 'extreme' : (state.currentSpeed > 4 ? 'steady' : 'deliberate');
                const lastText = state.chapters.length ? state.chapters[state.chapters.length-1].text : "Start of journey.";

                try {
                    // 1. Generate Narrative (Mistral)
                    const mResp = await fetch("https://api.mistral.ai/v1/chat/completions", {
                        method: "POST",
                        headers: { "Authorization": `Bearer ${mistralApiKey}`, "Content-Type": "application/json" },
                        body: JSON.stringify({
                            model: "mistral-small-latest",
                            messages: [{ role: "user", content: `Continue a story in ${state.config.genre}. Second person. Intensity: ${intensity}. Plot: ${state.config.plot}. Previous: ${lastText.substring(0, 500)}` }]
                        })
                    });
                    const mData = await mResp.json();
                    const text = mData.choices[0].message.content;

                    // 2. Generate Voice (Gemini TTS)
                    const ttsResp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${geminiApiKey}`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: `Say in a calm, immersive tone: ${text.substring(0, 1000)}` }] }],
                            generationConfig: { responseModalities: ["AUDIO"], speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Puck" } } } }
                        })
                    });
                    const ttsData = await ttsResp.json();
                    const audioBase64 = ttsData.candidates[0].content.parts[0].inlineData.data;

                    const chapter = {
                        id: Date.now(), text, intensity,
                        timestamp: new Date().toLocaleTimeString(),
                        audio: this.pcmToWav(audioBase64)
                    };

                    state.chapters.push(chapter);
                    ui.renderChapter(chapter);
                    localforage.setItem(state.id, state);
                } catch (e) { console.error(e); }
                finally { state.isGenerating = false; ui.showLoading(false); }
            },

            pcmToWav(base64Pcm) {
                const pcmData = Uint8Array.from(atob(base64Pcm), c => c.charCodeAt(0));
                const sampleRate = 24000;
                const header = new ArrayBuffer(44);
                const view = new DataView(header);
                const writeString = (offset, string) => { for (let i = 0; i < string.length; i++) view.setUint8(offset + i, string.charCodeAt(i)); };
                writeString(0, 'RIFF');
                view.setUint32(4, 36 + pcmData.length, true);
                writeString(8, 'WAVE');
                writeString(12, 'fmt ');
                view.setUint32(16, 16, true);
                view.setUint16(20, 1, true);
                view.setUint16(22, 1, true);
                view.setUint32(24, sampleRate, true);
                view.setUint32(28, sampleRate * 2, true);
                view.setUint16(32, 2, true);
                view.setUint16(34, 16, true);
                writeString(36, 'data');
                view.setUint32(40, pcmData.length, true);
                const blob = new Blob([header, pcmData], { type: 'audio/wav' });
                return URL.createObjectURL(blob);
            },

            togglePause() { 
                state.isPaused = !state.isPaused; 
                document.getElementById('btn-pause').innerHTML = `<i data-lucide="${state.isPaused ? 'play' : 'pause'}"></i>`;
                lucide.createIcons();
            },

            async saveAndExit() { await localforage.setItem(state.id, state); window.location.reload(); }
        };

        const ui = {
            toggleCarpool() {
                state.config.carpool = !state.config.carpool;
                document.getElementById('carpool-label').innerText = state.config.carpool ? "Carpool Protocol" : "Solo Expedition";
                document.getElementById('carpool-indicator').querySelector('div').className = `absolute ${state.config.carpool ? 'left-6 bg-orange-400' : 'left-1 bg-gray-600'} w-3 h-3 rounded-full transition-all`;
                this.updateDashboard();
            },
            updateDashboard() {
                const speed = parseFloat(document.getElementById('sim-speed').value) || state.currentSpeed;
                document.getElementById('stat-speed').innerText = speed.toFixed(1);
                document.getElementById('label-intensity').innerText = speed > 10 ? 'High' : (speed > 4 ? 'Moderate' : 'Low');
            },
            updateTimer() {
                const s = state.elapsedSeconds;
                document.getElementById('timer').innerText = new Date(s * 1000).toISOString().substr(11, 8);
            },
            updateSyncBar(val) {
                document.getElementById('sync-progress').style.width = val + '%';
                document.getElementById('label-sync').innerText = Math.round(val) + '%';
            },
            showLoading(show) { document.getElementById('loading-indicator').classList.toggle('hidden', !show); },
            renderChapter(c) {
                const div = document.createElement('div');
                div.className = 'chapter-card cyber-panel p-8 rounded-2xl animate-in fade-in slide-in-from-bottom-4';
                div.innerHTML = `
                    <div class="flex justify-between items-center text-[10px] font-bold uppercase text-cyan-500 mb-4 border-b border-cyan-500/20 pb-4">
                        <span>Core Entry</span><span>${c.timestamp}</span>
                    </div>
                    <div class="chapter-text text-gray-200 mistral-glow">${c.text.split('\n').map(p => `<p class="mb-4">${p}</p>`).join('')}</div>
                    ${c.audio ? `<button onclick="this.nextElementSibling.play()" class="mt-4 p-3 rounded-full bg-cyan-950 border border-cyan-500 text-cyan-400"><i data-lucide="volume-2"></i></button><audio src="${c.audio}"></audio>` : ''}
                `;
                document.getElementById('chapter-feed').prepend(div);
                lucide.createIcons();
            },
            renderAllChapters() { state.chapters.forEach(c => this.renderChapter(c)); },
            toggleSavedDashboard() { document.getElementById('modal-archives').classList.toggle('hidden'); }
        };

        window.onload = () => { lucide.createIcons(); document.getElementById('sim-speed').addEventListener('input', () => ui.updateDashboard()); };
    </script>
</body>
</html>

