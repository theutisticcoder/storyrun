<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neon Run: Cyberpunk Story Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/localforage@1.10.0/dist/localforage.min.js"></script>
    <script type="module">
        import { EdgeTTS } from 'https://cdn.jsdelivr.net/npm/edge-tts-client@1.0.0/dist/index.min.js';
        import { createEpub } from 'https://cdn.jsdelivr.net/npm/jepub@1.0.0/dist/jepub.min.js';
        import JSZip from 'https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js';
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Rajdhani:wght@400;600&display=swap');

        body {
            font-family: 'Rajdhani', sans-serif;
            background: linear-gradient(135deg, #0a0a1a 0%, #1a1a3a 50%, #0a0a1a 100%);
            color: #e0e0e0;
            min-height: 100vh;
        }

        .neon-text {
            text-shadow: 0 0 5px #ef4444, 0 0 10px #ef4444;
        }

        .neon-text-green {
            text-shadow: 0 0 5px #10b981, 0 0 10px #10b981;
        }

        .neon-text-amber {
            text-shadow: 0 0 5px #f59e0b, 0 0 10px #f59e0b;
        }

        .glow {
            box-shadow: 0 0 10px rgba(239, 68, 68, 0.5);
        }

        .glow-green {
            box-shadow: 0 0 10px rgba(16, 185, 129, 0.5);
        }

        .glow-amber {
            box-shadow: 0 0 10px rgba(245, 158, 11, 0.5);
        }

        .cyberpunk-border {
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 8px;
            background: rgba(10, 10, 26, 0.7);
            backdrop-filter: blur(10px);
        }

        .terminal {
            font-family: 'Orbitron', monospace;
            line-height: 1.6;
        }

        .progress-bar {
            background: linear-gradient(90deg, #ef4444 0%, #f59e0b 50%, #10b981 100%);
        }

        .dashboard-metric {
            transition: all 0.3s ease;
        }

        #storyContainer {
            height: calc(100vh - 200px);
            overflow-y: auto;
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #1a1a3a;
        }

        ::-webkit-scrollbar-thumb {
            background: #ef4444;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #dc2626;
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-6xl mx-auto">
        <!-- Header Dashboard -->
        <header class="sticky top-0 z-50 mb-8 cyberpunk-border p-4">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                <div class="dashboard-metric">
                    <h3 class="text-sm text-gray-400 uppercase tracking-wider">Speed</h3>
                    <p id="speedDisplay" class="text-2xl font-bold neon-text">0.00 mph</p>
                </div>
                <div class="dashboard-metric">
                    <h3 class="text-sm text-gray-400 uppercase tracking-wider">Distance</h3>
                    <p id="distanceDisplay" class="text-2xl font-bold neon-text-green">0.00 mi</p>
                </div>
                <div class="dashboard-metric">
                    <h3 class="text-sm text-gray-400 uppercase tracking-wider">CO₂ Saved</h3>
                    <p id="co2Display" class="text-2xl font-bold neon-text-amber">0.00 kg</p>
                </div>
                <div class="dashboard-metric">
                    <h3 class="text-sm text-gray-400 uppercase tracking-wider">Narrative Intensity</h3>
                    <p id="intensityDisplay" class="text-2xl font-bold neon-text">Calm</p>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Left Panel - Controls -->
            <div class="lg:col-span-1 space-y-6">
                <!-- API Key Input -->
                <div class="cyberpunk-border p-4 glow">
                    <h2 class="text-xl font-bold mb-4 neon-text">API Configuration</h2>
                    <div class="space-y-3">
                        <div>
                            <label for="apiKey" class="block text-sm font-medium text-gray-300 mb-1">Groq/Llama API Key</label>
                            <input type="password" id="apiKey" class="w-full p-2 bg-gray-800 border border-gray-600 rounded focus:outline-none focus:border-red-500" placeholder="Enter your API key">
                        </div>
                        <div>
                            <label for="modelSelect" class="block text-sm font-medium text-gray-300 mb-1">Model</label>
                            <select id="modelSelect" class="w-full p-2 bg-gray-800 border border-gray-600 rounded focus:outline-none focus:border-red-500">
                                <option value="llama-3-70b-8192">Llama 3 70B</option>
                                <option value="llama-3-8b-8192">Llama 3 8B</option>
                                <option value="mixtral-8x7b-32768">Mixtral 8x7B</option>
                            </select>
                        </div>
                        <button id="saveApiBtn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded glow transition duration-300">
                            Save API Key
                        </button>
                    </div>
                </div>

                <!-- Speed Simulator -->
                <div class="cyberpunk-border p-4 glow-amber">
                    <h2 class="text-xl font-bold mb-4 neon-text-amber">Speed Simulator</h2>
                    <div class="space-y-4">
                        <input type="range" id="speedSlider" min="0" max="10" step="0.1" value="0" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer">
                        <div class="flex justify-between text-sm text-gray-400">
                            <span>0 m/s</span>
                            <span>10 m/s</span>
                        </div>
                        <div class="text-center">
                            <p class="text-lg font-semibold">Current: <span id="sliderSpeed">0.00</span> m/s (<span id="sliderMph">0.00</span> mph)</p>
                        </div>
                        <button id="toggleTracking" class="w-full bg-amber-600 hover:bg-amber-700 text-white font-bold py-2 px-4 rounded glow-amber transition duration-300">
                            Start GPS Tracking
                        </button>
                    </div>
                </div>

                <!-- Story Controls -->
                <div class="cyberpunk-border p-4 glow-green">
                    <h2 class="text-xl font-bold mb-4 neon-text-green">Story Controls</h2>
                    <div class="space-y-3">
                        <div>
                            <label for="storyTitle" class="block text-sm font-medium text-gray-300 mb-1">Story Title</label>
                            <input type="text" id="storyTitle" class="w-full p-2 bg-gray-800 border border-gray-600 rounded focus:outline-none focus:border-green-500" placeholder="Enter story title">
                        </div>
                        <div>
                            <label for="genreSelect" class="block text-sm font-medium text-gray-300 mb-1">Genre</label>
                            <select id="genreSelect" class="w-full p-2 bg-gray-800 border border-gray-600 rounded focus:outline-none focus:border-green-500">
                                <option value="cyberpunk">Cyberpunk</option>
                                <option value="sci-fi">Sci-Fi</option>
                                <option value="fantasy">Fantasy</option>
                                <option value="horror">Horror</option>
                                <option value="noir">Noir</option>
                            </select>
                        </div>
                        <button id="startStoryBtn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded glow-green transition duration-300">
                            Start New Story
                        </button>
                        <button id="continueStoryBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded glow transition duration-300">
                            Continue Last Story
                        </button>
                        <button id="exportEpubBtn" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded glow transition duration-300">
                            Export as EPUB
                        </button>
                    </div>
                </div>
            </div>

            <!-- Center Panel - Story Display -->
            <div class="lg:col-span-2 cyberpunk-border p-4">
                <h2 class="text-2xl font-bold mb-4 neon-text">Narrative Stream</h2>
                <div id="storyContainer" class="terminal text-sm leading-relaxed space-y-4 mb-6">
                    <p class="text-gray-400">Your story will appear here as you run. The narrative intensity adapts to your pace...</p>
                </div>

                <!-- Audio Player -->
                <div class="cyberpunk-border p-4 mb-4">
                    <h3 class="text-lg font-bold mb-2 neon-text">Audio Narration</h3>
                    <audio id="audioPlayer" controls class="w-full mb-2">
                        <source src="" type="audio/mpeg">
                        Your browser does not support the audio element.
                    </audio>
                    <div class="w-full bg-gray-700 rounded-full h-2.5">
                        <div id="audioProgress" class="bg-red-500 h-2.5 rounded-full progress-bar" style="width: 0%"></div>
                    </div>
                </div>

                <!-- Status Indicators -->
                <div class="flex justify-between text-sm">
                    <div id="gpsStatus" class="flex items-center">
                        <div class="w-3 h-3 rounded-full bg-red-500 mr-2"></div>
                        <span>GPS: Disconnected</span>
                    </div>
                    <div id="apiStatus" class="flex items-center">
                        <div class="w-3 h-3 rounded-full bg-red-500 mr-2"></div>
                        <span>API: Not Configured</span>
                    </div>
                    <div id="generationStatus" class="flex items-center">
                        <div class="w-3 h-3 rounded-full bg-red-500 mr-2"></div>
                        <span>Generation: Idle</span>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Global State
        const state = {
            apiKey: null,
            model: 'llama-3-70b-8192',
            storyTitle: '',
            genre: 'cyberpunk',
            currentStory: null,
            chapters: [],
            currentChapter: null,
            isGenerating: false,
            watchId: null,
            lastPosition: null,
            totalDistance: 0,
            co2Saved: 0,
            audioContext: null,
            audioBlob: null,
            audioUrl: null,
            ttsClient: null,
            isTracking: false,
            intensity: 'calm'
        };

        // DOM Elements
        const elements = {
            apiKey: document.getElementById('apiKey'),
            modelSelect: document.getElementById('modelSelect'),
            saveApiBtn: document.getElementById('saveApiBtn'),
            storyTitle: document.getElementById('storyTitle'),
            genreSelect: document.getElementById('genreSelect'),
            startStoryBtn: document.getElementById('startStoryBtn'),
            continueStoryBtn: document.getElementById('continueStoryBtn'),
            exportEpubBtn: document.getElementById('exportEpubBtn'),
            speedSlider: document.getElementById('speedSlider'),
            sliderSpeed: document.getElementById('sliderSpeed'),
            sliderMph: document.getElementById('sliderMph'),
            toggleTracking: document.getElementById('toggleTracking'),
            storyContainer: document.getElementById('storyContainer'),
            audioPlayer: document.getElementById('audioPlayer'),
            audioProgress: document.getElementById('audioProgress'),
            speedDisplay: document.getElementById('speedDisplay'),
            distanceDisplay: document.getElementById('distanceDisplay'),
            co2Display: document.getElementById('co2Display'),
            intensityDisplay: document.getElementById('intensityDisplay'),
            gpsStatus: document.getElementById('gpsStatus'),
            apiStatus: document.getElementById('apiStatus'),
            generationStatus: document.getElementById('generationStatus')
        };

        // Initialize the app
        async function init() {
            // Load saved state
            await loadState();

            // Set up event listeners
            setupEventListeners();

            // Initialize TTS client
            state.ttsClient = new EdgeTTS();

            // Update UI based on loaded state
            updateUI();
        }

        // Load saved state from localForage
        async function loadState() {
            try {
                const savedState = await localforage.getItem('neonRunState');
                if (savedState) {
                    Object.assign(state, savedState);
                }

                // Load API key separately for security
                const savedApiKey = await localforage.getItem('neonRunApiKey');
                if (savedApiKey) {
                    state.apiKey = savedApiKey;
                    elements.apiKey.value = '••••••••••••';
                }
            } catch (error) {
                console.error('Error loading state:', error);
            }
        }

        // Save state to localForage
        async function saveState() {
            try {
                // Save everything except API key
                const stateToSave = {...state};
                delete stateToSave.apiKey;
                await localforage.setItem('neonRunState', stateToSave);

                // Save API key separately if it exists
                if (state.apiKey) {
                    await localforage.setItem('neonRunApiKey', state.apiKey);
                }
            } catch (error) {
                console.error('Error saving state:', error);
            }
        }

        // Set up event listeners
        function setupEventListeners() {
            // API Configuration
            elements.saveApiBtn.addEventListener('click', () => {
                const key = elements.apiKey.value;
                if (key === '••••••••••••') {
                    // User wants to keep existing key
                    showStatus('API key unchanged', 'apiStatus', 'green');
                    return;
                }

                if (key.trim() === '') {
                    showStatus('Please enter an API key', 'apiStatus', 'red');
                    return;
                }

                state.apiKey = key;
                elements.apiKey.value = '••••••••••••';
                showStatus('API key saved', 'apiStatus', 'green');
                saveState();
            });

            elements.modelSelect.addEventListener('change', () => {
                state.model = elements.modelSelect.value;
                saveState();
            });

            // Story Controls
            elements.startStoryBtn.addEventListener('click', startNewStory);
            elements.continueStoryBtn.addEventListener('click', continueLastStory);
            elements.exportEpubBtn.addEventListener('click', exportAsEpub);

            // Speed Simulator
            elements.speedSlider.addEventListener('input', (e) => {
                const speed = parseFloat(e.target.value);
                elements.sliderSpeed.textContent = speed.toFixed(2);
                elements.sliderMph.textContent = (speed * 2.237).toFixed(2);
                updateNarrativeIntensity(speed);
            });

            // GPS Tracking
            elements.toggleTracking.addEventListener('click', toggleGpsTracking);

            // Audio Player
            elements.audioPlayer.addEventListener('timeupdate', () => {
                const progress = (elements.audioPlayer.currentTime / elements.audioPlayer.duration) * 100;
                elements.audioProgress.style.width = `${progress}%`;
            });
        }

        // Toggle GPS tracking
        function toggleGpsTracking() {
            if (state.isTracking) {
                stopGpsTracking();
            } else {
                startGpsTracking();
            }
        }

        // Start GPS tracking
        function startGpsTracking() {
            if (!navigator.geolocation) {
                showStatus('Geolocation not supported', 'gpsStatus', 'red');
                return;
            }

            state.isTracking = true;
            elements.toggleTracking.textContent = 'Stop GPS Tracking';
            elements.toggleTracking.classList.remove('bg-amber-600', 'hover:bg-amber-700', 'glow-amber');
            elements.toggleTracking.classList.add('bg-red-600', 'hover:bg-red-700', 'glow');

            state.watchId = navigator.geolocation.watchPosition(
                (position) => {
                    handlePositionUpdate(position);
                },
                (error) => {
                    console.error('Geolocation error:', error);
                    showStatus('GPS Error', 'gpsStatus', 'red');
                },
                {
                    enableHighAccuracy: true,
                    maximumAge: 0,
                    timeout: 5000
                }
            );

            showStatus('GPS: Tracking', 'gpsStatus', 'green');
        }

        // Stop GPS tracking
        function stopGpsTracking() {
            if (state.watchId) {
                navigator.geolocation.clearWatch(state.watchId);
                state.watchId = null;
            }

            state.isTracking = false;
            elements.toggleTracking.textContent = 'Start GPS Tracking';
            elements.toggleTracking.classList.remove('bg-red-600', 'hover:bg-red-700', 'glow');
            elements.toggleTracking.classList.add('bg-amber-600', 'hover:bg-amber-700', 'glow-amber');

            showStatus('GPS: Disconnected', 'gpsStatus', 'red');
        }

        // Handle position updates
        function handlePositionUpdate(position) {
            const { latitude, longitude, speed, accuracy } = position.coords;

            if (!state.lastPosition) {
                state.lastPosition = { latitude, longitude, timestamp: position.timestamp };
                return;
            }

            // Calculate speed (convert from m/s to mph)
            const currentSpeed = speed ? speed * 2.237 : 0;
            elements.speedDisplay.textContent = `${currentSpeed.toFixed(2)} mph`;

            // Calculate distance traveled
            const distance = calculateDistance(
                state.lastPosition.latitude,
                state.lastPosition.longitude,
                latitude,
                longitude
            );

            state.totalDistance += distance;
            elements.distanceDisplay.textContent = `${state.totalDistance.toFixed(2)} mi`;

            // Calculate CO2 savings (assuming 0.4 kg CO2 per mile for a car)
            state.co2Saved = state.totalDistance * 0.4;
            elements.co2Display.textContent = `${state.co2Saved.toFixed(2)} kg`;

            // Update last position
            state.lastPosition = { latitude, longitude, timestamp: position.timestamp };

            // Update narrative intensity
            updateNarrativeIntensity(speed || 0);

            // Save state
            saveState();
        }

        // Calculate distance between two points (Haversine formula)
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // Earth radius in meters
            const φ1 = lat1 * Math.PI / 180;
            const φ2 = lat2 * Math.PI / 180;
            const Δφ = (lat2 - lat1) * Math.PI / 180;
            const Δλ = (lon2 - lon1) * Math.PI / 180;

            const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
                      Math.cos(φ1) * Math.cos(φ2) *
                      Math.sin(Δλ/2) * Math.sin(Δλ/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

            // Convert to miles
            return (R * c) * 0.000621371;
        }

        // Update narrative intensity based on speed
        function updateNarrativeIntensity(speed) {
            let intensity;
            let colorClass;
            let glowClass;

            if (speed > 4.5) {
                intensity = 'High Tension';
                colorClass = 'neon-text';
                glowClass = 'glow';
            } else if (speed > 2.5) {
                intensity = 'Rising Action';
                colorClass = 'neon-text-amber';
                glowClass = 'glow-amber';
            } else {
                intensity = 'Calm';
                colorClass = 'neon-text-green';
                glowClass = 'glow-green';
            }

            state.intensity = intensity.toLowerCase().replace(' ', '-');
            elements.intensityDisplay.textContent = intensity;

            // Update color classes
            elements.intensityDisplay.className = `text-2xl font-bold ${colorClass}`;
            elements.intensityDisplay.parentElement.classList.remove('glow', 'glow-amber', 'glow-green');
            elements.intensityDisplay.parentElement.classList.add(glowClass);

            // If we have an active story, generate a new chapter based on intensity change
            if (state.currentStory && !state.isGenerating) {
                generateChapter();
            }
        }

        // Start a new story
        async function startNewStory() {
            const title = elements.storyTitle.value.trim();
            const genre = elements.genreSelect.value;

            if (!title) {
                alert('Please enter a story title');
                return;
            }

            if (!state.apiKey) {
                alert('Please configure your API key first');
                return;
            }

            // Reset story state
            state.currentStory = {
                id: Date.now().toString(),
                title,
                genre,
                chapters: [],
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };

            state.chapters = [];
            state.currentChapter = null;
            state.totalDistance = 0;
            state.co2Saved = 0;

            // Update UI
            elements.storyTitle.value = '';
            elements.storyContainer.innerHTML = `
                <h3 class="text-xl font-bold neon-text mb-2">${title}</h3>
                <p class="text-gray-400">Genre: ${genre}</p>
                <hr class="border-gray-600 my-4">
                <p class="text-gray-400">Beginning your journey...</p>
            `;

            // Save state
            await saveState();

            // Generate first chapter
            await generateChapter();

            showStatus('Story started', 'generationStatus', 'green');
        }

        // Continue last story
        async function continueLastStory() {
            if (!state.currentStory) {
                alert('No story to continue');
                return;
            }

            // Load the story
            elements.storyContainer.innerHTML = `
                <h3 class="text-xl font-bold neon-text mb-2">${state.currentStory.title}</h3>
                <p class="text-gray-400">Genre: ${state.currentStory.genre}</p>
                <hr class="border-gray-600 my-4">
            `;

            // Display all chapters
            state.currentStory.chapters.forEach(chapter => {
                elements.storyContainer.innerHTML += `
                    <div class="mb-6">
                        <h4 class="text-lg font-semibold neon-text mb-2">Chapter ${chapter.number}: ${chapter.title}</h4>
                        <div class="terminal text-sm">${chapter.content}</div>
                    </div>
                `;
            });

            showStatus('Story loaded', 'generationStatus', 'green');
        }

        // Generate a new chapter
        async function generateChapter() {
            if (state.isGenerating || !state.currentStory) return;

            state.isGenerating = true;
            showStatus('Generating chapter...', 'generationStatus', 'amber');

            try {
                const chapterNumber = state.currentStory.chapters.length + 1;
                const prompt = createChapterPrompt(chapterNumber);

                // Simulate API call (in a real app, this would be a fetch to Groq/Llama API)
                const chapterContent = await generateChapterContent(prompt);

                // Create chapter object
                const chapter = {
                    number: chapterNumber,
                    title: `Chapter ${chapterNumber}`,
                    content: chapterContent,
                    intensity: state.intensity,
                    distance: state.totalDistance,
                    speed: parseFloat(elements.speedDisplay.textContent),
                    generatedAt: new Date().toISOString()
                };

                // Add to story
                state.currentStory.chapters.push(chapter);
                state.currentStory.updatedAt = new Date().toISOString();
                state.currentChapter = chapter;

                // Update UI
                elements.storyContainer.innerHTML += `
                    <div class="mb-6">
                        <h4 class="text-lg font-semibold neon-text mb-2">Chapter ${chapterNumber}: ${chapter.title}</h4>
                        <div class="terminal text-sm">${chapter.content}</div>
                    </div>
                `;

                // Generate audio
                await generateAudio(chapter.content);

                // Save state
                await saveState();

                showStatus('Chapter generated', 'generationStatus', 'green');
            } catch (error) {
                console.error('Error generating chapter:', error);
                showStatus('Generation failed', 'generationStatus', 'red');
            } finally {
                state.isGenerating = false;
            }
        }

        // Create prompt for chapter generation
        function createChapterPrompt(chapterNumber) {
            const { title, genre, chapters } = state.currentStory;
            const lastChapter = chapters[chapters.length - 1] || null;

            return `
You are a master storyteller crafting an immersive ${genre} narrative titled "${title}".
The story adapts to the runner's pace in real-time. Current narrative intensity: ${state.intensity}.

${lastChapter ? `
Previous chapter summary:
${lastChapter.content.substring(0, 500)}...
` : ''}

Write Chapter ${chapterNumber} of this story (20+ paragraphs). The chapter should:
1. Continue the narrative from where it left off (or begin the story if this is Chapter 1)
2. Match the current intensity level (${state.intensity})
3. Include vivid descriptions, dialogue, and action appropriate for a ${genre} story
4. End on a hook that sets up the next chapter
5. Be approximately 1000-1500 words

Current runner stats:
- Speed: ${elements.speedDisplay.textContent}
- Distance: ${elements.distanceDisplay.textContent}
- CO2 Saved: ${elements.co2Display.textContent}

Begin the chapter with an engaging opening that reflects the current intensity.
            `;
        }

        // Simulate chapter generation (replace with actual API call)
        async function generateChapterContent(prompt) {
            // In a real implementation, this would be:
            // const response = await fetch('https://api.groq.com/v1/chat/completions', {
            //     method: 'POST',
            //     headers: {
            //         'Authorization': `Bearer ${state.apiKey}`,
            //         'Content-Type': 'application/json'
            //     },
            //     body: JSON.stringify({
            //         model: state.model,
            //         messages: [{ role: 'user', content: prompt }],
            //         max_tokens: 2000
            //     })
            // });
            // const data = await response.json();
            // return data.choices[0].message.content;

            // For demo purposes, generate a placeholder chapter
            return `
The neon lights of Neo-Tokyo flickered like dying stars as Kaito sprinted through the rain-slicked streets.
His cybernetic legs hummed with each stride, the servos whirring in perfect sync with his breathing.
The city's pulse throbbed around him - holographic billboards advertising corporate paradise,
the distant wail of police drones, the ever-present scent of ozone and fried noodles.

Kaito glanced at his wrist display. The tracker showed his current speed at ${elements.speedDisplay.textContent},
enough to leave most street-level enforcers in the dust. But not enough to outrun the Black Lotus syndicate.
His last heist had gone sideways, and now he carried data that could dismantle their entire operation.

The intensity of the chase matched his pace - ${state.intensity}. His heart rate monitor flashed amber,
syncing with the rhythm of the city. Somewhere in this concrete jungle, they were waiting.
The question wasn't if they'd find him, but when.

Kaito ducked into a narrow alley, the glow of bioluminescent graffiti lighting his path.
The walls seemed to breathe with augmented reality tags, remnants of a thousand forgotten stories.
He paused for a moment, catching his breath, listening to the distant hum of the city.

This was where the real story began...
            `.repeat(5); // Repeat to get enough paragraphs
        }

        // Generate audio narration
        async function generateAudio(text) {
            try {
                showStatus('Generating audio...', 'generationStatus', 'amber');

                // Clean up previous audio
                if (state.audioUrl) {
                    URL.revokeObjectURL(state.audioUrl);
                }

                // Generate audio using Edge TTS
                const audioStream = await state.ttsClient.generateAudio({
                    text: text,
                    voice: 'en-US-JennyNeural',
                    rate: '+10%',
                    volume: '+0%'
                });

                // Convert stream to blob
                const audioChunks = [];
                const reader = audioStream.getReader();

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    audioChunks.push(value);
                }

                const audioBlob = new Blob(audioChunks, { type: 'audio/mpeg' });
                state.audioBlob = audioBlob;
                state.audioUrl = URL.createObjectURL(audioBlob);

                // Update audio player
                elements.audioPlayer.src = state.audioUrl;
                elements.audioPlayer.load();

                showStatus('Audio ready', 'generationStatus', 'green');
            } catch (error) {
                console.error('Error generating audio:', error);
                showStatus('Audio generation failed', 'generationStatus', 'red');
            }
        }

        // Export story as EPUB
        async function exportAsEpub() {
            if (!state.currentStory || state.currentStory.chapters.length === 0) {
                alert('No story to export');
                return;
            }

            try {
                showStatus('Preparing EPUB...', 'generationStatus', 'amber');

                // Create EPUB structure
                const epub = {
                    title: state.currentStory.title,
                    author: 'Neon Run AI',
                    content: []
                };

                // Add cover page
                epub.content.push({
                    id: 'cover',
                    title: 'Cover',
                    content: `
                        <html>
                            <head><title>Cover</title></head>
                            <body>
                                <h1 style="text-align: center; color: #ef4444;">${state.currentStory.title}</h1>
                                <p style="text-align: center; color: #10b981;">A Cyberpunk Narrative Generated by Neon Run</p>
                                <p style="text-align: center; color: #f59e0b;">Based on your run data</p>
                            </body>
                        </html>
                    `,
                    order: 0
                });

                // Add introduction
                epub.content.push({
                    id: 'intro',
                    title: 'Introduction',
                    content: `
                        <html>
                            <head><title>Introduction</title></head>
                            <body>
                                <h2>Run Data</h2>
                                <p>This story was generated based on your running session:</p>
                                <ul>
                                    <li>Total Distance: ${state.totalDistance.toFixed(2)} miles</li>
                                    <li>CO₂ Saved: ${state.co2Saved.toFixed(2)} kg</li>
                                    <li>Genre: ${state.currentStory.genre}</li>
                                    <li>Generated: ${new Date(state.currentStory.createdAt).toLocaleString()}</li>
                                </ul>
                            </body>
                        </html>
                    `,
                    order: 1
                });

                // Add chapters
                state.currentStory.chapters.forEach((chapter, index) => {
                    epub.content.push({
                        id: `chapter-${index + 1}`,
                        title: chapter.title,
                        content: `
                            <html>
                                <head><title>${chapter.title}</title></head>
                                <body>
                                    <h2>${chapter.title}</h2>
                                    <p><em>Generated at ${new Date(chapter.generatedAt).toLocaleString()}</em></p>
                                    <p><em>Runner speed: ${chapter.speed} mph | Intensity: ${chapter.intensity}</em></p>
                                    <div>${chapter.content}</div>
                                </body>
                            </html>
                        `,
                        order: index + 2
                    });
                });

                // Create EPUB file
                const zip = new JSZip();
                const epubData = createEpub(epub);
                zip.file('story.epub', epubData);

                // Generate download
                const content = await zip.generateAsync({ type: 'blob' });
                const url = URL.createObjectURL(content);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${state.currentStory.title.replace(/\s+/g, '_')}.epub`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                showStatus('EPUB exported', 'generationStatus', 'green');
            } catch (error) {
                console.error('Error exporting EPUB:', error);
                showStatus('EPUB export failed', 'generationStatus', 'red');
            }
        }

        // Update UI based on current state
        function updateUI() {
            if (state.apiKey) {
                showStatus('API: Configured', 'apiStatus', 'green');
            } else {
                showStatus('API: Not Configured', 'apiStatus', 'red');
            }

            if (state.isTracking) {
                showStatus('GPS: Tracking', 'gpsStatus', 'green');
            } else {
                showStatus('GPS: Disconnected', 'gpsStatus', 'red');
            }

            if (state.currentStory) {
                elements.continueStoryBtn.disabled = false;
                elements.continueStoryBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            } else {
                elements.continueStoryBtn.disabled = true;
                elements.continueStoryBtn.classList.add('opacity-50', 'cursor-not-allowed');
            }
        }

        // Show status message
        function showStatus(message, elementId, color) {
            const element = document.getElementById(elementId);
            const dot = element.querySelector('div');
            const text = element.querySelector('span');

            text.textContent = message;

            // Update dot color
            dot.classList.remove('bg-red-500', 'bg-amber-500', 'bg-green-500');
            dot.classList.add(`bg-${color}-500`);
        }

        // Initialize the app when DOM is loaded
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>