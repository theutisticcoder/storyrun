<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyJourneyAI - Cyberpunk Narrative Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Rajdhani:wght@300;500;700&family=Crimson+Pro:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --neon-blue: #00f3ff;
            --neon-pink: #ff00ff;
            --cyber-bg: #050505;
        }
        body {
            background-color: var(--cyber-bg);
            color: #e2e8f0;
            font-family: 'Rajdhani', sans-serif;
        }
        .literary-font {
            font-family: 'Crimson Pro', serif;
        }
        .drop-cap::first-letter {
            float: left;
            font-family: 'Orbitron', sans-serif;
            font-size: 3.5rem;
            line-height: 0.8;
            padding-right: 8px;
            color: var(--neon-blue);
            text-shadow: 0 0 10px var(--neon-blue);
        }
        .shimmer {
            background: linear-gradient(90deg, #1a1a1a 25%, #2a2a2a 50%, #1a1a1a 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        .cyber-border {
            border: 1px solid rgba(0, 243, 255, 0.3);
            box-shadow: 0 0 15px rgba(0, 243, 255, 0.1);
        }
        .scanline {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 2px;
            background: rgba(0, 243, 255, 0.1);
            z-index: 100;
            pointer-events: none;
            animation: scan 8s linear infinite;
        }
        @keyframes scan {
            0% { top: 0; }
            100% { top: 100%; }
        }
    </style>
</head>
<body class="overflow-x-hidden">
    <div class="scanline"></div>

    <!-- Navigation -->
    <nav class="p-6 flex justify-between items-center border-b border-cyan-900/50 bg-black/80 sticky top-0 z-50">
        <h1 class="text-3xl font-bold tracking-tighter text-cyan-400 font-['Orbitron']">MYJOURNEY.AI</h1>
        <div class="flex gap-4">
            <button onclick="viewManager.showDashboard()" class="px-4 py-2 text-xs border border-cyan-500 text-cyan-500 hover:bg-cyan-500/20 transition-all uppercase tracking-widest">Saved Stories</button>
            <button onclick="viewManager.showActive()" class="px-4 py-2 text-xs bg-cyan-600 text-black font-bold hover:bg-cyan-400 transition-all uppercase tracking-widest">Active Run</button>
        </div>
    </nav>

    <main id="app-content" class="container mx-auto px-4 py-8 pb-32">
        <!-- Dashboard / Saved Stories (Hidden by default) -->
        <div id="dashboard-view" class="hidden">
            <h2 class="text-2xl font-['Orbitron'] mb-8 text-pink-500">RESUME YOUR ADVENTURES</h2>
            <div id="saved-stories-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Saved items injected here -->
            </div>
        </div>

        <!-- Active Workout View -->
        <div id="active-view">
            <!-- Metrics Bar -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                <div class="cyber-border p-4 bg-black/40">
                    <p class="text-[10px] text-cyan-500 uppercase">Current Velocity</p>
                    <p id="stat-speed" class="text-4xl font-bold font-['Orbitron']">0.0 <span class="text-sm font-normal">MPH</span></p>
                </div>
                <div class="cyber-border p-4 bg-black/40">
                    <p class="text-[10px] text-pink-500 uppercase">Distance Traversed</p>
                    <p id="stat-distance" class="text-4xl font-bold font-['Orbitron']">0.00 <span class="text-sm font-normal">MI</span></p>
                </div>
                <div class="cyber-border p-4 bg-black/40">
                    <p class="text-[10px] text-yellow-500 uppercase">CO2 Offset</p>
                    <p id="stat-co2" class="text-4xl font-bold font-['Orbitron']">0.0 <span class="text-sm font-normal">G</span></p>
                </div>
                <div class="cyber-border p-4 bg-black/40">
                    <p class="text-[10px] text-purple-500 uppercase">Time Elapsed</p>
                    <p id="stat-timer" class="text-4xl font-bold font-['Orbitron']">00:00</p>
                </div>
            </div>

            <!-- Simulation Controls -->
            <div class="mb-12 p-4 bg-white/5 rounded-lg border border-white/10">
                <label class="block text-xs uppercase tracking-widest text-gray-400 mb-2">MPH Simulator (Manual Override)</label>
                <input type="range" id="speed-slider" min="0" max="15" step="0.1" value="0" class="w-full h-2 bg-gray-800 rounded-lg appearance-none cursor-pointer accent-cyan-400">
                <div class="flex justify-between text-[10px] mt-1 text-gray-500">
                    <span>WALK</span>
                    <span>JOG</span>
                    <span>SPRINT</span>
                </div>
            </div>

            <!-- Chapter Feed -->
            <div id="chapter-feed" class="max-w-3xl mx-auto space-y-12">
                <!-- Chapters injected here -->
            </div>

            <!-- Loader -->
            <div id="narrative-loader" class="hidden max-w-3xl mx-auto mt-8">
                <div class="shimmer h-4 w-3/4 mb-4 rounded"></div>
                <div class="shimmer h-4 w-full mb-4 rounded"></div>
                <div class="shimmer h-4 w-5/6 mb-4 rounded"></div>
                <p class="text-center text-xs text-cyan-400 font-['Orbitron'] animate-pulse">SYNCHRONIZING NEURAL UPLINK...</p>
            </div>
        </div>
    </main>

    <!-- Bottom Controls Overlay -->
    <div class="fixed bottom-0 left-0 w-full p-4 bg-black/90 border-t border-cyan-500/30 backdrop-blur-md z-40">
        <div class="container mx-auto flex items-center justify-between">
            <div class="flex items-center gap-4">
                <button id="btn-session" onclick="sessionManager.toggleSession()" class="bg-red-600/20 text-red-500 border border-red-500 px-6 py-2 font-bold uppercase text-sm hover:bg-red-600 hover:text-white transition-all">Start Run</button>
                <button onclick="sessionManager.saveAndExit()" class="border border-gray-600 text-gray-400 px-6 py-2 uppercase text-sm hover:bg-gray-800">Save & Exit</button>
            </div>
            <div class="hidden md:flex items-center gap-2 text-xs text-cyan-500/50 italic">
                <span id="status-text">SYSTEM IDLE // WAITING FOR BIOMETRICS</span>
            </div>
        </div>
    </div>

    <script type="module">
        const apiKey = ""; // Environment handles this
        
        // --- State Management ---
        const state = {
            isRunning: false,
            startTime: null,
            elapsedSeconds: 0,
            distance: 0,
            currentSpeed: 0,
            chapters: [],
            lastChapterTime: 0,
            sessionId: null,
            chapterInterval: 600 // 10 minutes in seconds
        };

        // --- View Manager ---
        window.viewManager = {
            showDashboard: async () => {
                document.getElementById('dashboard-view').classList.remove('hidden');
                document.getElementById('active-view').classList.add('hidden');
                await sessionManager.renderSavedStories();
            },
            showActive: () => {
                document.getElementById('active-view').classList.remove('hidden');
                document.getElementById('dashboard-view').classList.add('hidden');
            }
        };

        // --- Session Manager ---
        window.sessionManager = {
            init: async () => {
                const activeId = await localforage.getItem('active_session_id');
                if (activeId) {
                    const savedState = await localforage.getItem(`session_${activeId}`);
                    if (savedState) {
                        Object.assign(state, savedState);
                        this.renderChapters();
                        this.updateStatsUI();
                        document.getElementById('btn-session').innerText = state.isRunning ? "Pause Run" : "Resume Run";
                        if(state.isRunning) sessionManager.startLoop();
                    }
                }
            },
            toggleSession: () => {
                state.isRunning = !state.isRunning;
                if (state.isRunning) {
                    if (!state.sessionId) state.sessionId = Date.now().toString();
                    state.startTime = Date.now() - (state.elapsedSeconds * 1000);
                    document.getElementById('btn-session').innerText = "Pause Run";
                    document.getElementById('btn-session').classList.replace('text-red-500', 'text-yellow-500');
                    document.getElementById('status-text').innerText = "LINK ESTABLISHED // NARRATIVE ENGAGED";
                    sessionManager.startLoop();
                    
                    // Trigger first chapter immediately if empty
                    if (state.chapters.length === 0) {
                        narrativeEngine.generateChapter();
                    }
                } else {
                    document.getElementById('btn-session').innerText = "Resume Run";
                    document.getElementById('status-text').innerText = "LINK SUSPENDED // DATA PERSISTED";
                }
            },
            startLoop: () => {
                if (this._loop) clearInterval(this._loop);
                this._loop = setInterval(() => {
                    if (!state.isRunning) return;
                    
                    state.elapsedSeconds = Math.floor((Date.now() - state.startTime) / 1000);
                    
                    // Update distance based on speed (mph to miles per second)
                    const milesPerSecond = state.currentSpeed / 3600;
                    state.distance += milesPerSecond;
                    
                    sessionManager.updateStatsUI();
                    sessionManager.autoSave();

                    // Check for 10 min interval
                    if (state.elapsedSeconds - state.lastChapterTime >= state.chapterInterval) {
                        narrativeEngine.generateChapter();
                    }
                }, 1000);
            },
            updateStatsUI: () => {
                document.getElementById('stat-speed').innerHTML = `${state.currentSpeed.toFixed(1)} <span class="text-sm font-normal">MPH</span>`;
                document.getElementById('stat-distance').innerHTML = `${state.distance.toFixed(2)} <span class="text-sm font-normal">MI</span>`;
                document.getElementById('stat-co2').innerHTML = `${(state.distance * 404).toFixed(0)} <span class="text-sm font-normal">G</span>`;
                
                const h = Math.floor(state.elapsedSeconds / 3600).toString().padStart(2, '0');
                const m = Math.floor((state.elapsedSeconds % 3600) / 60).toString().padStart(2, '0');
                const s = (state.elapsedSeconds % 60).toString().padStart(2, '0');
                document.getElementById('stat-timer').innerText = `${m}:${s}`;
            },
            autoSave: async () => {
                if (!state.sessionId) return;
                await localforage.setItem(`session_${state.sessionId}`, state);
                await localforage.setItem('active_session_id', state.sessionId);
            },
            saveAndExit: async () => {
                state.isRunning = false;
                await sessionManager.autoSave();
                window.location.reload();
            },
            renderSavedStories: async () => {
                const list = document.getElementById('saved-stories-list');
                list.innerHTML = '';
                const keys = await localforage.keys();
                for (const key of keys) {
                    if (key.startsWith('session_')) {
                        const s = await localforage.getItem(key);
                        const card = document.createElement('div');
                        card.className = "cyber-border p-6 bg-black/60 cursor-pointer hover:bg-cyan-900/10 transition-all";
                        card.innerHTML = `
                            <h3 class="font-['Orbitron'] text-cyan-400 mb-2">RUN_${s.sessionId}</h3>
                            <p class="text-xs text-gray-500 uppercase">${s.chapters.length} CHAPTERS // ${s.distance.toFixed(2)} MILES</p>
                            <button onclick="sessionManager.loadSession('${s.sessionId}')" class="mt-4 text-[10px] text-pink-500 border border-pink-500 px-3 py-1 uppercase font-bold">Infiltrate Memory</button>
                        `;
                        list.appendChild(card);
                    }
                }
            },
            loadSession: async (id) => {
                const s = await localforage.getItem(`session_${id}`);
                Object.assign(state, s);
                state.isRunning = false; // Start paused
                await localforage.setItem('active_session_id', id);
                viewManager.showActive();
                sessionManager.renderChapters();
                sessionManager.updateStatsUI();
                document.getElementById('btn-session').innerText = "Resume Run";
            },
            renderChapters: () => {
                const feed = document.getElementById('chapter-feed');
                feed.innerHTML = '';
                state.chapters.forEach(ch => {
                    const el = document.createElement('article');
                    el.className = "border-l-2 border-cyan-500/30 pl-8 relative";
                    el.innerHTML = `
                        <div class="absolute -left-[9px] top-0 w-4 h-4 rounded-full bg-cyan-500 shadow-[0_0_10px_#00f3ff]"></div>
                        <h4 class="text-[10px] font-['Orbitron'] text-cyan-500 mb-4 tracking-[0.3em]">PHASE_${ch.id}</h4>
                        <p class="literary-font text-xl leading-relaxed text-gray-300 drop-cap">${ch.text}</p>
                        ${ch.audio ? `<button onclick="narrativeEngine.playAudio('${ch.id}')" class="mt-4 flex items-center gap-2 text-xs text-pink-400 hover:text-pink-300 transition-colors uppercase tracking-widest"><svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg> Play Audio Log</button>` : ''}
                    `;
                    feed.prepend(el);
                });
            }
        };

        // --- Narrative Engine (AI + TTS) ---
        window.narrativeEngine = {
            generateChapter: async () => {
                const loader = document.getElementById('narrative-loader');
                loader.classList.remove('hidden');
                
                const intensity = state.currentSpeed > 7 ? 'sprinting' : (state.currentSpeed > 3 ? 'running' : 'walking');
                const context = state.chapters.map(c => c.text).join('\n').slice(-1000);
                
                const prompt = `
                    Continue a cyberpunk sci-fi story in the second person ("You"). 
                    The protagonist is currently moving at a ${intensity} pace.
                    ${intensity === 'walking' ? 'Style: Highly atmospheric, descriptive, world-building, focusing on neon details and grit.' : ''}
                    ${intensity === 'running' ? 'Style: Balanced, forward-moving, observant of surroundings but focused on the mission.' : ''}
                    ${intensity === 'sprinting' ? 'Style: Punchy, high-tension, fragmented sentences, heart-pounding action, immediate threats.' : ''}
                    Strict Rules:
                    - Do NOT mention speed, MPH, miles, or the word "exercise".
                    - Do NOT mention physical workout or tracking.
                    - Stay entirely in the fictional world.
                    - Keep it to 120-150 words.
                    - Previous context: ${context}
                `;

                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: prompt }] }]
                        })
                    });

                    const data = await response.json();
                    const text = data.candidates[0].content.parts[0].text.trim();
                    
                    const chapterId = state.chapters.length + 1;
                    const newChapter = { id: chapterId, text, audio: null };
                    
                    // Trigger TTS (Simulated for this demo using built-in Web Speech API or simple logic)
                    // In a production environment with edge-tts-client, we would generate a Blob here.
                    // For the sake of this artifact's portability, we'll use synthesis.
                    
                    state.chapters.push(newChapter);
                    state.lastChapterTime = state.elapsedSeconds;
                    
                    sessionManager.renderChapters();
                    sessionManager.autoSave();
                    
                    // Simple synthesized audio generation for "persistence" simulation
                    this.synthesizeAudio(newChapter);
                    
                } catch (err) {
                    console.error("Narrative Error:", err);
                } finally {
                    loader.classList.add('hidden');
                }
            },
            synthesizeAudio: (chapter) => {
                // To simulate storing a "Blob", we'll mark it as having audio
                // In actual Edge-TTS implementation, we'd save a base64 string or blob to IndexedDB
                chapter.audio = true; 
                sessionManager.autoSave();
            },
            playAudio: (id) => {
                const ch = state.chapters.find(c => c.id == id);
                if (ch) {
                    const utterance = new SpeechSynthesisUtterance(ch.text);
                    utterance.rate = 0.9;
                    utterance.pitch = 0.8;
                    speechSynthesis.speak(utterance);
                }
            }
        };

        // --- Speed Sensors ---
        const speedSlider = document.getElementById('speed-slider');
        speedSlider.addEventListener('input', (e) => {
            state.currentSpeed = parseFloat(e.target.value);
            sessionManager.updateStatsUI();
        });

        if ("geolocation" in navigator) {
            navigator.geolocation.watchPosition((pos) => {
                // Convert m/s to mph
                if (!speedSlider.value || speedSlider.value == 0) {
                    const speedMph = (pos.coords.speed || 0) * 2.23694;
                    state.currentSpeed = speedMph;
                    sessionManager.updateStatsUI();
                }
            }, (err) => {
                console.warn("GPS Access Denied - Using Manual Simulator Only");
            }, { enableHighAccuracy: true });
        }

        // --- Initialize ---
        window.addEventListener('load', () => {
            sessionManager.init();
        });

    </script>
</body>
</html>

