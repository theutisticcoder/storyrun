<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StoryRunner Pro | AI Audio Narrator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Crimson+Pro:ital,wght@0,400;0,700;1,400&family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #020617; }
        .serif { font-family: 'Crimson Pro', serif; }
        .glass { background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.1); }
        
        .spinner {
            border: 3px solid rgba(16, 185, 129, 0.2);
            border-top: 3px solid #10b981;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .audio-pulse { animation: pulse 1.5s ease-in-out infinite; }
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 0.5; }
            50% { transform: scale(1.1); opacity: 1; }
        }

        /* Ensure interactive elements are touch-friendly */
        button, textarea { touch-action: manipulation; }
    </style>
</head>
<body class="text-slate-100 min-h-screen selection:bg-emerald-500/30">

    <div id="app" class="max-w-xl mx-auto min-h-screen flex flex-col p-4 md:p-8">
        <!-- Setup Screen -->
        <div id="setup-screen" class="space-y-6 py-8">
            <header class="text-center space-y-2">
                <div class="inline-block p-3 bg-emerald-500/10 rounded-full mb-2">
                    <svg class="w-8 h-8 text-emerald-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                </div>
                <h1 class="text-5xl font-black tracking-tighter text-white uppercase italic">Story<span class="text-emerald-500">Stride</span></h1>
                <p class="text-slate-400 font-medium italic">Narrated sagas synced to your pace.</p>
            </header>

            <div class="space-y-4">
                <label class="block text-xs font-black uppercase tracking-[0.2em] text-slate-500">Choose Your Reality</label>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="setGenre('Cyberpunk Fugitive')" class="genre-btn group p-4 rounded-2xl bg-slate-900 border-2 border-emerald-500 transition-all text-left">
                        <span class="text-2xl mb-1 block">üèôÔ∏è</span>
                        <span class="font-bold block group-hover:text-emerald-400">Cyberpunk</span>
                    </button>
                    <button onclick="setGenre('Grim Fantasy Quest')" class="genre-btn group p-4 rounded-2xl bg-slate-900 border-2 border-slate-800 hover:border-emerald-500 transition-all text-left">
                        <span class="text-2xl mb-1 block">‚öîÔ∏è</span>
                        <span class="font-bold block group-hover:text-emerald-400">Dark Fantasy</span>
                    </button>
                    <button onclick="setGenre('Eldritch Horror')" class="genre-btn group p-4 rounded-2xl bg-slate-900 border-2 border-slate-800 hover:border-emerald-500 transition-all text-left">
                        <span class="text-2xl mb-1 block">üêô</span>
                        <span class="font-bold block group-hover:text-emerald-400">Eldritch</span>
                    </button>
                    <button onclick="setGenre('Samurai Ronin')" class="genre-btn group p-4 rounded-2xl bg-slate-900 border-2 border-slate-800 hover:border-emerald-500 transition-all text-left">
                        <span class="text-2xl mb-1 block">üèÆ</span>
                        <span class="font-bold block group-hover:text-emerald-400">Ronin</span>
                    </button>
                    <button onclick="setGenre('Victorian Gothic')" class="genre-btn group p-4 rounded-2xl bg-slate-900 border-2 border-slate-800 hover:border-emerald-500 transition-all text-left">
                        <span class="text-2xl mb-1 block">ü¶á</span>
                        <span class="font-bold block group-hover:text-emerald-400">Gothic</span>
                    </button>
                    <button onclick="setGenre('Space Western')" class="genre-btn group p-4 rounded-2xl bg-slate-900 border-2 border-slate-800 hover:border-emerald-500 transition-all text-left">
                        <span class="text-2xl mb-1 block">üõ∏</span>
                        <span class="font-bold block group-hover:text-emerald-400">Star-Wilds</span>
                    </button>
                </div>
                <textarea id="custom-plot" placeholder="Or enter a specific prompt..." class="w-full bg-slate-900 border-2 border-slate-800 rounded-2xl p-4 focus:border-emerald-500 outline-none h-20 transition-all text-sm"></textarea>
            </div>

            <button id="main-start-btn" onclick="requestPermissionsAndStart()" class="w-full bg-emerald-500 hover:bg-emerald-400 text-slate-950 font-black py-5 rounded-2xl text-xl shadow-lg transition-all active:scale-95">
                START RUNNING
            </button>
            <p class="text-[10px] text-slate-600 text-center uppercase tracking-widest">Requires GPS & Audio Permissions</p>
        </div>

        <!-- Workout Screen -->
        <div id="workout-screen" class="hidden flex-col flex-1 space-y-4">
            <div class="glass p-5 rounded-[2rem] flex justify-between items-center shadow-xl border-emerald-500/20">
                <div>
                    <div class="text-[10px] font-black text-slate-500 uppercase tracking-widest flex items-center gap-1">
                        <span id="gps-indicator" class="w-2 h-2 rounded-full bg-red-500"></span> Speed m/s
                    </div>
                    <div id="speed-val" class="text-4xl font-black text-white italic">0.0</div>
                </div>
                <div class="text-center">
                    <div id="timer" class="font-mono font-bold text-emerald-400 text-2xl">00:00</div>
                    <div id="next-chapter-timer" class="text-[10px] text-slate-500 font-bold">Waiting...</div>
                </div>
                <div class="text-right">
                    <div class="text-[10px] font-black text-slate-500 uppercase tracking-widest">Chapter</div>
                    <div id="chapter-val" class="text-4xl font-black text-white italic">1</div>
                </div>
            </div>

            <div class="bg-slate-900 border border-slate-800 rounded-2xl p-4 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div id="audio-icon" class="w-10 h-10 rounded-full bg-emerald-500/10 flex items-center justify-center text-emerald-500">
                        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z"></path></svg>
                    </div>
                    <div>
                        <div class="text-[10px] font-black text-slate-500 uppercase">Narrator (Charon)</div>
                        <div id="voice-state" class="text-sm font-bold">Acquiring Story Signal...</div>
                    </div>
                </div>
                <button onclick="toggleAudio()" class="p-3 bg-slate-800 rounded-xl hover:bg-slate-700 transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"></path></svg>
                </button>
            </div>

            <div class="flex-1 bg-white text-slate-900 rounded-[2.5rem] p-8 overflow-y-auto shadow-inner relative border-b-8 border-slate-200">
                <div id="loading-overlay" class="hidden absolute inset-0 bg-white/95 backdrop-blur-md flex flex-col items-center justify-center z-10 p-10 text-center">
                    <div class="spinner mb-6"></div>
                    <h3 class="font-black text-xl uppercase tracking-tighter mb-2 text-slate-900">Generating Narrative</h3>
                    <p id="loading-text" class="text-slate-500 text-sm">Synchronizing ~3000 words to your movement...</p>
                </div>
                <div id="story-container" class="serif text-lg leading-relaxed space-y-6">
                    <h2 id="story-title" class="text-3xl font-black tracking-tight mb-4 sans uppercase italic text-emerald-600">Calibration</h2>
                    <div id="story-content" class="opacity-60">Ready to begin. Please start moving.</div>
                </div>
            </div>
            
            <button onclick="location.reload()" class="py-2 text-slate-600 text-[10px] font-black uppercase tracking-[0.3em] hover:text-white">End Session</button>
        </div>
    </div>

    <script>
        const apiKey = "";
        let currentGenre = "Cyberpunk Fugitive";
        let workoutActive = false;
        let startTime = null;
        let chapterCount = 1;
        let currentSpeed = 0;
        let storyHistory = [];
        let timerInterval = null;
        let chapterSeconds = 0;
        const CHAPTER_TARGET = 600; // 10 minutes
        
        let audioSource;
        let isAudioPlaying = false;
        let watchId = null;

        function setGenre(g) {
            currentGenre = g;
            document.querySelectorAll('.genre-btn').forEach(btn => btn.classList.remove('border-emerald-500', 'bg-slate-800'));
            event.currentTarget.classList.add('border-emerald-500', 'bg-slate-800');
        }

        async function requestPermissionsAndStart() {
            // UI Switch immediately to prevent double-clicks
            const btn = document.getElementById('main-start-btn');
            btn.disabled = true;
            btn.innerText = "INITIALIZING...";

            document.getElementById('setup-screen').classList.add('hidden');
            document.getElementById('workout-screen').classList.remove('hidden');

            // Set a timeout for GPS: If it doesn't respond in 3 seconds, start anyway with 0 speed
            const gpsTimeout = setTimeout(() => {
                if (!workoutActive) {
                    console.log("GPS Timeout: Forcing start...");
                    startTracking();
                }
            }, 3000);

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (pos) => {
                        clearTimeout(gpsTimeout);
                        startTracking();
                    },
                    (err) => {
                        console.error("GPS Denied/Error:", err);
                        clearTimeout(gpsTimeout);
                        startTracking(); // Start anyway, speed will just stay 0
                    },
                    { enableHighAccuracy: true, timeout: 5000 }
                );
            } else {
                startTracking();
            }
        }

        function startTracking() {
            if (workoutActive) return;
            workoutActive = true;
            startTime = Date.now();
            
            // Start Clock and First Chapter
            generateChapter();
            startClock();

            if (navigator.geolocation) {
                document.getElementById('gps-indicator').classList.replace('bg-red-500', 'bg-emerald-500');
                watchId = navigator.geolocation.watchPosition(
                    (pos) => {
                        currentSpeed = pos.coords.speed || 0;
                        document.getElementById('speed-val').innerText = currentSpeed.toFixed(1);
                        document.getElementById('gps-indicator').classList.add('animate-pulse');
                    },
                    (err) => {
                        document.getElementById('gps-indicator').classList.replace('bg-emerald-500', 'bg-yellow-500');
                    },
                    { enableHighAccuracy: true }
                );
            }
        }

        function startClock() {
            timerInterval = setInterval(() => {
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                document.getElementById('timer').innerText = new Date(elapsed * 1000).toISOString().substr(14, 5);

                chapterSeconds++;
                const remaining = Math.max(0, CHAPTER_TARGET - chapterSeconds);
                document.getElementById('next-chapter-timer').innerText = `${Math.floor(remaining/60)}:${(remaining%60).toString().padStart(2, '0')} to next`;

                if (chapterSeconds >= CHAPTER_TARGET) {
                    generateChapter();
                }
            }, 1000);
        }

        async function generateChapter() {
            const loading = document.getElementById('loading-overlay');
            loading.classList.remove('hidden');
            
            const pace = currentSpeed > 3.0 ? "frantic and high-stakes" : currentSpeed > 1.2 ? "steady and rhythmic" : "atmospheric and slow";
            const customPlot = document.getElementById('custom-plot').value;

            const prompt = `
                Write an extremely long and detailed Chapter ${chapterCount} for a ${currentGenre} novel.
                User Prompt: ${customPlot || "No specific prompt, follow genre tropes."}
                Current Pacing: ${pace} (based on ${currentSpeed.toFixed(1)} m/s movement).
                
                REQUIREMENTS:
                1. Length: Attempt to write 3,000 words. Be verbose, descriptive, and immersive.
                2. Previous chapters context: ${storyHistory.slice(-1).join(' ').substring(0, 1000)}
                3. Return ONLY a JSON object: {"title": "Title", "text": "The full long chapter text..."}
            `;

            try {
                const response = await fetchWithRetry(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        generationConfig: { responseMimeType: "application/json" }
                    })
                });

                const data = await response.json();
                const story = JSON.parse(data.candidates[0].content.parts[0].text);
                
                displayAndNarrate(story);
                storyHistory.push(story.text);
                chapterCount++;
                chapterSeconds = 0;
            } catch (err) {
                console.error(err);
                document.getElementById('loading-text').innerText = "Signal lost. Retrying narration...";
            } finally {
                loading.classList.add('hidden');
            }
        }

        function displayAndNarrate(story) {
            document.getElementById('story-title').innerText = story.title;
            const content = document.getElementById('story-content');
            if (chapterCount === 1) content.innerHTML = '';
            
            const div = document.createElement('div');
            div.className = "fade-in";
            div.innerHTML = `<h3 class="font-black text-xs uppercase text-emerald-600 mt-8 mb-2">Segment ${chapterCount}</h3>
                             <h2 class="text-2xl font-black mb-4 uppercase italic text-slate-900">${story.title}</h2>
                             <p class="mb-8 text-slate-800">${story.text.replace(/\n/g, '<br><br>')}</p>`;
            content.prepend(div);
            document.getElementById('chapter-val').innerText = chapterCount;

            // Narrate approximately the first 1500 chars (API limit for single speech turn usually)
            narrateText(`Chapter ${chapterCount}: ${story.title}. ${story.text.substring(0, 1500)}`);
        }

        async function narrateText(text) {
            document.getElementById('voice-state').innerText = "Synthesizing...";
            document.getElementById('audio-icon').classList.add('audio-pulse');

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: text }] }],
                        generationConfig: {
                            responseModalities: ["AUDIO"],
                            speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Charon" } } }
                        }
                    })
                });

                const data = await response.json();
                const pcmData = data.candidates[0].content.parts[0].inlineData.data;
                const sampleRate = parseInt(data.candidates[0].content.parts[0].inlineData.mimeType.split('rate=')[1]) || 24000;

                playAudio(pcmData, sampleRate);
                document.getElementById('voice-state').innerText = "Narrating...";
            } catch (err) {
                document.getElementById('voice-state').innerText = "Narrator Offline";
                document.getElementById('audio-icon').classList.remove('audio-pulse');
            }
        }

        function playAudio(base64Data, sampleRate) {
            const binaryString = atob(base64Data);
            const len = binaryString.length;
            const bytes = new Int16Array(len / 2);
            for (let i = 0; i < len; i += 2) {
                bytes[i / 2] = (binaryString.charCodeAt(i + 1) << 8) | binaryString.charCodeAt(i);
            }
            const wavBuffer = createWavBuffer(bytes.buffer, sampleRate);
            const blob = new Blob([wavBuffer], { type: 'audio/wav' });
            if (audioSource) audioSource.pause();
            audioSource = new Audio(URL.createObjectURL(blob));
            audioSource.play();
            isAudioPlaying = true;
            audioSource.onended = () => {
                document.getElementById('audio-icon').classList.remove('audio-pulse');
                document.getElementById('voice-state').innerText = "Active Sync...";
            };
        }

        function createWavBuffer(pcmBuffer, sampleRate) {
            const numOfChannels = 1;
            const bitsPerSample = 16;
            const header = new ArrayBuffer(44);
            const view = new DataView(header);
            const writeString = (o, s) => { for (let i = 0; i < s.length; i++) view.setUint8(o + i, s.charCodeAt(i)); };
            writeString(0, 'RIFF');
            view.setUint32(4, 36 + pcmBuffer.byteLength, true);
            writeString(8, 'WAVE');
            writeString(12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true);
            view.setUint16(22, numOfChannels, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * numOfChannels * (bitsPerSample / 8), true);
            view.setUint16(32, numOfChannels * (bitsPerSample / 8), true);
            view.setUint16(34, bitsPerSample, true);
            writeString(36, 'data');
            view.setUint32(40, pcmBuffer.byteLength, true);
            const final = new Uint8Array(header.byteLength + pcmBuffer.byteLength);
            final.set(new Uint8Array(header), 0);
            final.set(new Uint8Array(pcmBuffer), header.byteLength);
            return final.buffer;
        }

        function toggleAudio() {
            if (audioSource) {
                if (isAudioPlaying) { audioSource.pause(); isAudioPlaying = false; }
                else { audioSource.play(); isAudioPlaying = true; }
            }
        }

        async function fetchWithRetry(url, options, retries = 5, backoff = 1000) {
            try {
                const res = await fetch(url, options);
                if (!res.ok) throw new Error(res.statusText);
                return res;
            } catch (err) {
                if (retries <= 0) throw err;
                await new Promise(r => setTimeout(r, backoff));
                return fetchWithRetry(url, options, retries - 1, backoff * 2);
            }
        }
    </script>
</body>
</html>
